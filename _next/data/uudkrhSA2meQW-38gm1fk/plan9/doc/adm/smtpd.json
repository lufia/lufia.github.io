{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>Plan 9: メールサーバの設定</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"/plan9/doc/inst/index.html\">インストール</a></li>\n\t<li><a href=\"/plan9/doc/guide/index.html\">システムの使い方</a></li>\n\t<li><a href=\"/plan9/doc/devel/index.html\">プログラミング</a></li>\n\t<li><a href=\"/plan9/doc/adm/index.html\">システム管理</a></li>\n\t<li><a href=\"/plan9/man/index.html\">自作ツール集</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2009年10月20日更新</p>\n\t<section>\n\t\t<h1>メールサーバの設定</h1>\n\t\t<section>\n\t\t\t<h2>各種ファイルの設定</h2>\n\t\t\t<p><strong>/mail/lib</strong>以下のファイルを書き換えます。</p>\n\t\t\t<p class=\"note\">これらはuid=upas gid=upasなので、\n\t\t\tupasグループに所属させておく。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>smtpd.conf</h2>\n\t\t\t<p>smtpdの基本的な設定を書きます。\n\t\t\tこのうち、verifysenderdomは使われてないような。。</p>\n\t\t\t<pre><code>defaultdomain lufia.org\nnorelay on\nverifysenderdom off\nsaveblockedmsg off\nournets xxx.xxx.xxx.xxx/xx\nourdomains wisp.lufia.org, lufia.org</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>rewrite(rewrite.directからコピーしたものを編集)</h2>\n\t\t\t<p>初期状態ではrewriteが存在しないので、\n\t\t\t同じ場所にある<strong>rewrite.direct</strong>をコピーしてそれを書き換えます。\n\t\t\t通常であれば、以下の部分だけ書き換えればいいと思います。</p>\n\t\t\t<pre><code># your local names\n\\l!(.*)   alias   \\1\n\\l\\.lufia.org!(.*)  alias  \\1\nlufia.org!(.*)  alias  \\1</code></pre>\n\t\t\t<p class=\"note\">上記の、\\l\\.lufia.org!(.*)は、\\lがホスト名に置き換えられます。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>names.local</h2>\n\t\t\t<p>これはエイリアスファイルです。\n\t\t\t最初のカラムに別名を書き、次のカラムに転送するユーザ名を書きます。\n\t\t\t無ければとくに変更は不要です。</p>\n\t\t\t<pre><code>postmaster\tglenda\nwebmaster\tglenda</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>remotemail</h2>\n\t\t\t<pre><code>fd=lufia.org</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>/cron/upas/cron</h2>\n\t\t\t<p>mailserverとなっている部分を実際のサーバ名で置き換えます。\n\t\t\tcronの書式はUnixとほとんど同じみたい。\n\t\t\t<strong>cron.daily</strong>みたいなものはありません。</p>\n\t\t\t<pre><code># kick mail retries (replace mailserver with your system)\n0,10,20,30,40,50 * * * *\twisp\t\t/bin/upas/runq -a /mail/queue /mail/lib/remotemail\n\n# clean up after grey list\n47 4 * * *\twisp\trm -rf /mail/grey/tmp/*/*</code></pre>\n\t\t\t<p>テストして正しく送れていれば正解。</p>\n\t\t\t<ul>\n\t\t\t<li>user→外部</li>\n\t\t\t<li>外部→user</li>\n\t\t\t<li>外部→webmaster</li>\n\t\t\t</ul>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>メールの転送</h2>\n\t\t\t<p>転送したいアドレスを<strong>/mail/box/$user/forward</strong>に書きます。\n\t\t\t1行目だけ有効で、複数に転送する場合は空白で区切って書き、\n\t\t\tまた、メールボックスにも残しておく場合は、local!$userを加えます。</p>\n\t\t\t<pre><code>glenda@anonymous.com local!glenda</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>スパム対策</h2>\n\t\t\t<p>Plan 9のsmtpdでは、グレーリスト法が使えます。\n\t\t\tlisten監視下のtcp25に、-gオプションを加えるだけです。\n\t\t\twhitelistなど必要なファイルはインストール時において\n\t\t\tすでに作られているので、特に気にしなくても問題ありません。</p>\n\t\t\t<pre><code class=\"sh\">#!/bin/rc\n#smtp serv net incalldir user\n\nuser=`{cat /dev/user}\nexec upas/smtpd -g -n $3</code></pre>\n\t\t\t<p>あとは、適当なフリーメールなどから送信テストして、\n\t\t\t<strong>/mail/grey/x.x.x.x/y.y.y.y/$user</strong>が作成されていれば完了。\n\t\t\t詳しくは<a href=\"http://p9.nyx.link/spam/\">スパム対策</a>を参考に。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>Outbound Port 25 Blocking</h2>\n\t\t\t<p>tcp!*!25とtcp!*!587でupas/smtpdが動いている状態を作ります。\n\t\t\tまた、SMTP Authが必要なので、smtpdに-aオプションを与えます。</p>\n\t\t\t<pre><code class=\"console\">% cat /cfg/$sysname/service/tcp587\n#!/bin/rc\nuser=`{cat /dev/user}\nexec upas/smtpd -a -g -n $3</code></pre>\n\t\t\t<p>serviceに実行権を付けたファイルを追加すれば、自動的に反映されます。\n\t\t\tPlan 9サーバの再起動は必要ありませんし、起動コマンドも必要ありません。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>送信者確認の流れ(メモ)</h2>\n\t\t\t<ol>\n\t\t\t<li>upas/smtpdが/mail/lib/validatesenderをfork&amp;exec</li>\n\t\t\t<li>validatesenderは、データを送らないモードでupas/smtpを実行</li>\n\t\t\t<li>送信者メールアドレスが無効の場合、upas/smtpがエラーを返す</li>\n\t\t\t</ol>\n\t\t\t<p>upas/smtpの中はだいたいこんな感じ</p>\n\t\t\t<ol>\n\t\t\t<li>ndb/dnsquery $domain mx   =&gt; $hosts</li>\n\t\t\t<li>ndb/dnsquery ^ ($hosts) ^ ip =&gt; 見つからなければ$hostsから削除</li>\n\t\t\t<li>dial /net/tcp! ^ ($hosts) ^ !smtp</li>\n\t\t\t</ol>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>トラブルシューティング</h2>\n\t\t\t<section>\n\t\t\t\t<h3>外部から受信したメールがconnection timed outする</h3>\n\t\t\t\t<p><strong>/sys/log</strong>以下の<strong>smtpd</strong>, <strong>smtp.fail</strong>, <strong>smtpd.mx</strong>あたりに\n\t\t\t\tconnection timed outが記録されている場合。</p>\n\t\t\t\t<p><strong>cpurc</strong>などでndb/dns実行より前にlistenしてしまうと、\n\t\t\t\tsmtpdから見える名前空間に<strong>/net/dns</strong>が存在しないため、\n\t\t\t\tこのようなエラーになることがあります。</p>\n\t\t\t\t<p>この場合、<strong>/cfg/$sysname/cpurc</strong>で、\n\t\t\t\tlistenより先にndb/dnsを動かせばいいです。</p>\n\t\t\t\t<div class=\"note\">\n\t\t\t\t\t<p>当時、困ってた時のメモ。</p>\n\t\t\t\t\t<p>デバッグのために、<strong>/mail/lib/validatesender</strong>から呼ばれている\n\t\t\t\t\tupas/smtpに-dオプションを与えたかったが、\n\t\t\t\t\t配布ファイルのためになるべく書き換えたくなかった。\n\t\t\t\t\tこれはbindすればごまかせる。</p>\n\t\t\t\t\t<p>デバッグオプションを加えると、ログ(<strong>/sys/log/smtpd.mx</strong>)に</p>\n\t\t\t\t\t<blockquote>mxlookup returns nothing</blockquote>\n\t\t\t\t\t<p>というログが出る。</p>\n\t\t\t\t\t<p><strong>/proc/$smtpd/ns</strong>をみると、\n\t\t\t\t\t<strong>/lib/namespace</strong>から実行しているはずの\n\t\t\t\t\tmount -a /srv/dns /netが見当たらない。\n\t\t\t\t\tでもbootesからは<strong>/srv/dns</strong>が見える。\n\t\t\t\t\tパーミッションは666なので問題ない。</p>\n\t\t\t\t</div>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>IPアドレスで送受信できない</h3>\n\t\t\t\t<p>テストのとき、メールの開通確認が終わらないうちに\n\t\t\t\tDNSが新サーバを参照してしまうと困るので、\n\t\t\t\tMXレコードには現行のサーバのIPのままにしておいて\n\t\t\t\tuser@xx.xx.xx.xxのようにIPアドレスで直接テストしていたのですが、\n\t\t\t\t<strong>smtpd.conf</strong>のourdomainsにIPが登録されていなかったために\n\t\t\t\t<strong>/sys/log/smtpd</strong>にBad Forwardエラーが吐かれていました。\n\t\t\t\tこの場合、たぶんforwardにもIP直打ち規則を登録しないといけない。</p>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>/sys/log/cronに、upasの転送エラーが記録される</h3>\n\t\t\t\t<blockquote>upas:  can't call mailserver: cs: can't translate service</blockquote>\n\t\t\t\t<p><strong>/cron/upas/cron</strong>から、\n\t\t\t\tmailserverとなっている部分をメールサーバ名に置き換えます。</p>\n\t\t\t\t<p>smtpdを動かすつもりがないなら、runqの行を消すか、無効にする。\n\t\t\t\tbootesからbind upascron /cron/upas/cronでも大丈夫。</p>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>whitelist.starterに追加しても反映されない</h3>\n\t\t\t\t<p>ソースを読んでも使われていないようなので、\n\t\t\t\t直接whitelistに追加するといいかもしれません。\n\t\t\t\ttip9ugメーリングリストはFreeMLを使っています。\n\t\t\t\tその場合はこのように。</p>\n\t\t\t\t<pre><code class=\"console\">% cat &gt;&gt;/mail/grey/whitelist\n210.157.23.0/24 *.gmo-media.jp\n211.125.95.0/24 *.gmo-media.jp\n^D</code></pre>\n\t\t\t</section>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<section>\n\t\t<h1>関連情報</h1>\n\t\t<ul>\n\t\t<li><a href=\"listen.html\">listenについて</a></li>\n\t\t<li><a href=\"securemail.html\">メール環境の暗号化</a></li>\n\t\t</ul>\n\t</section>\n\t<section>\n\t\t<h1>参考ページ</h1>\n\t\t<ul>\n\t\t<li><a href=\"http://c.p9c.info/plan9/root.html\">Plan9 System Management</a></li>\n\t\t<li><a href=\"http://p9.nyx.link/admin/mail/config.html\">メールに関するファイルの設定</a></li>\n\t\t<li><a href=\"http://p9.nyx.link/spam/\">スパム対策</a></li>\n\t\t<li><a href=\"http://www.drk7.jp/MT/archives/001326.html\">迷惑メール対策OP25Bについてお勉強</a></li>\n\t\t<li><a href=\"http://suzuki.tdiary.net/20080305.html#p01\">OP25Bは迷惑メール行為を防げるのか?</a></li>\n\t\t</ul>\n\t</section>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}