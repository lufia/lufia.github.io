{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>Plan 9: メール環境の暗号化</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"/plan9/doc/inst/index.html\">インストール</a></li>\n\t<li><a href=\"/plan9/doc/guide/index.html\">システムの使い方</a></li>\n\t<li><a href=\"/plan9/doc/devel/index.html\">プログラミング</a></li>\n\t<li><a href=\"/plan9/doc/adm/index.html\">システム管理</a></li>\n\t<li><a href=\"/plan9/man/index.html\">自作ツール集</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2009年10月20日更新</p>\n\t<section>\n\t\t<h1>メール環境の暗号化</h1>\n\t\t<section>\n\t\t\t<h2>サーバ証明書の作成</h2>\n\t\t\t<p>秘密鍵をsecstoreに、証明書を<strong>/sys/lib/tls/cert.pem</strong>に作成します。\n\t\t\t中間証明書があるなら<strong>/sys/lib/tls/chain.pem</strong>に置きましょう。\n\t\t\tauth/rsa2x509の引数は自分の環境にあわせて書き換えます。</p>\n\t\t\t<pre><code class=\"console\"># ramfs\n# cd /tmp\n# auth/rsagen -t 'service=tls owner=*' &gt;key\n# auth/rsa2x509 'C=JP ST=Kanagawa L=Sagamihara O=lufia.org OU=9 CN=lufia' key | auth/pemencode CERTIFICATE &gt;cert</code></pre>\n\t\t\t<p>証明書を自動的にfactotumへ取り込めるように、bootesのsecstoreを作成。\n\t\t\tsecstoreへの登録方法は<a href=\"../guide/secstore.html\">secstoreの使い方</a>を。\n\t\t\tbootesのsecstoreへ1つ以上キーが登録されているなら、\n\t\t\tそれと今回作成したキーを結合しないといけませんが、省略しています。</p>\n\t\t\t<pre><code class=\"console\"># auth/secuser -v bootes\n(password)\n(confirm)\n# cat key &gt;&gt;factotum\n# auth/secstore -p factotum\n# rm key factotum</code></pre>\n\t\t\t<p>bootesは自分でロードしない限りsecstoreを読みにいかないので、\n\t\t\t明示的にsecstoreを読み込むようcpurcを編集。\n\t\t\t具体的には、auth/secstoredの下にauth/secstoreを追加。</p>\n\t\t\t<pre><code class=\"console\"># cat /cfg/$sysname/cpurc\n...\nauth/secstored\nauth/secstore -n -G factotum | read -m &gt;/mnt/factotum/ctl\n...</code></pre>\n\t\t\t<p>また、<a href=\"authinst.html\">初回起動時</a>にsecstoreのパスワードを\n\t\t\t設定していない場合は、auth/wrkeyを使って再設定してください。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>証明書の配置</h2>\n\t\t\t<p>IMAP4, SMTPで使うため、適当な場所に証明書を移動します。\n\t\t\t<strong>cert.pem</strong>の権限は444のほうが安全ですが、管理的にめんどくさいので664。</p>\n\t\t\t<p>ユーザ、グループをsysにするために、\n\t\t\tあらかじめファイルサーバから<strong>cert.pem</strong>を作っておきます。</p>\n\t\t\t<pre><code class=\"console\">fs: create /sys/lib/tls/cert.pem sys sys 664\nfs: newuser sys +bootes</code></pre>\n\t\t\t<pre><code class=\"console\"># cat cert &gt;/sys/lib/tls/cert.pem\n# rm cert\n# unmount /tmp</code></pre>\n\t\t\t<pre><code class=\"console\">fs: newuser sys -bootes</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>IMAP4 over SSL/TLS</h2>\n\t\t\t<p>上記で作成した証明書を使って、IMAP4の通信を暗号化します。\n\t\t\tIMAPSのポートはtcpの993です。\n\t\t\t以下ではserviceを/cfgへ移行した状態で書いています。\n\t\t\t詳細は<a href=\"authinst.html\">認証サーバの構築</a>のサービスの隔離を参照。</p>\n\t\t\t<pre><code class=\"console\">fs: create /cfg/$sysname/service/tcp993 sys sys 775\nfs: newuser sys +bootes</code></pre>\n\t\t\t<p class=\"note\">fsカーネルでは$sysnameをそのまま使うことはできないので、\n\t\t\t実際のホスト名に置き換えてください。</p>\n\t\t\t<pre><code class=\"console\"># cd /cfg/$sysname/service\n# cat &gt;&gt;tcp993\n#!/bin/rc\n\nexec tlssrv -c/sys/lib/tls/cert.pem -limap4d -r`{cat $3/remote} /bin/ip/imap4d -r`{cat $3/remote}&gt;[2]/sys/log/imap4d\n^D</code></pre>\n\t\t\t<p>それから、無くても動いてるようにみえるけど、これも。\n\t\t\tなんだろうこれ。ルータが動いているなら、ポートの開放も忘れずに。\n\t\t\tプロンプトが%の行は、一般ユーザで実行しても問題ありません。</p>\n\t\t\t<pre><code class=\"console\">% upas/fs -f /imaps/wisp\t\t# imapsを設定するサーバへ接続\nupas/fs: opening /imaps/wisp: wisp/imaps:server certificate xxxxxxxxxxxxxxxxxxxxxxxxxxxxx not</code></pre>\n\t\t\t<p>xxxxxxxxxが取得できたら、それをそのまま次に使います。</p>\n\t\t\t<pre><code class=\"console\"># echo 'x509 sha1=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx' &gt;/sys/lib/tls/mail</code></pre>\n\t\t\t<pre><code class=\"console\">fs: newuser sys -bootes</code></pre>\n\t\t\t<p>動作確認が終われば、いらなくなったIMAP4サービスを削除します。\n\t\t\tそのまま残していても困らないだろうとは思いますが、\n\t\t\t有名なメールクライアントはIMAP4Sに対応しているので、\n\t\t\tわざわざ残しておくことはないだろうという気がします。</p>\n\t\t\t<pre><code class=\"console\">fs: remove /cfg/wisp/service/tcp143</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>SMTP over SSL/TLS</h2>\n\t\t\t<p>SMTPの場合、暗号化の方法は2種類あります。</p>\n\t\t\t<dl>\n\t\t\t<div>\n\t\t\t\t<dt>ssmtp</dt>\n\t\t\t\t<dd>TCPポート465</dd>\n\t\t\t\t<dd>通信開始から暗号化されている</dd>\n\t\t\t</div>\n\t\t\t<div>\n\t\t\t\t<dt>smtp+STARTTLS</dt>\n\t\t\t\t<dd>TCPポート25</dd>\n\t\t\t\t<dd>STARTTLSコマンドによって暗号通信が開始される</dd>\n\t\t\t</div>\n\t\t\t</dl>\n\t\t\t<p>設定は、ssmtpはtlssrvによりupas/smtpdプロセスを開始します。\n\t\t\tSTARTTLS版は、upas/smtpdコマンドに-cオプションを使って証明書を与えます。\n\t\t\t後者は暗号化通信が可能というだけで、\n\t\t\tクライアントからSTARTTLSコマンドが発行されない限り暗号化されません。</p>\n\t\t\t<p>今回はtcp587に-cオプションから証明書を与えました。</p>\n\t\t\t<pre><code class=\"sh\"># cat /cfg/wisp/service/tcp587\n#!/bin/rc\n#smtp serv net incalldir user\n\nuser=`{cat /dev/user}\nexec upas/smtpd -ac/sys/lib/tls/cert.pem -g -n $3</code></pre>\n\t\t\t<p>これにより、暗号化通信が開始されると\n\t\t\t<strong>/sys/log/smtpd</strong>にログが記録されるようになります。</p>\n\t\t\t<pre><code>started TLS with [...]</code></pre>\n\t\t\t<p>ついでなので、tcp25にも-c certを追加して終了。\n\t\t\tあまり意味は無いかもしれません。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>トラブルシューティング</h2>\n\t\t\t<section>\n\t\t\t\t<h3>tls reports failed</h3>\n\t\t\t\t<p>bootesの鍵が読み込めていない場合、<strong>/sys/log/imap4d</strong>に\n\t\t\t\tログが記録されます。</p>\n\t\t\t\t<pre><code>tls reports failed: tls: local factotum_rsa_open: no key matches proto=rsa service=tls role=client</code></pre>\n\t\t\t\t<p>この場合は、以下の行をcpurcに加えてください。</p>\n\t\t\t\t<p class=\"sh\">auth/secstore -G factotum</p>\n\t\t\t</section>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<section>\n\t\t<h1>関連情報</h1>\n\t\t<ul>\n\t\t<li><a href=\"smtpd.html\">メールサーバの設定</a></li>\n\t\t<li><a href=\"iphone.html\">iPhoneまとめ</a></li>\n\t\t</ul>\n\t</section>\n\t<section>\n\t\t<h1>参考ページ</h1>\n\t\t<ul>\n\t\t<li><a href=\"https://9p.io/wiki/plan9/Mail_configuration/index.html\">Mail configuration</a></li>\n\t\t<li><a href=\"http://p9.nyx.link/pegasus/man-2.1/cert.html\">証明書</a></li>\n\t\t</ul>\n\t</section>\n\t<section>\n\t\t<h1>参考書</h1>\n\t\t<dl>\n\t\t<div>\n\t\t\t<dt><a href=\"http://www.hyuki.com/cr/\">新版暗号技術入門--秘密の国のアリス</a></dt>\n\t\t\t<dd>暗号全般についての入門書です。<a href=\"http://www.hyuki.com/cr/cr1st.html\">旧版</a>を読みました。</dd>\n\t\t</div>\n\t\t</dl>\n\t</section>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}