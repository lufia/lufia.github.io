{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>Plan 9: ファイルサーバの管理</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"/plan9/doc/inst/index.html\">インストール</a></li>\n\t<li><a href=\"/plan9/doc/guide/index.html\">システムの使い方</a></li>\n\t<li><a href=\"/plan9/doc/devel/index.html\">プログラミング</a></li>\n\t<li><a href=\"/plan9/doc/adm/index.html\">システム管理</a></li>\n\t<li><a href=\"/plan9/man/index.html\">自作ツール集</a></li>\n\t</ul>\n</nav>\n<main>\n\t<h1>ファイルサーバの管理</h1>\n\t<p class=\"revision\">2010年11月12日更新</p>\n\t<p>調べながら書いてます。\n\t未整理のものは<a href=\"/notes/fs.html\">日記のほう</a>にもありますよ。</p>\n\t<section>\n\t\t<h2>filesコマンド</h2>\n\t\t<pre><code>N out of M files used\n  A:     B\nO out of M files used</code></pre>\n\t\t<dl>\n\t\t<div>\n\t\t\t<dt>N</dt>\n\t\t\t<dd>開いているファイル数</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>M</dt>\n\t\t\t<dd>conf.nfile</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>A</dt>\n\t\t\t<dd>コネクションのチャネルナンバー</dd>\n\t\t\t<dd>whoのものと同じ</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>B</dt>\n\t\t\t<dd>Aが開いているファイル数</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>O</dt>\n\t\t\t<dd>Bの合計</dd>\n\t\t</div>\n\t\t</dl>\n\t</section>\n\t<section>\n\t\t<h2>checkコマンド</h2>\n\t\t<dl>\n\t\t<div>\n\t\t\t<dt>nfiles</dt>\n\t\t\t<dd>総ファイル数</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>fsize</dt>\n\t\t\t<dd>sb-&gt;fsize</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>nused</dt>\n\t\t\t<dd>有効ブロック総数</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>ndup</dt>\n\t\t\t<dd>重複したブロック数(amark)..有効ブロック</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>nfree</dt>\n\t\t\t<dd>フリーリスト中の総ブロック数</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>tfree</dt>\n\t\t\t<dd>たぶん、排他ロックなファイルを開いている数</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>nfdup</dt>\n\t\t\t<dd>重複したブロック数(fmark)..フリーリスト</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>nmiss</dt>\n\t\t\t<dd>fsize-fstart-nused-nfree</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>nbad</dt>\n\t\t\t<dd>fstart..fsizeに収まらないブロックアドレス数</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>nqbad</dt>\n\t\t\t<dd>0..sizqbitsに収まらないqid.pathの数</dd>\n\t\t</div>\n\t\t<div>\n\t\t\t<dt>maxq</dt>\n\t\t\t<dd>最大のqid.path</dd>\n\t\t</div>\n\t\t</dl>\n\t</section>\n\t<section>\n\t\t<h2>statw</h2>\n\t\t<pre><code>cwstats main\n\tfilesys main\n\tnio   =      1      1      2\n\t\tmaddr  =        3\n\t\tmsize  =   267049\n\t\tcaddr  =    26708\n\t\tcsize  = 17892283\n\t\tsbaddr =   423710\n\t\tcraddr =   423938   423938\n\t\troaddr =   423941   423941\n\t\tfsize  =   423943   423943  0+ 1%\n\t\tslast  =            423409\n\t\tsnext  =            423942\n\t\twmax   =   423941           0+ 1%\n\t\twsize  = 30524356           1+ 0%\n\t\t17804952 none\n\t\t    60 dirty\n\t\t     0 dump\n\t\t 86888 read\n\t\t   383 write\n\t\t     0 dump1\n\t\tcache  1% full</code></pre>\n\t</section>\n\t<section>\n\t\t<h2>statd</h2>\n\t\t<pre><code>\t0.0 work =      1      1      1 xfrs\n\t    rate =   7334   9050   8725 tBps\n\t1.14 work =      0      0      0 xfrs\n\t    rate =      0      0     88 tBps\n\t1.15 work =      0      0      0 xfrs\n\t    rate =      0      0     48 tBps</code></pre>\n\t</section>\n\t<section>\n\t\t<h2>コンソールのログを取る方法</h2>\n\t\t<p>9fansより。</p>\n\t\t<blockquote>You have to set up console logging yourself on a cpu server, like this:</blockquote>\n\t\t<pre><code class=\"sh\">aux/clog /mnt/consoles/fileserver /sys/log/fileserver &amp;</code></pre>\n\t\t<blockquote>where &quot;fileserver&quot; is the name of your file server.\n\t\tThis assumes you've already got <a href=\"https://9p.io/magic/man2html/4/consolefs\">consolefs(4)</a>configured,\n\t\trunning and mounted, and that\n\t\tyou've got the file server's serial console configured\n\t\tand wired up to a serial port on the cpu server doing the logging.\n\t\tAdd this to your file server's plan9.ini:</blockquote>\n\t\t<pre><code class=\"ini\">console=0 baud=9600</code></pre>\n\t\t<blockquote>It's a bit of work to set up, but very handy.\n\t\tNot only do you get a console log,\n\t\tbut you can access the console from any of your Plan 9 machines with:</blockquote>\n\t\t<pre><code class=\"sh\">C fileserver</code></pre>\n\t\t<section>\n\t\t\t<h3>ファイルサーバ側の設定</h3>\n\t\t\t<p>ファイルサーバの<strong>plan9.ini</strong>に、consoleの設定を追加します。\n\t\t\tこのconsoleは0または1を設定でき、ポート0またはポート1から\n\t\t\tデータを流す、という意味になります。\n\t\t\tbaudはデフォルトで9600なので省略してもいいです。</p>\n\t\t\t<pre><code class=\"ini\">console=0</code></pre>\n\t\t\t<p>ログの受け皿も用意しておきます。</p>\n\t\t\t<pre><code class=\"console\">fs: create /sys/log/fileserver sys sys 666 a</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h3>ログを受け取る側の設定</h3>\n\t\t\t<p>まず、<strong>/lib/ndb/consoledb</strong>を編集します。</p>\n\t\t\t<pre><code class=\"ini\"># see consolefs(4)\ngroup=sys\n\tuid=bootes\nconsole=fileserver dev=/dev/eia0 openondemand=1\n\tgid=sys</code></pre>\n\t\t\t<p>次に<strong>/cfg/$sysname/namespace</strong>。\n\t\t\tシリアルポートを<strong>/dev</strong>にbindします。\n\t\t\tこのファイルはシェルスクリプトのように見えますが、\n\t\t\t限られたコマンドしか受け付けません。\n\t\t\t詳細は<a href=\"https://9p.io/magic/man2html/6/namespace\">namespace(6)</a>。</p>\n\t\t\t<pre><code class=\"sh\">bind -a #t /dev</code></pre>\n\t\t\t<p>最後に、/cfg/$sysname/cpustartあたりに以下を追加。</p>\n\t\t\t<pre><code class=\"sh\">aux/consolefs\naux/clog /mnt/consoles/fileserver /sys/log/fileserver &amp;</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h3>トラブルシューティング</h3>\n\t\t\t<section>\n\t\t\t\t<h4>/dev/eia0等が無い</h4>\n\t\t\t\t<p>カーネルデバイス#tから見えますので、\n\t\t\t\t<strong>/cfg/$sysname/namespace</strong>あたりからbindします。</p>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h4>/cfg/$sysname/namespaceが実行されない</h4>\n\t\t\t\t<p><strong>/cfg/$sysname/namespace</strong>にbindを書いているのに\n\t\t\t\t<strong>/dev/eia0</strong>が見つからない場合。\n\t\t\t\t環境変数sysnameが設定されていないかもしれません。</p>\n\t\t\t\t<p>受信側のplan9.iniに、sysnameを追加します。</p>\n\t\t\t\t<pre><code class=\"ini\">sysname=wisp</code></pre>\n\t\t\t\t<p>または、consolefsを実行する直前にbindするとか。</p>\n\t\t\t\t<div class=\"note\">\n\t\t\t\t\t<p>おそらく、namespaceの後にcpurcとなるので、\n\t\t\t\t\t<strong>/lib/namespace</strong>の最後にある$sysnameを使った行は\n\t\t\t\t\t<strong>plan9.ini</strong>で設定しない限り実行されないのでしょう。。\n\t\t\t\t\t手で設定したものとndb/csの結果が\n\t\t\t\t\t違ったらどうするのだろうというのは置いておいて。</p>\n\t\t\t\t\t<p>と思ってたら、起動順について<a href=\"http://9fans.net/archive/2010/09/346\">9fansで話題に上がりました</a>。</p>\n\t\t\t\t\t<ol>\n\t\t\t\t\t<li>init</li>\n\t\t\t\t\t<li>newns</li>\n\t\t\t\t\t<li>/lib/namespace</li>\n\t\t\t\t\t<li>/cfg/$sysname/namespace(あれば)</li>\n\t\t\t\t\t<li>/rc/bin/cpurc</li>\n\t\t\t\t\t</ol>\n\t\t\t\t\t<p>ここで、$sysnameは設定されていないので読みません。\n\t\t\t\t\tでは何のためにあるのかというと、ブート後、\n\t\t\t\t\t名前空間を変更する場合に使うらしいです。\n\t\t\t\t\tauth/noneとか、listen(8)の<strong>/rc/bin/service</strong>とか。\n\t\t\t\t\tservice.authのほうは、呼び出し元と同じ名前空間みたい。</p>\n\t\t\t\t</div>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h4>データを受信しない</h4>\n\t\t\t\t<p>デバッグなどのため、ふつうのユーザで動かしている場合は、\n\t\t\t\tbootesで試してみてください。\n\t\t\t\tbootes以外ではなぜかうまくいかなかった記憶がやんわりと。</p>\n\t\t\t</section>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<h1>関連情報</h1>\n\t<ul>\n\t<li><a href=\"https://9p.io/magic/man2html/8/fs\">fs(8)</a></li>\n\t<li><a href=\"listen.html\">listenについて</a></li>\n\t</ul>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}