{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>Plan 9: 分散システムのインストール</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"/plan9/doc/inst/index.html\">インストール</a></li>\n\t<li><a href=\"/plan9/doc/guide/index.html\">システムの使い方</a></li>\n\t<li><a href=\"/plan9/doc/devel/index.html\">プログラミング</a></li>\n\t<li><a href=\"/plan9/doc/adm/index.html\">システム管理</a></li>\n\t<li><a href=\"/plan9/man/index.html\">自作ツール集</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2006年10月30日更新</p>\n\t<section>\n\t\t<h1>分散システムのインストール</h1>\n\t\t<p>Plan 9は、各端末や認証サーバでさえも、\n\t\tファイルサーバをルートファイルシステムとして扱えます。\n\t\tちょっと手間ですし、いくつか認証サーバ構築の時と\n\t\t同じ設定をしなければいけませんが、\n\t\t一度やってしまえばディスクレス運用も可能になるのでオススメです。</p>\n\t\t<p>以下、認証サーバとファイルサーバを切り替えながら構築していきます。\n\t\tプロンプトでどちらの作業か分かるように書いていく予定です。</p>\n\t\t<pre><code class=\"console\"># 認証サーバ、ホストオーナー\n#\n\n# 認証サーバ、一般ユーザ\n%\n\n# ファイルサーバ、configモード\nconfig:\n\n# ファイルサーバ、通常モード\nfs:</code></pre>\n\t\t<section>\n\t\t\t<h2>配布ファイルの展開</h2>\n\t\t\t<p>現状、<a href=\"https://9p.io/wiki/plan9/Installing_a_Plan_9_File_Server/index.html\">Installing a Plan 9 File Server</a>にあるwrap/instコマンドがありません。\n\t\t\t9fansで調べると<a href=\"http://9fans.net/archive/2003/03/322\">problems installing the plan9 distribution on fileserver</a>というのがあったので、それに沿って対応。</p>\n\t\t\t<pre><code class=\"console\">% 9fs sources\n% bind /n/sources/plan9 /n/dist\n% srv fairy\n% mount -c /srv/fairy /n/inst\n% cp /n/dist/dist/replica/inst /dist/replica (#instが無かったので作成)\n% chmod +x /dist/replica/inst</code></pre>\n\t\t\t<pre><code class=\"console\">fs: create /dist sys sys 775 d\nfs: create /dist/replica sys sys 775 d\nfs: create /dist/replica/ndist sys sys 775\nfs: create /dist/replica/client sys sys 775 d\nfs: create /dist/replica/client/plan9.db sys sys 664\nfs: create /dist/replica/client/plan9.log sys sys 664 a</code></pre>\n\t\t\t<pre><code class=\"console\">% replica/pull -v /dist/replica/inst</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>cpu/auth: nvramの設定</h2>\n\t\t\t<p>最初の立ち上げ時に聞かれます。\n\t\t\t自分で呼び出す場合はauth/wrkey。</p>\n\t\t\t<pre><code>authid: bootes\nauthdom: mana.lufia.org\nsecstore: xxxxx    # bootesは使わないけど、とりあえず設定\npassword: zzzzz</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ファイルサーバ: cronの準備</h2>\n\t\t\t<pre><code class=\"console\">fs: create /sys/log/cron sys sys 666 a</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ファイルサーバ: secstoreの準備</h2>\n\t\t\t<pre><code class=\"console\">fs: create /adm/secstore adm adm 775 d</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ファイルサーバ: cpu/authで使うファイルの編集</h2>\n\t\t\t<p>cpu/authからファイルサーバをマウントして作業。\n\t\t\tこのあたりは<a href=\"auth.html\">認証サーバのインストール</a>そのまま。</p>\n\t\t\t<pre><code class=\"console\">% 9fs $fileserver</code></pre>\n\t\t\t<ul>\n\t\t\t<li><strong>/rc/bin/termrc</strong>(# 端末がなければどうでもいい)</li>\n\t\t\t<li><strong>/rc/bin/cpurc</strong></li>\n\t\t\t<li><strong>/adm/timezone/local</strong></li>\n\t\t\t<li><strong>/lib/ndb/local</strong></li>\n\t\t\t<li><strong>/lib/ndb/auth</strong></li>\n\t\t\t<li><strong>/rc/bin/^(service service.auth)</strong># cpurcから変更されるので作業はない</li>\n\t\t\t</ul>\n\t\t\t<p>補足として、secstoreを有効にするために、\n\t\t\tcpurcのauth/cronの次行に、auth/secstoredを追加しています。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ファイルサーバ: /bin/cpurcでmvの行を有効にしたなら</h2>\n\t\t\t<pre><code class=\"console\">fs: newuser sys +bootes</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>cpu/auth: plan9.iniの設定</h2>\n\t\t\t<pre><code class=\"console\"># 9fat:\n# cd /n/9fat\n# ramfs\n# ed plan9.ini\n# unmount /n/9fat</code></pre>\n\t\t\t<p><strong>plan9.ini</strong>の必要なところだけ抜粋。</p>\n\t\t\t<pre><code class=\"ini\">bootfile=sdC0!9fat!9pcauth\nbootargs=il -g x.x.x.x ether /net/ether0 y.y.y.y m.m.m.m\nfs=z.z.z.z\nauth=y.y.y.y</code></pre>\n\t\t\t<p class=\"note\">だいたい分かるかと思われますが、いちおう。</p>\n\t\t\t<dl>\n\t\t\t<div>\n\t\t\t\t<dt>x.x.x.x</dt>\n\t\t\t\t<dd>デフォルトゲートウェイ</dd>\n\t\t\t</div>\n\t\t\t<div>\n\t\t\t\t<dt>y.y.y.y</dt>\n\t\t\t\t<dd>いま構築している認証サーバ のIPアドレス</dd>\n\t\t\t</div>\n\t\t\t<div>\n\t\t\t\t<dt>m.m.m.m</dt>\n\t\t\t\t<dd>y.y.y.yのマスク</dd>\n\t\t\t</div>\n\t\t\t<div>\n\t\t\t\t<dt>z.z.z.z</dt>\n\t\t\t\t<dd>ファイルサーバのIPアドレス</dd>\n\t\t\t</div>\n\t\t\t</dl>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>cpu/auth: 再起動</h2>\n\t\t\t<pre><code class=\"console\"># fshalt\n# ^t ^t r</code></pre>\n\t\t\t<p><strong>/rc/bin/service/^(il566 tcp567)</strong>が無くてエラーになるけど、\n\t\t\t目的はサービスの無効化なので無視</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ファイルサーバ: ユーザの作成</h2>\n\t\t\t<pre><code class=\"console\">fs: newuser lufia\nfs: newuser adm +bootes</code></pre>\n\t\t\t<p class=\"note\">bootesをadmに所属させない限り、\n\t\t\tauth/changeuserの結果を保存できません。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>cpu/auth: ユーザの作成</h2>\n\t\t\t<pre><code class=\"console\"># auth/changeuser -p bootes  (# パスワードはnvramと同じにする)\n# auth/changeuser -p lufia</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>cpu/auth: 認証でadmとsysをはじく</h2>\n\t\t\t<pre><code class=\"console\"># cat &gt;&gt;/lib/ndb/auth\nhostid=bootes\n    uid=!sys uid=!adm uid=**\n^D</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>cpu/auth: secstoreの設定</h2>\n\t\t\t<pre><code class=\"console\"># auth/secuser -v lufia\n# echo 'key proto=p9sk1 dom=mana.lufia.org user=lufia !password=xxxx' &gt;/mnt/factotum/ctl  (# 最初のdrawterm接続のため)</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>drawtermで接続テスト</h2>\n\t\t\t<p>secstoreに何も保存されてない場合、\n\t\t\tsecstoreパスワードを入力するとエラーになるので、空にしてログインする。</p>\n\t\t\t<pre><code class=\"console\">% drawterm -a wisp -c wisp\nuser[none]: lufia\npassword: xxxx\nsecstore password:</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>lufiaの環境設定</h2>\n\t\t\t<pre><code class=\"console\">% /sys/lib/newuser</code></pre>\n\t\t\t<p>これで、メールやらなにやらのファイルが作られます。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>lufiaのsecstoreに、drawterm他用のアカウントを保存</h2>\n\t\t\t<p>ファイル名をfactotum以外にすると、次回ログイン時に\n\t\t\tsecsotreがremote file factotum does not existsとエラーを吐くので注意。</p>\n\t\t\t<pre><code class=\"console\">% ramfs\n% cd /tmp\n% echo 'key proto=p9sk1 dom=mana.lufia.org user=lufia !password=xxxx' &gt;factotum\n% auth/secstore -p factotum\n% rm factotum</code></pre>\n\t\t\t<p>ちなみに、すでにアカウントが保存されている場合はこちら</p>\n\t\t\t<pre><code class=\"console\">% ramfs\n% cd /tmp\n% auth/secstore -g factotum\n% echo 'key proto...' &gt;&gt;factotum\n% auth/secstore -p factotum\n% rm factotum</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>cpu/auth: 再起動して動作確認</h2>\n\t\t\t<pre><code class=\"console\"># fshalt</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ファイルサーバ: 後始末</h2>\n\t\t\t<p>drawtermでlufiaがログインできるのを確認してから後始末。\n\t\t\tというのも、(たぶんkeyfsの)停止時に<strong>/adm/keys</strong>に書くため、\n\t\t\t<strong>bootes</strong>に<strong>adm</strong>権が必要だから。</p>\n\t\t\t<pre><code class=\"console\">fs: newuser sys -bootes\nfs: newuser adm -bootes</code></pre>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<section>\n\t\t<h1>関連情報</h1>\n\t\t<ul>\n\t\t<li><a href=\"fs.html\">ファイルサーバのインストール</a></li>\n\t\t</ul>\n\t</section>\n\t<section>\n\t\t<h1>参考ページ</h1>\n\t\t<ul>\n\t\t<li><a href=\"https://9p.io/wiki/plan9/Installing_a_Plan_9_File_Server/index.html\">Installing a Plan 9 File Server</a></li>\n\t\t<li><a href=\"http://p9.nyx.link/install/distrib.html\">分散システムの構築</a></li>\n\t\t</ul>\n\t</section>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}