{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>Plan 9: さくらVPSでPlan 9ネットワークを構成してみた</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"/plan9/doc/inst/index.html\">インストール</a></li>\n\t<li><a href=\"/plan9/doc/guide/index.html\">システムの使い方</a></li>\n\t<li><a href=\"/plan9/doc/devel/index.html\">プログラミング</a></li>\n\t<li><a href=\"/plan9/doc/adm/index.html\">システム管理</a></li>\n\t<li><a href=\"/plan9/man/index.html\">自作ツール集</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2014年5月4日作成</p>\n\t<section>\n\t\t<h1>さくらVPSでPlan 9ネットワークを構成してみた</h1>\n\t\t<p>さくらVPSを使って、フルシステムのPlan 9を作ってみます。\n\t\t最終的に、ファイルサーバ、認証サーバ、CPUサーバの3つ建てて、\n\t\tインターネットからdrawtermでアクセスできるところまでの予定です。</p>\n\t\t<section>\n\t\t\t<h2>方針</h2>\n\t\t\t<p>ざっくりと構成方針です。</p>\n\t\t\t<table>\n\t\t\t<tr><th>ホスト</th><th>カーネル</th><th>ether0</th><th>ether1</th><th>fs</th></tr>\n\t\t\t<tr><td>fs</td><td>pccpuf</td><td>133.242.aaa.aaa</td><td>192.168.1.3</td><td>venti+fossil</td></tr>\n\t\t\t<tr><td>auth</td><td>pcauth</td><td>133.242.bbb.bbb</td><td>192.168.1.7</td><td>fossil</td></tr>\n\t\t\t<tr><td>cpu</td><td>pccpu</td><td>133.242.ccc.ccc</td><td>192.168.1.23</td><td>fossil</td></tr>\n\t\t\t</table>\n\t\t\t<p>authとcpuは、最終的にfsをルートにマウントするので、\n\t\t\tfossilのみで構成しています。</p>\n\t\t\t<p>133.242.ではじまるアドレスは、\n\t\t\tさくらVPSに割り当てられているアドレスを使います。\n\t\t\tネットワークの構成(ipgw, ipmaskなど)は\n\t\t\tVPSコントロールパネルのOSインストール時に見られます。\n\t\t\tそれ以外の方法で知る方法は知りませんので、\n\t\t\t情報を控えておいたほうがいいでしょう。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>準備</h2>\n\t\t\t<p>まずは3台のVPSが必要なので、NICを認識するところまで作業します。\n\t\t\tVPSに単体Plan 9をインストールする部分は、<a href=\"vps.html\">さくらVPSにPlan 9をインストール</a>を読んでください。</p>\n\t\t\t<p>サーバ3台の構築が終わったら、VPSコントロールパネルから、\n\t\t\tローカルネットワークの追加が必要です。\n\t\t\tこれは本契約でなければ使えません。\n\t\t\t本契約になってしばらくすればサーバ一覧に出てきます。\n\t\t\tサーバを停止した状態で、各サーバのNIC1にローカルネットワークを接続します。\n\t\t\tこれでローカルネットワーク経由での通信が可能となります。</p>\n\t\t\t<p>このネットワークは扱いがちょっと面倒です。\n\t\t\tOS再インストールをすると、おそらくISOからブートするより前に、\n\t\t\tローカルネットワーク構成がリセットされてしまいますので\n\t\t\t忘れずに再接続しなければなりません。</p>\n\t\t\t<p>また、インターネット側はNIC0にだけ割り当て可能です。\n\t\t\tPlan 9は/netに内部ネットワークをバインドしたほうが楽なのですが、\n\t\t\t<strong>/lib/namespace</strong>の中でether0(NIC0)を<strong>/net</strong>にバインドしているので\n\t\t\tこれをether1へ切り替える必要があります。\n\t\t\t切り替えたことにより、fsをルートにマウントするサーバは\n\t\t\tかならずNICを2枚以上使って、NIC0をインターネット側に、\n\t\t\tNIC1をローカルネットワークしなければならなくなります。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ファイルサーバ</h2>\n\t\t\t<p>NICを認識したpcfカーネルが動作した直後だと仮定しています。</p>\n\t\t\t<section>\n\t\t\t\t<h3>タイムゾーン構成</h3>\n\t\t\t\t<pre><code class=\"console\">fs% con -l /srv/fscons\nprompt: uname adm +glenda\nprompt: ctl+\\\n&gt;&gt;&gt; q\nfs% cd /adm/timezone\nfs% cp Japan local</code></pre>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>ファイルサーバ用カーネルインストール</h3>\n\t\t\t\t<pre><code class=\"console\">fs% cd /sys/src/9/pc\nfs% mk 'CONF=pccpuf'\nfs% 9fat:\nfs% mv 9pccpuf /n/9fat\nfs% mk 'CONF=pccpuf' nuke</code></pre>\n\t\t\t\t<p>終わったら、<strong>/n/9fat/plan9.ini</strong>を編集。\n\t\t\t\tbootfileエントリは、ブート時にカーネルを選べるように、\n\t\t\t\t変更ではなく追加したほうがいいでしょう。</p>\n\t\t\t\t<pre><code class=\"ini\">bootfile=sdC0!9fat!9pccpuf\nsysname=fs\nauth=192.168.1.7\nconsole=0 b115200 l8 pn s1</code></pre>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>ネットワーク構成</h3>\n\t\t\t\t<p>ローカルネットワーク(NIC1)を<strong>/net</strong>に割り当てるように変更します。</p>\n\t\t\t\t<pre><code class=\"console\">fs% grep /net /lib/namespace\nbind -a #l1 /net  (オリジナルは#lだった)\nbind -a #I /net</code></pre>\n\t\t\t\t<p>NIC0は<strong>/net.alt</strong>へ割り当てますが、サーバによっては\n\t\t\t\tどちらも/netに割り当てたい場合があるので、\n\t\t\t\tサーバ固有構成のほうで設定します。</p>\n\t\t\t\t<pre><code class=\"console\">fs% cat /cfg/fs/namespace\nbind -a #l0 /net.alt\nbind -a #I1 /net.alt</code></pre>\n\t\t\t\t<p><strong>cpurc</strong>で各NICへIPアドレスを設定。\n\t\t\t\t途中の$ipgwは、インストール時に示されたゲートウェイアドレス。</p>\n\t\t\t\t<pre><code class=\"console\">% cat /cfg/fs/cpurc\nip/ipconfig ether /net/ether1 add 192.168.1.3 255.255.255.0\nip/ipconfig -x.alt -g $ipgw ether /net.alt/ether0 add 133.242.aaa.aaa 255.255.254.0\nndb/dns -r\nndb/cs -x.alt -f /lib/ndb/external\nndb/dns -rx.alt -f /lib/ndb/external\naux/timesync -n /net.alt/udp!ntp1.sakura.ad.jp\naux/listen -q -d /cfg/$sysname/service tcp\nsleep 3</code></pre>\n\t\t\t\t<p><strong>/cfg/fs/service</strong>は、<strong>/rc/bin/service</strong>をコピーして\n\t\t\t\t必要なサービスだけ残しています。9pサービスだけあればいいのですが、\n\t\t\t\t何もListenしていないと<strong>/rc/bin/cpurc</strong>でいろいろサービスが起動してしまうので、\n\t\t\t\t今回は割と無難な<strong>tcp9</strong>(discard)だけ立てていますが、\n\t\t\t\tほかに、<strong>/rc/bin/cpurc</strong>を変更してしまってもいいと思います。</p>\n\t\t\t\t<p><strong>/lib/ndb/local</strong>, <strong>/lib/ndb/external</strong>は適切な値で構成しておきます。\n\t\t\t\t<strong>local</strong>のほうはipnetを使ってグループにまとめられますが、\n\t\t\t\tグローバルIPアドレスはばらばらなので、個別に設定しましょう。\n\t\t\t\tだいたいこんな感じ。</p>\n\t\t\t\t<pre><code class=\"ini\">sys=fs dom=fs.domain.dom\n\tether=xxxxxxxx\n\tip=133.242.aaa.aaa\n\tipgw=xxx.xxx.xxx.xxx\n\tipmask=255.255.254.0\n\tdns=133.242.0.3\n\tdns=133.242.0.4</code></pre>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>サーバ構成</h3>\n\t\t\t\t<p>bootesユーザを追加します。</p>\n\t\t\t\t<pre><code class=\"console\">fs% con -l /srv/fscons\nprompt: uname bootes bootes\nprompt: ctl+\\\n&gt;&gt;&gt; q</code></pre>\n\t\t\t\t<p>ファイルサーバを他のサーバからマウントできるように、\n\t\t\t\ttcp564をListenするようにfossilを変更。\n\t\t\t\t<strong>/rc/bin/service/!tcp564</strong>もあるけれど、こっちは使わない。</p>\n\t\t\t\t<pre><code class=\"console\">fs% fossil/conf /dev/sdC0/fossil &gt;/tmp/flproto\nfs% echo 'listen tcp!*!564' &gt;&gt;/tmp/flproto\nfs% fossil/conf -w /dev/sdC0/fossil /flproto\nfs% rm /tmp/flproto</code></pre>\n\t\t\t\t<p>必要なユーザやファイルをあらかじめ作っておいて再起動。</p>\n\t\t\t\t<pre><code class=\"console\">prompt: uname adm +bootes\nprompt: uname adm -glenda\nprompt: uname sys -glenda\nprompt: uname adm -sys (これは好み)\nprompt: fsys main\nprompt: create /active/sys/log/cron sys sys a666\nprompt: create /active/adm/secstore adm adm d775</code></pre>\n\t\t\t\t<pre><code class=\"console\">fs% fshalt\n(停止したらコントロールパネルから再起動)</code></pre>\n\t\t\t\t<p>理由は分かりませんが、Plan 9でctl+t, ctl+t, rとリブートすると\n\t\t\t\tVPSの状態が「不明」になって、強制停止も起動もできなくなります。\n\t\t\t\tこうなると、不明から脱するには再インストールを行って\n\t\t\t\tむりやり「起動」状態に戻す必要があります。\n\t\t\t\t(「起動」になればいいので、再インストールを最後まで行う必要はありません)</p>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>再起動後</h3>\n\t\t\t\t<p><strong>9pccpuf</strong>カーネルで起動したら、\n\t\t\t\t最初にbootesの情報をきかれるので入力します。\n\t\t\t\t残りのサーバにも同じものを設定する必要があります。</p>\n\t\t\t\t<p>終わったら、<strong>/sys/log</strong>にエラーが出ていないか、\n\t\t\t\t必要なサービスだけになっているかを確認して終わり。</p>\n\t\t\t\t<pre><code class=\"console\">fs# netstat | grep Listen\nfs# netstat /net.alt | grep Listen</code></pre>\n\t\t\t</section>\n\t\t</section>\n\t</section>\n</main>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}