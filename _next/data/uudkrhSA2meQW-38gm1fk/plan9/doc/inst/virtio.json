{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>Plan 9: VirtIOを使う</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"/plan9/doc/inst/index.html\">インストール</a></li>\n\t<li><a href=\"/plan9/doc/guide/index.html\">システムの使い方</a></li>\n\t<li><a href=\"/plan9/doc/devel/index.html\">プログラミング</a></li>\n\t<li><a href=\"/plan9/doc/adm/index.html\">システム管理</a></li>\n\t<li><a href=\"/plan9/man/index.html\">自作ツール集</a></li>\n\t</ul>\n</nav>\n<main>\n\t<h1>VirtIOを使う</h1>\n\t<section>\n\t\t<h2>VirtIOのインストール</h2>\n\t\t<section>\n\t\t\t<h3>パッチを当てる</h3>\n\t\t\t<p>VirtIOはPlan 9の標準ディストリビューションには含まれないので、\n\t\t\t9legacyのパッチを当てます。</p>\n\t\t\t<pre><code class=\"console\">% cd /\n% hget http://www.9legacy.org/9legacy/patch/pc-sdvirtio.diff | ape/patch -p1\n% hget http://www.9legacy.org/9legacy/patch/pc-ethervirtio.diff | ape/patch -p1</code></pre>\n\t\t\t<p>自前のツールですが、9legacy/installを使うと便利です。</p>\n\t\t\t<pre><code class=\"console\">% 9legacy/init\n% 9legacy/installall &lt;{9legacy/stable}\n% 9legacy/apply</code></pre>\n\t\t\t<p>次に、カーネルコンフィグへVirtIOドライバを追加します。\n\t\t\tここで不要なドライバを削除しておいてもいいかもしれません。</p>\n\t\t\t<pre><code class=\"console\">% cd /sys/src/9/pc\n% ed pccpuf</code></pre>\n\t\t\t<p>カーネルコンフィグは、たとえば以下のように。</p>\n\t\t\t<pre><code>link\n    ethervirtio    pci\n\nmisc\n    sdvirtio        pci sdscsi</code></pre>\n\t\t\t<p>また、9loadにも足しておかないとデバイスが見つからなくて\n\t\t\tブートできなくなるので、9loadのコンフィグにもsdvirtioを足します。</p>\n\t\t\t<pre><code class=\"console\">% cd /sys/src/9/pcboot\n% ed load</code></pre>\n\t\t\t<p>loadはカーネルをロードするだけなので、sdvirtioがあれば十分だと思います。\n\t\t\tもし9bootも必要なら、そっちにはethervirtioを追加しましょう。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h3>インストール</h3>\n\t\t\t<p>カーネルのビルドを行います。</p>\n\t\t\t<pre><code class=\"console\">% cd /sys/src/9/pc\n% mk 'CONF=pccpuf'</code></pre>\n\t\t\t<p>次にローダのビルド。</p>\n\t\t\t<pre><code class=\"console\">% cd /sys/src/9/pcboot\n% ed load\n% mk 9load</code></pre>\n\t\t\t<p>9fat領域へカーネルとローダをコピーしたらインストール完了です。</p>\n\t\t\t<pre><code class=\"console\"># 9fat:\n# cp 9load /n/9fat/9load (きちんとdisk/format使ったほうが良いかも)\n# cp 9pccpuf /n/9fat/9pccpuf</code></pre>\n\t\t</section>\n\t</section>\n\t<section>\n\t\t<h2>デバイス名を変更</h2>\n\t\t<p>VirtIOを有効にすると、デバイス名が<strong>sdC0</strong>から<strong>sdF0</strong>に変わります。\n\t\tそのため、fossil等、デバイス名の変更が必要です。\n\t\t必ず、新しいカーネルでブートする前に実施しなくてはいけません。</p>\n\t\t<p>まず<strong>plan9.ini</strong>を変更。</p>\n\t\t<pre><code class=\"ini\">bootfile=sdF0!9fat!9pccpuf\nbootargs=local!#S/sdF0/fossil\nbootdisk=local!#S/sdF0/fossil</code></pre>\n\t\t<p>fossilのconfにも設定が入っているので修正します。</p>\n\t\t<pre><code class=\"console\"># fossil/conf /dev/sdC0/fossil &gt;fossil.conf\n# ed fossil.conf\nfsys main config /dev/sdF0/fossil\n# fossil/conf -w /dev/sdC0/fossil fossil.conf</code></pre>\n\t\t<p>ventiを使っている場合は、ventiの設定も修正が必要です。</p>\n\t\t<pre><code class=\"console\">% venti/conf /dev/sdC0/arenas &gt;venti.conf\n% ed venti.conf\nisect /dev/sdF0/isect\narenas /dev/sdF0/arenas\n% venti/conf -w /dev/sdC0/arenas &lt;venti.conf</code></pre>\n\t\t<p>このあと仮想マシンのVirtIOを有効にするのでシャットダウンさせます。</p>\n\t</section>\n\t<section>\n\t\t<h2>仮想マシンのVirtIO</h2>\n\t\t<p>シャットダウンし終わったら、カスタムOSインストールを実行するか、\n\t\tISOイメージインストールでVirtIOを有効にしてインストールを実行します。\n\t\tこのとき、あくまで目的はVirtIOを有効にするだけなので、\n\t\tイメージから起動したらすぐに再起動させてしまってください。\n\t\t(VirtIO有効無効の切り替えはOSインストール時しかできないので)</p>\n\t\t<p>これで正しく設定できていればVirtIOドライバを使ったカーネルが動作します。</p>\n\t</section>\n\t<section>\n\t\t<h2>終わりに</h2>\n\t\t<p>さくらVPSは、OS再インストールをすると\n\t\t仮想マシンのスイッチ設定がリセットされるので、\n\t\tファイルサーバから/を得ている場合はスイッチの設定も忘れずに。</p>\n\t</section>\n\t<section>\n\t\t<h2>困ったときの対応</h2>\n\t\t<p>少しはまったことをまとめました。</p>\n\t\t<section>\n\t\t\t<h3>ブートしなくなった場合</h3>\n\t\t\t<p>Plan 9のISOイメージからブートさせると、\n\t\t\tインストールするかCDからブートするかを選べるので、\n\t\t\tCDからブートして必要なリカバリを行いましょう。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h3>ISOイメージのアップロードができない場合</h3>\n\t\t\t<p>ISOをアップロードしようとしたら、\n\t\t\t以下のようなエラーで失敗するときがあります。</p>\n\t\t\t<pre><code class=\"console\">sftp&gt; put plan9.iso\nUploading plan9.iso to /iso/plan9.iso\nremote open(&quot;/iso/plan9.iso&quot;): Failure</code></pre>\n\t\t\t<p><a href=\"http://randomsoft.com/node/438\">さくらの VPS で ISO イメージがアップできない</a>によると、ISOアカウントを削除したうえで、\n\t\t\t仮想マシンを起動・停止するといいそうです。</p>\n\t\t\t<p>それでもだめな場合は、起動・停止のかわりに\n\t\t\tカスタムOSインストール・停止させると解消します。</p>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<h1>関連情報</h1>\n\t<ul>\n\t<li><a href=\"9k.html\">64bit環境(9kカーネル)を構築する</a></li>\n\t</ul>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}