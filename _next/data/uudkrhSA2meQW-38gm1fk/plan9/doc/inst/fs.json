{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>Plan 9: ファイルサーバのインストール</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"/plan9/doc/inst/index.html\">インストール</a></li>\n\t<li><a href=\"/plan9/doc/guide/index.html\">システムの使い方</a></li>\n\t<li><a href=\"/plan9/doc/devel/index.html\">プログラミング</a></li>\n\t<li><a href=\"/plan9/doc/adm/index.html\">システム管理</a></li>\n\t<li><a href=\"/plan9/man/index.html\">自作ツール集</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2011年7月23日更新</p>\n\t<section>\n\t\t<h1>ファイルサーバのインストール</h1>\n\t\t<section>\n\t\t\t<h2>はじめに</h2>\n\t\t\t<p>これは、ファイルサーバ専用のカーネル構築記録です。\n\t\t\tdumpfs、ken fs、fs64等いろいろな呼び方がありますが、\n\t\t\tだいたい同じものを指しています。以下fsカーネルと呼びます。</p>\n\t\t\t<p>現在、fsカーネルはサポート外となり配布物から外されています。\n\t\t\t配布物から外れる前から使っているのでここに書いていますが、\n\t\t\t今から構築するには、あまりおすすめしません。\n\t\t\tATAディスク周りにはバグがありますし、情報も少ないので。</p>\n\t\t\t<p>それでも、高い安定度は魅力的だなあ、と思います。\n\t\t\tフルSCSI化してからというもの、\t\n\t\t\tハードウェアトラブル以外で落ちたことがないですよ。</p>\n\t\t\t<p>なにはともあれ認証サーバが1台必要になります。\n\t\t\t注意する点としては、必ず<a href=\"il.html\">ilを組み込んで</a>ください。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ソースコードの取得</h2>\n\t\t\t<p>現在、fsカーネルはサポート外になってしまったので、\n\t\t\t別途取得してこなければいけません。\n\t\t\tソースコード一式は<strong>/n/sources/extra/fs</strong>にあるので\n\t\t\t普通にコピーしてもいいのですが、せっかくなのでreplica用の設定をします。\n\t\t\t以下の内容を<strong>$home/fs/dist/replica/inst</strong>として保存します。</p>\n\t\t\t<pre><code class=\"console\">% cat $home/fs/dist/replica/inst\n#!/bin/rc\n\n# ken fs template.\n# Assumes that distribution should be installed\n# to /n/inst.\n\ns=/n/sources/extra/fs/replica\nserverroot=/n/sources/extra/fs/fs\nserverlog=$s/fs.log\nserverdb=$s/fs.db\nserverproto=$s/fs.proto\nfn servermount { status='' } \nfn serverupdate { status='' }\n\nfn clientmount { status='' }\nc=/n/inst/dist/replica\nclientroot=/n/inst\nclientproto=$c/fs.proto\nclientdb=$c/client/fs.db\nclientexclude=(dist/replica/client)\nclientlog=$c/client/fs.log\n\napplyopt=(-t -u -T$c/client/fs.time)</code></pre>\n\t\t\t<p>次に、<strong>$home/fs/dist/replica/client/fs.db</strong>(空でいい)を作成して、展開。\n\t\t\tここではとりあえず、展開先を<strong>$home/fs</strong>とします。\n\t\t\t展開先を変えたい場合は、2行目のbindを変更してください。</p>\n\t\t\t<pre><code class=\"console\">% chmod +x $home/fs/dist/replica/inst\n% echo -n &gt;$home/fs/dist/replica/client/fs.db\n% 9fs sources\n% bind -c $home/fs /n/inst\n% replica/pull -v /n/inst/dist/replica/inst</code></pre>\n\t\t\t<p>しばらく待てば、<strong>$home/fs</strong>以下は次のようになります。</p>\n\t\t\t<pre><code class=\"console\">% lc $home/fs\n9netics32.16k dev           emelie        ip            pc\n9netics64.8k  dist          fs            mkfile        port\ncholine       doc           fs64          patch         run</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>時計合わせ</h2>\n\t\t\t<p>fsカーネルでは、timezoneを変更するには\n\t\t\tソースを書き換えなければできません。\n\t\t\t詳しくは<a href=\"../adm/timezone.html\">時計合わせ</a>を参照してください。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>コンパイル</h2>\n\t\t\t<p>以上で準備が整いましたので、コンパイルします。</p>\n\t\t\t<pre><code class=\"console\">% cd $home/fs/fs64\n% mk</code></pre>\n\t\t\t<p>これで、<strong>9fsfs64</strong>というカーネルができますので、\n\t\t\t続けて<strong>plan9.ini</strong>を用意します。\n\t\t\tetherの項は手持ちのカードに合わせてください。\n\t\t\tソースコードの<strong>pc/etherif.c</strong>にネットワークカードの一覧が、\n\t\t\t<strong>pc/scsi.c</strong>にSCSIカードの一覧があります。</p>\n\t\t\t<pre><code class=\"console\">% cat plan9.ini\nether0=type=rtl8139\nbootfile=fd!0!9fsfs64\nnvr=fd!0!plan9.nvr</code></pre>\n\t\t\t<p>または、9loadがカーネルを見つけられない場合、\n\t\t\tbootfileエントリを以下のようにすると解決するかもしれません。\n\t\t\tそれでもnvrエントリは古い書き方をします。</p>\n\t\t\t<pre><code class=\"ini\">bootfile=fd0!dos!9fsfs64</code></pre>\n\t\t\t<p>用意ができたら、カーネルとまとめてフロッピーに書き込みます。\n\t\t\t単純にファイルをコピーしただけでは、\n\t\t\tロードできない配置になってしまったりしますので、\n\t\t\tpc/bootfloppyを使います。</p>\n\t\t\t<pre><code class=\"console\"># 端末から直接書き込む場合\n% pc/bootfloppy /dev/fd0disk plan9.ini 9fsfs64\n\n# フロッピーイメージを作成する場合\n% pc/bootfloppy floppy.img plan9.ini 9fsfs64</code></pre>\n\t\t\t<p>完成したらそれを使ってブートします。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ファイルサーバの構成</h2>\n\t\t\t<p>サーバの設定を行います。\n\t\t\tブート中にキーを押してconfigモードに入り、設定します。</p>\n\t\t\t<pre><code class=\"console\">config: config w0\nconfig: service fs\nconfig: filsys main cw0f{w14w15}\nconfig: filsys dump o\nconfig: ipsntp 192.168.1.1\nconfig: ip 192.168.1.23\nconfig: ipgw 192.168.1.1\nconfig: ipmask 255.255.255.0\nconfig: ream main\nconfig: end</code></pre>\n\t\t\t<p>各行についてですが、serviceコマンドでホスト名を設定、\n\t\t\tfilsysコマンドでファイルシステムの名前付けと\n\t\t\tディスクの割り当てを行っています。\n\t\t\t上記の例では、mainファイルシステムとして、SCSIディスク0をキャッシュ、\n\t\t\tSCSIディスク14と15をミラーリングして擬似WORMとしています。</p>\n\t\t\t<p class=\"note\">fsカーネルでは、ルールさえ覚えてしまえば、\n\t\t\t簡単なコマンドでディスクを単純に連結したり、\n\t\t\tストライピングしたりもできます。\n\t\t\t詳細は<a href=\"https://9p.io/magic/man2html/8/fsconfig\">fsconfig(8)</a>を読んでください。</p>\n\t\t\t<p>ipまわりは、そのままの意味。\n\t\t\tネットワークカードが複数ある場合、1枚目はip0, ipgw0, ipmask0、\n\t\t\t2枚目はip1, ipgw1, ipmask1のように見えます。</p>\n\t\t\t<p>最後に、reamコマンドでファイルシステムを初期化です。\n\t\t\tこのコマンドは、configモードを終えてから初期化を開始します。</p>\n\t\t\t<p>endコマンドでconfigモードを終えて通常運用モードに進みます。\n\t\t\treamコマンドを発行した場合は、ここで初期化を行います。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ホストオーナーの設定とユーザの初期化</h2>\n\t\t\t<p>しばらく待つとファイルサーバのプロンプトが表示されます。\n\t\t\tそこで、ユーザの初期化とファイルサーバパスワードの設定をします。\n\t\t\tpasswdコマンドでは、認証ID、認証ドメイン、パスワードを聞かれますので、\n\t\t\t認証IDをbootes、認証ドメインとパスワードを\n\t\t\t認証サーバのbootesと同じ値に設定します。</p>\n\t\t\t<pre><code class=\"console\">fs: users default\nfs: passwd</code></pre>\n\t\t\t<p>このままではユーザ情報さえ保存できませんので、\n\t\t\t続けて、/adm/usersのほか、必須のファイルを作成します。</p>\n\t\t\t<pre><code class=\"console\">fs: create /adm -1 -1 775 d\nfs: create /adm/users -1 -1 664\nfs: create /usr 10000 10000 775 d</code></pre>\n\t\t\t<p class=\"note\">上記の、-1はadm、10000はsysと同等です。\n\t\t\t名前も使えたはずですが、ここではIDを使いました。</p>\n\t\t\t<p>準備ができたので、<strong>/adm/users</strong>に保存します。\n\t\t\t保存コマンドは特に無く、ユーザの追加や削除が行われたタイミングで\n\t\t\t書き込みにいきますので、適当なユーザを追加してください。</p>\n\t\t\t<pre><code class=\"console\">fs: newuser lufia</code></pre>\n\t\t\t<p class=\"note\">users defaultコマンドは、メモリに初期テーブルがロードされるだけです。\n\t\t\t書き込みは行いません。</p>\n\t\t\t<p>ファイルサーバをマウントするだけならこれで完了です。\n\t\t\tクライアントのほうで以下のように使います。</p>\n\t\t\t<pre><code class=\"console\">% ramfs\n% echo 'key proto=p9sk1 dom=mana.lufia.org user=glenda !password=xxxxx' &gt;/tmp/factotum\n% auth/secstore -p /tmp/factotum</code></pre>\n\t\t\t<p>あとは、<strong>$home/lib/profile</strong>などから9fsを使ってマウント。</p>\n\t\t\t<pre><code class=\"console\">% 9fs fs</code></pre>\n\t\t\t<p>これで<strong>/n/fs</strong>にマウントされます。\n\t\t\tfsをルートファイルシステムとする場合は関連情報を参照。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>トラブルシューティング</h2>\n\t\t\t<section>\n\t\t\t\t<h3>認証サーバからファイルサーバをマウントできない</h3>\n\t\t\t\t<p>ファイルサーバのpasswdコマンドで設定するIDは、\n\t\t\t\t認証サーバと同じにしないといけないみたいです。\n\t\t\t\t通常、どちらもbootesにしておくのが無難です。\n\t\t\t\tもちろんパスワードも同じにします。</p>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>VMwareでNICを認識しない</h3>\n\t\t\t\t<p>配布されているものは対応していません。\n\t\t\t\tパッチを当てたものが<a href=\"../../src/etherigbe.c\">etherigbe.c</a>にありますので差し替えて使ってください。</p>\n\t\t\t</section>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<section>\n\t\t<h1>関連情報</h1>\n\t\t<ul>\n\t\t<li><a href=\"sizka.html\">Sizka BASICへのインストール</a></li>\n\t\t<li><a href=\"dist.html\">分散システムのインストール</a></li>\n\t\t<li><a href=\"../../../notes/2011/0723.html\">VMware Playerにファイルサーバをインストール</a></li>\n\t\t</ul>\n\t</section>\n\t<section>\n\t\t<h1>参考ページ</h1>\n\t\t<ul>\n\t\t<li><a href=\"https://9p.io/wiki/plan9/Installing_a_Plan_9_File_Server/index.html\">Installing a Plan 9 File Server</a></li>\n\t\t</ul>\n\t</section>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}