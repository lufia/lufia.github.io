{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>Plan 9: カーネルにilを組み込む</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"/plan9/doc/inst/index.html\">インストール</a></li>\n\t<li><a href=\"/plan9/doc/guide/index.html\">システムの使い方</a></li>\n\t<li><a href=\"/plan9/doc/devel/index.html\">プログラミング</a></li>\n\t<li><a href=\"/plan9/doc/adm/index.html\">システム管理</a></li>\n\t<li><a href=\"/plan9/man/index.html\">自作ツール集</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2011年7月1日更新</p>\n\t<section>\n\t\t<h1>カーネルにilを組み込む</h1>\n\t\t<p>カーネルからilが外されてしまったので、dumpfsを利用する場合には、\n\t\t自分でilを組み込まなければ動きません。\n\t\t具体的には、まず、<strong>il.c</strong>を<strong>/sys/src/9/ip/il.c</strong>にコピーします。</p>\n\t\t<div class=\"note\">\n\t\t\t<p><a href=\"../../src/il.c\">IPv6対応のIL</a>を書いてみました。\n\t\t\tざっと使い方を書くと、</p>\n\t\t\t<pre><code class=\"sh\">aux/listen1 il!*!9001 /bin/exportfs -r $home</code></pre>\n\t\t\t<p>別のウィンドウで</p>\n\t\t\t<pre><code class=\"sh\">9fs il!::1!9001 /n/remote</code></pre>\n\t\t</div>\n\t\t<pre><code class=\"console\">% 9fs sources\n% cp /n/sources/extra/il.c /sys/src/9/ip/il.c</code></pre>\n\t\t<p>次に、<strong>/sys/src/9/ip/ip.h</strong>のLogtcp付近を以下のように変更します。</p>\n\t\t<pre><code class=\"c\">Logtcp=\t\t1&lt;&lt;2,\nLogfs=\t\t1&lt;&lt;3,\nLogil=\t\t1&lt;&lt;4,\t// 追加\nLogicmp=\t1&lt;&lt;5,\nLogudp=\t\t1&lt;&lt;6,\nLogcompress=\t1&lt;&lt;7,\nLogilmsg=\t1&lt;&lt;8,\t// 追加\nLoggre=\t\t1&lt;&lt;9,</code></pre>\n\t\t<div class=\"note\">\n\t\t\t<p>これに加えて、<strong>ip/netlog.c</strong>にも追加。無くても動きますが。</p>\n\t\t\t<pre><code class=\"c\">static Netlogflag flags[] =\n{\n\t{ &quot;ppp&quot;,\tLogppp, },\n\t{ &quot;ip&quot;,\t\tLogip, },\n\t{ &quot;fs&quot;,\t\tLogfs, },\n\t{ &quot;il&quot;,\t\t\tLogil, },\t\t// 追加\n\t{ &quot;tcp&quot;,\tLogtcp, },\n\t{ &quot;icmp&quot;,\tLogicmp, },\n\t{ &quot;udp&quot;,\tLogudp, },\n\t{ &quot;compress&quot;,\tLogcompress, },\n\t{ &quot;ilmsg&quot;,\t\tLogil|Logilmsg, },\t// 追加\n\t{ &quot;gre&quot;,\tLoggre, },\n\t{ &quot;tcpwin&quot;,\tLogtcp|Logtcpwin, },\n\t{ &quot;tcprxmt&quot;,\tLogtcp|Logtcprxmt, },\n\t{ &quot;udpmsg&quot;,\tLogudp|Logudpmsg, },\n\t{ &quot;ipmsg&quot;,\tLogip|Logipmsg, },\n\t{ &quot;esp&quot;,\tLogesp, },\n\t{ nil,\t\t0, },\n};</code></pre>\n\t\t</div>\n\t\t<p>2010年の途中まではここまでで動きましたが、\n\t\t2011年5月に確認してみると、いくつかコンパイルエラーが出ました。\n\t\tそこで、若干むりやりですが、boot以下の<strong>boot.h</strong>と<strong>bootip.c</strong>に追加します。</p>\n\t\t<section>\n\t\t\t<h3>boot/boot.h</h3>\n\t\t\t<pre><code class=\"c\">extern void\tconfigil(Method*);\nextern int\tconnectil(void);</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h3>boot/bootip.c</h3>\n\t\t\t<pre><code class=\"c\">void\nconfigil(Method*)\n{\n\tconfigip(bargc, bargv, 1);\n\tsetauthaddr(&quot;il&quot;, 566);\n}\n\nint\nconnectil(void)\n{\n\tint fd;\n\tchar buf[64];\n\n\tsnprint(buf, sizeof buf, &quot;il!%I!17008&quot;, fsip);\n\tfd = dial(buf, 0, 0, 0);\n\tif(fd &lt; 0)\n\t\twerrstr(&quot;dial %s: %r&quot;, buf);\n\treturn fd;\n}</code></pre>\n\t\t</section>\n\t\t<p>最後に、confファイルに、ilのエントリが必要になります。\n\t\tいま使っているpcauthの場合はこんな感じ。</p>\n\t\t<pre><code>dev\n\troot\n\tcons\n\tarch\n\tpnp\t\tpci\n\tenv\n\tpipe\n\tproc\n\tmnt\n\tsrv\n\tdup\n\trtc\n\tssl\n\ttls\n\tcap\n\tkprof\n\tfs\n\n\tether\t\tnetif\n\tip\t\tarp chandial ip ipv6 ipaux iproute netlog nullmedium pktmedium ptclbsum386 inferno\n\n\tdraw\t\tscreen vga vgax\n\tmouse\t\tmouse\n\tvga\n\n\tsd\n\tfloppy\t\tdma\n\n\tuart\n\nlink\n\tapm\t\tapmjump\n\tether8139\tpci\n\tether8169\tpci ethermii\n\tethermedium\n\tnetdevmedium\n\tloopbackmedium\n\nmisc\n\trealmode\n\tarchmp\t\tmp apic\n\tmtrr\n\tsdata\t\tpci sdscsi\n\n\tuarti8250\n\tuartpci\n\n\tvgamach64xx\t+cur\n\tvgas3 \t\t+cur vgasavage\n\nip\n\til\n\ttcp\n\tudp\n\tipifc\n\ticmp\n\ticmp6\n\tgre\n\tipmux\n\tesp\n\nport\n\tint cpuserver = 1;\n\nboot cpu boot #S/sdC0/\n\ttcp\n\til\n\tlocal\n\nbootdir\n\tbootpcauth.out boot\n\t/386/bin/ip/ipconfig\n\t/386/bin/auth/factotum\n\t/386/bin/fossil/fossil\n\t/386/bin/venti/venti\n#\t/386/bin/disk/kfs</code></pre>\n\t\t<p>以前とくらべて、</p>\n\t\t<pre><code>misc\n\tarch\t\tmp apic\n\tmtrr</code></pre>\n\t\t<p>これらがなければリンク時にエラーがでますね。</p>\n\t</section>\n</main>\n<aside>\n\t<section>\n\t\t<h1>関連情報</h1>\n\t\t<ul>\n\t\t<li><a href=\"fs.html\">ファイルサーバのインストール</a></li>\n\t\t<li><a href=\"../guide/il.html\">ILプロトコル</a></li>\n\t\t<li><a href=\"../../../notes/2011/0618.html\">il.cを読む</a></li>\n\t\t</ul>\n\t</section>\n\t<section>\n\t\t<h1>参考ページ</h1>\n\t\t<ul>\n\t\t<li><a href=\"http://9fans.net/archive/2007/10/34\">9fans: Kernel and IL</a></li>\n\t\t<li><a href=\"http://9fans.net/archive/2007/10/35\">Re: 9fans: Kernel and IL</a></li>\n\t\t<li><a href=\"http://www.slideshare.net/oraccha/il-4020522\">IL: 失われたプロトコル</a></li>\n\t\t</ul>\n\t</section>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}