{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>orange/note: AmaTunesツール</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/notes/index.html\">orange/note</a></li>\n\t<li><a href=\"/notes/pc.html\">PC関連</a></li>\n\t<li><a href=\"/notes/web.html\">web製作</a></li>\n\t<li><a href=\"/notes/sec.html\">セキュリティ</a></li>\n\t<li><a href=\"/notes/hobby.html\">本・ゲーム</a></li>\n\t<li><a href=\"/notes/junk.html\">ジャンク</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2009年10月31日作成</p>\n\t<section>\n\t\t<h1>AmaTunesツール</h1>\n\t\t<p>1行に1つISBNを記述したファイルから、<a href=\"http://blogger.splhack.org/2007/10/amatunes.html\">AmaTunes</a>に\n\t\t取り込むためのプログラムです。</p>\n\t\t<p>これはずいぶん前に<a href=\"http://journal.mycom.co.jp/news/2008/09/19/021/index.html\">Books for Mac OS X</a>の\n\t\tデータを移行させようとして作ったのですが、\n\t\tAmaTunes自体、数回しか使いませんでしたので、\n\t\tなんらかのバグが残っているのではないかと思います。</p>\n\t\t<pre><code>COCOA_APP_RESOURCES_DIR = File.dirname(File.expand_path(__FILE__))\nresource_path = COCOA_APP_RESOURCES_DIR\n\n$LOAD_PATH.reject! { |d| d.index(File.dirname(COCOA_APP_RESOURCES_DIR))!=0 }\n$LOAD_PATH &lt;&lt; File.join(COCOA_APP_RESOURCES_DIR,&quot;ThirdParty&quot;)\n$LOAD_PATH &lt;&lt; File.join(File.dirname(COCOA_APP_RESOURCES_DIR),&quot;lib&quot;)\n$LOAD_PATH &lt;&lt; File.join(COCOA_APP_RESOURCES_DIR,&quot;RubyGems&quot;,&quot;gems&quot;,&quot;rb-appscript-0.4.0&quot;,&quot;lib&quot;)\n$LOAD_PATH &lt;&lt; File.join(COCOA_APP_RESOURCES_DIR,&quot;RubyGems&quot;,&quot;gems&quot;,&quot;hpricot-0.6&quot;,&quot;lib&quot;)\n$LOAD_PATH &lt;&lt; File.join(COCOA_APP_RESOURCES_DIR,&quot;RubyGems&quot;,&quot;gems&quot;,&quot;hpricot-0.6&quot;,&quot;ext&quot;,&quot;hpricot_scan&quot;)\n\n$LOADED_FEATURES &lt;&lt; &quot;rubycocoa.bundle&quot;\n\nENV['GEM_HOME'] = ENV['GEM_PATH'] = File.join(COCOA_APP_RESOURCES_DIR,&quot;RubyGems&quot;)\n\n#require 'rubygems'\n#require 'osx/cocoa'\nrequire 'appscript'\nrequire 'open-uri'\nrequire 'fileutils'\n$KCODE='u'\n\nrequire resource_path + '/ecs.rb'\n$faac_path = resource_path + &quot;/../MacOS/lib&quot;\n\ndef conv_year(str)\n\tstr =~ /^(\\d\\d\\d\\d).*/\n\t$1\nend\n\ndef conv_artwork(str)\n\tfilename = &quot;/tmp/amatunes.artwork&quot;\n\t@tmpfiles.push filename\n\tf = File.open(filename, &quot;wb&quot;)\n\tf.write open(str).read\n\tf.close\n\tfilename\nend\n\nclass MyBarcodeScannerDelegate\n\tdef initialize\n\t\t@barcodes = Hash.new\n\t\t@lastcode = nil\n\tend\n\tdef gotBarcode(barcode)\n\t\tbarcode = barcode.to_s\n\t\tbarcode = '0' + barcode if barcode.size == 12\n\t\tsum = 0\n\t\tmod = 1\n\t\tbarcode.reverse.each_byte do |c|\n\t\t\tn = c - '0'[0]\n\t\t\tsum += n * mod \n\t\t\tif mod == 1\n\t\t\t\tmod = 3\n\t\t\telse\n\t\t\t\tmod = 1\n\t\t\tend\n\t\tend\n\t\tsum %= 10\n\t\treturn unless sum == 0\n\t\treturn if @lastcode == barcode\n\t\t@lastcode = barcode\n\t\tif @barcodes[barcode].nil?\n\t\t\tAmazon::Ecs.options = {\n\t\t\t\t:aWS_access_key_id =&gt; '1N37DT5CJCZQKPZR7BG2',\n\t\t\t\t:country =&gt; 'jp',\n\t\t\t}\n\t\t\tres = Amazon::Ecs.item_search(barcode, {:response_group =&gt; 'Medium'})\n\t\t\titem = res.first_item\n\t\t\treturn if item.nil?\n\n\t\t\t@tmpfiles = Array.new\n\t\t\toption = &quot;&quot;\n\t\t\t[\n\t\t\t\t[&quot;artist&quot;, &quot;author&quot;],\n\t\t\t\t[&quot;album&quot;, &quot;title&quot;],\n\t\t\t\t[&quot;title&quot;, &quot;title&quot;],\n\t\t\t\t[&quot;writer&quot;, &quot;manufacturer&quot;],\n\t\t\t\t[&quot;cover-art&quot;, &quot;largeimage/url&quot;, :conv_artwork],\n\t\t\t\t[&quot;year&quot;, &quot;publicationdate&quot;, :conv_year],\n\t\t\t\t[&quot;genre&quot;, &quot;productgroup&quot;],\n\t\t\t].each do |o|\n\t\t\t\tstr = item.get(o[1]) \n\t\t\t\tnext if str.nil?\n\t\t\t\toption += ' --' + o[0] + ' &quot;' +\n\t\t\t\t\t(o[2].nil? ? str : send(o[2], str)) + '&quot;'\n\t\t\tend\n\t\t\tbegin\n\t\t\t\tm4b = &quot;/tmp/#{barcode}.m4b&quot;\n\t\t\t\t@tmpfiles.push m4b\n\t\t\t\tsystem &quot;#{$faac_path}/faac128 #{option} -o #{m4b} #{$faac_path}/base.wav&quot;\n\n\t\t\t\tapp = Appscript.app('iTunes')\n\t\t\t\tapp.activate\n\t\t\t\tapp.open MacTypes::Alias.path(m4b)\n\t\t\t\tapp.stop\n\n\t\t\t\t#@tmpfiles.each {|file| FileUtils.rm file}\n\t\t\t\t@barcodes[barcode] = item\n\n\t\t\t\t$snd.play\n\t\t\trescue\n\t\t\tend\n\t\tend\n\tend\nend\n\nwhile(s = gets)\n\td = MyBarcodeScannerDelegate.new()\n\td.gotBarcode(s.to_i)\nend</code></pre>\n\t\t<section>\n\t\t\t<h2>遭遇したトラブル</h2>\n\t\t\t<section>\n\t\t\t\t<h3>require osx/cocoaが通らない</h3>\n\t\t\t\t<p>使わない方向で逃げました。</p>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>ThirdParty/open-uri.rb:require stringioが通らない</h3>\n\t\t\t\t<p>相対パスだと、reject!のマッチングで問題があったので、\n\t\t\t\t絶対パスに変換するよう修正して解決。</p>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>faacが落ちる</h3>\n\t\t\t\t<p>AmaTunesに付属のfaacは、/opt/local/以下から\n\t\t\t\tライブラリをロードしようとして落ちていました。\n\t\t\t\tそこで、faacをコンパイルして、そちらを使いました。</p>\n\t\t\t\t<pre><code class=\"console\">$ ./configure --disable-shared\n$ make\n$ mv frontend/faac $dir</code></pre>\n\t\t\t</section>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<h1>やっていること</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"http://web.me.com/lufia/alefcompiler/alef/\">Alefコンパイラを読む</a></li>\n\t</ul>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}