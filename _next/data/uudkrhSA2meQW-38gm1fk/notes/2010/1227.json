{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>orange/note: SproutCoreとWCF Data Servicesの連携</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/notes/index.html\">orange/note</a></li>\n\t<li><a href=\"/notes/pc.html\">PC関連</a></li>\n\t<li><a href=\"/notes/web.html\">web製作</a></li>\n\t<li><a href=\"/notes/sec.html\">セキュリティ</a></li>\n\t<li><a href=\"/notes/hobby.html\">本・ゲーム</a></li>\n\t<li><a href=\"/notes/junk.html\">ジャンク</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2011年2月26日更新</p>\n\t<section>\n\t\t<h1>SproutCoreとWCF Data Servicesの連携</h1>\n\t\t<section>\n\t\t\t<h2>SQL Serverとdecimal型</h2>\n\t\t\t<p>SQL Serverのdecimal型は、WCF Data ServicesなJSONの中でみると\n\t\t\tString型になります。値を更新する場合も、\n\t\t\tNumber型では変換するときにエラーが起こります。\n\t\t\tこのため、postUrlまたはputUrlする前に型変換をしておく必要があります。</p>\n\t\t\t<pre><code class=\"js\">var h = store.readDataHash(storeKey)\nh = SC.copy(h, YES)\nh.decimalValue = h.decimalValue.toString()\nSC.Request.putUrl(url)\n\t.json()\n\t.header('Accept', 'application/json')\n\t.notify(this, 'didUpdateRecord', store, storeKey)\n\t.send(h)</code></pre>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>SQL Serverとdatetime型</h2>\n\t\t\t<p>バックエンドにSQL Serverを使う場合、\n\t\t\tdatetime型はタイムゾーンを持ちません。\n\t\t\tそして、WCF Data Servicesで取得する値は、\n\t\t\tサーバに保存されている時刻をUTC(GMT)として、\n\t\t\t1970年からそこまでのミリ秒が入っています。</p>\n\t\t\t<p>次に、JavaScriptのDateは、\n\t\t\t基本的にタイムゾーンはローカル固定みたいです。\n\t\t\tgetUTCxxxとかでUTCな値は調べられるけど、\n\t\t\tオブジェクトのタイムゾーンは変えられません。</p>\n\t\t\t<p>SC.DateTimeはtimezoneに差分を設定すれば変更できますが、\n\t\t\ttimezoneを省略した場合、ローカルタイムゾーンになります。\n\t\t\tJST(+09:00)の場合は-540となり、\n\t\t\tDate#getTimezoneOffsetと同じ値です。\n\t\t\tなので、WCF Data Servicesの値をそのままSC.DateTime#createすると、\n\t\t\tそこから+09:00された時刻になります。</p>\n\t\t\t<p>仮に&quot;2010-12-27T00:00:00&quot;がデータベースに保存されていたとすると、\n\t\t\tそのまま、ミリ秒にした値が返されます。\n\t\t\t具体的には1293375600000ですね。\n\t\t\tで、この値をタイムゾーンを省略してSC.DateTime化すると、\n\t\t\tデータハッシュには&quot;2010-12-27T09:00:00+09:00&quot;と保存されます。\n\t\t\tこのままPUTすると、データベースは&quot;2010-12-27T09:00:00&quot;になります。</p>\n\t\t\t<p>さてさて、SQL Serverの値をどちらと仮定するか、なのですが。</p>\n\t\t\t<ol>\n\t\t\t<li>SQL Serverの値はUTC</li>\n\t\t\t<li>あくまでローカル時間</li>\n\t\t\t</ol>\n\t\t\t<p>UTCだと仮定するのなら、問題ないのでそのまま使えばいいですが、\n\t\t\tローカル時間と仮定する場合(ほとんどがこちらだと思う)は、\n\t\t\t読み込み時に少し調整が必要です。</p>\n\t\t\t<pre><code class=\"js\">function dateFrom(s, format)\n{\n\tvar tzoff = new Date().getTimezoneOffset()*60000\n\tvar m = s &amp;&amp; s.match(/^\\\\?\\/Date\\((-?\\d+)([+-]\\d+)?\\)\\\\?\\/$/)\n\tif(m){\n\t\tvar tick = m[1]-0\n\t\tvar off = 0\n\t\tif(m[2])\n\t\t\toff = m[2]-0\n\t\tvar d = SC.DateTime.create(tick+off+tzoff)\n\t\tif(typeof format == 'undefined')\n\t\t\tformat = SC.DateTime.recordFormat\n\t\treturn d.toFormattedString(format)\n\t}\n\treturn null\n}</code></pre>\n\t\t\t<p>これを、データソースのfetchやretrieveRecordに仕込むと\n\t\t\tそれっぽく動きます。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>POST, PUTするとき</h2>\n\t\t\t<p>JSONでデータを送るときは、\n\t\t\tContent-Typeヘッダにapplication/jsonが必要です。\n\t\t\tこれは、SC.Request#jsonを使うと自動で設定されます。\n\t\t\tデータの取得にはAcceptヘッダが必要ですが、\n\t\t\tjson関数は、こちらは設定しませんので注意です。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>トリガ</h2>\n\t\t\t<p>WCF Data Servicesは、競合を防ぐ目的で、\n\t\t\tEtagが異なればエラーを返すようになっているみたいです。\n\t\t\tinsert/updateをトリガとしてデータの一部を加工する処理が動くと、\n\t\t\t結果として異なるEtagになるらしく、4xxエラー(忘れた)が返ります。\n\t\t\tこれはどうしたものでしょうね。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>Entity Framework</h2>\n\t\t\t<p>独立キーアソシエーションでODataのモデルを定義すると、\n\t\t\t外部キーを持ちませんので、IDを使ってのリレーション更新ができません。\n\t\t\tなので、外部キーアソシエーションで作っておくことをおすすめします。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>主キー</h2>\n\t\t\t<p>テーブルを設計するときに、複合キーは使わないほうがいいと思います。\n\t\t\tフレームワークにあわせてデータベースを設計するなんて\n\t\t\tなんだか本末転倒な気がしますが、そのほうが扱いやすいです。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ほか</h2>\n\t\t\t<p>データベース制約に違反している場合はHTTP 500を返すようです。</p>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<ul>\n\t<li><a href=\"1129.html\">WCF Data Servicesメモ</a></li>\n\t<li><a href=\"../2011/0805.html\">SQL Serverのメモ</a></li>\n\t</ul>\n</aside>\n<aside>\n\t<h1>やっていること</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"http://web.me.com/lufia/alefcompiler/alef/\">Alefコンパイラを読む</a></li>\n\t</ul>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}