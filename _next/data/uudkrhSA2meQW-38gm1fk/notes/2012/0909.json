{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>orange/note: VMware ESXiの導入</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/notes/index.html\">orange/note</a></li>\n\t<li><a href=\"/notes/pc.html\">PC関連</a></li>\n\t<li><a href=\"/notes/web.html\">web製作</a></li>\n\t<li><a href=\"/notes/sec.html\">セキュリティ</a></li>\n\t<li><a href=\"/notes/hobby.html\">本・ゲーム</a></li>\n\t<li><a href=\"/notes/junk.html\">ジャンク</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2012年9月9日作成</p>\n\t<section>\n\t\t<h1>VMware ESXiの導入</h1>\n\t\t<p>だいぶ前に、ESXi 5.0を導入したので、\n\t\tその上でPlan 9サーバ群を動かすまでのメモをまとめました。\n\t\tPlan 9側のトラブルメモは別の記事にまとめるつもりです。こっちはESXi。</p>\n\t\t<section>\n\t\t\t<h2>インストール</h2>\n\t\t\t<p>なにはともあれ普通にインストール。\n\t\t\tMegaRAID 9240-4iに繋げたSSDにインストールしようと思ったら、\n\t\t\tインストールはできるけどブートできないという、よくわからない現象に。。\n\t\t\t同じハードウェア構成でWindowsを入れた時はふつうにブートしたので、\n\t\t\t何か分からないけどESXi側の問題な気がするなあ。</p>\n\t\t\t<p>とはいえ解決できなかったので、あきらめてUSBメモリを買ってきてそこへインストール。\n\t\t\tESXi4の頃は、いろいろ設定しないとだめっぽい記事があったけど、\n\t\t\tESXi5では普通のインストーラでも認識してくれるみたい。</p>\n\t\t\t<p class=\"note\">MegaRAIDのWebBIOSは、2chのRAIDカードスレによると、\n\t\t\tWebBIOSブート用のBIOSだけをメモリに置いておいて、\n\t\t\tブート時には&quot;WebBIOSが入った仮想ディスク&quot;から起動するようです。\n\t\t\tなので、別のデバイスが優先になっているとWebBIOSに入れないとかなんとか。</p>\n\t\t\t<p>インストールが終わったら、コンソールからIPアドレスやらなにやらを設定。\n\t\t\tあとついでにSSHも有効にしておきます。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>LSI Providerのインストール</h2>\n\t\t\t<p>LSI 9240-4iを使っているので、せっかくだからとLSIProviderを入れてみます。\n\t\t\tふつうに、VMwareのサイトからVMW-ESX-5.0.0-LSIProvider-xxxx.zipを\n\t\t\tダウンロードしてきて展開、vibファイルだけをsshでESXiホストへ送ります。\n\t\t\tで、以下のコマンド実行。</p>\n\t\t\t<pre><code class=\"console\">$ esxcli software vib install -v /vmware-esx-provider-LSIProvider.vib</code></pre>\n\t\t\t<p class=\"note\">esxcliに渡すvibファイルは、ルートからのフルパスでないとエラーになります。</p>\n\t\t\t<p>MegaCLIのESXi版はLSIのサイトから落とせるけれど、ESXi5にはlibstorelib.soが\n\t\t\t見つからなくて動きません。libstorelibを過去のESXiから拾っておくと動くけど、\n\t\t\tそこまでしなくてもいい気がしているので入れない方向でいます。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>vSphere Clientをインストール</h2>\n\t\t\t<p>ESXiとは別のWindowsマシンに、クライアントツールを入れます。\n\t\t\tESXiホストにhttpで繋げばダウンロードできるので、ここは別に書くことない。。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>VMwareの仮想ドライバパフォーマンス</h2>\n\t\t\t<p>疑問だったのですけど、ESXiホストのネットワーク速度が1Gbで、\n\t\t\t仮想マシンのドライバがvlance(これは10Mb)の場合、どっちが有効なのかなあ、と。\n\t\t\t検索しても、同じハードウェアで物理と仮想のベンチマーク比較はいっぱいあるけれど、\n\t\t\t古い物理マシンをそのまま新しいハードウェアの仮想へもってきたとき、\n\t\t\tパフォーマンスが上がるのかはあまり見つからない。</p>\n\t\t\t<p>もし仮想デバイスの速度に制限されるなら、<a href=\"http://sourceforge.net/projects/open-vm-tools/files/open-vm-tools/\">Open Virtual Machine Tools</a>を\n\t\t\t移植するか、fsカーネルのe1000ドライバをまともな速度にするか、どちらかしないといけなくて\n\t\t\tめんどくさいなあと思っていたのですね。</p>\n\t\t\t<p>でも<a href=\"http://www-06.ibm.com/systems/jp/saiteki/pdf/esx_server3.pdf\">ESX Server 3のパフォーマンスチューニングドキュメント</a>によると、</p>\n\t\t\t<blockquote>たとえば、ESX ServerがエミュレートするAMD PCnetカードが定義により\n\t\t\t10Mbpsであるため、サーバ上の物理カードが100Mbpsまたは1Gbpsであっても、\n\t\t\t仮想マシン上のvlanceゲストドライバは10Mbpsの速度を報告します。\n\t\t\tただし、ESX Serverは10Mbpsには制限されず、物理サーバマシン上のリソースが\n\t\t\t許すかぎり高速にネットワークパケットを転送します。</blockquote>\n\t\t\t<p>とあるので、若干の劣化はあるでしょうけど今の使い方なら問題ない範囲かな。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>VMDK</h2>\n\t\t\t<p>クライアントからみると1つのvmdkにみえますが、\n\t\t\tsshからアクセスしてみたらじつは2つのファイルになっています。\n\t\t\tdisk.vmdkというもろもろの設定を書いたテキストファイルと、\n\t\t\tdisk-flat.vmdkというディスクファイル本体です。</p>\n\t\t\t<p>クライアントのストレージブラウザからはvmdkファイルの名前が変更できませんが、\n\t\t\tsshからなら普通に変更できるので、guest_1.vmdkみたいな名前がいやな人は、\n\t\t\tこの2つのファイルをmvして、vmdkファイルに書かれている\n\t\t\tflat.vmdkファイルへの参照も変更すればいいです。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ゲスト間のシリアルポート接続</h2>\n\t\t\t<p>物理にあったPlan 9システムは、fsカーネルのコンソールを、\n\t\t\t認証サーバがシリアルポート経由でログに記録していたので、\n\t\t\tどうにかしてゲスト間をシリアルポートで繋ぐ必要がありました。\n\t\t\tUPSみたいな外部機器とゲストを接続する記事はいくつかありましたが、\n\t\t\tゲスト間をつなぐ記事は見つからなかったのでメモ。</p>\n\t\t\t<p>ゲストの構成からシリアルポートを追加します。\n\t\t\tこのとき、名前付きパイプを選んで、名前は適当に(console0など)入力。\n\t\t\t無償版のライセンスでは、Ethernetを使った方法は使えないので無視します。</p>\n\t\t\t<p>で、接続先の設定はよく分かっていませんが、\n\t\t\tデータを受け取る側を「サーバ」、送る側を「クライアント」にしました。\n\t\t\t具体的にはfs側は「クライアント」で、認証サーバが「サーバ」。\n\t\t\t接続先はどちらも「仮想マシン」。プロセスとの違いは分からない。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ブートフロッピーの作成</h2>\n\t\t\t<p>これは普通に、Plan 9からpc/bootfloppyで作ればいいです。\n\t\t\tできたらvSphere Clientのファイルブラウザでアップロード。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>過去のデータをvmdkに変換</h2>\n\t\t\t<p>VMwareのConverterはBootCDが見つからなかったので、\n\t\t\t今回はvirt-p2vを使いました。</p>\n\t\t\t<p>まずはvirt-p2vをどうにかしてDVDに焼きます。\n\t\t\tできたら普通にブート。sshなどの設定をしていくのですが、\n\t\t\t仮想ディスクに変換するHDDを選ぶところで、Plan 9 fsのWORMディスクを\n\t\t\t選ぶと、何度やってもエラーになります。\n\t\t\tなのであきらめて、virt-p2vでエラーがでた画面から\n\t\t\tFnキ(たしかF2)を押してシェルを実行。そのままシェルを使ってddしました。</p>\n\t\t\t<pre><code class=\"console\"># fdisk -l\n(エラーが出るけど無視、容量だけ確認してターゲットを選ぶ)\n# dd if=/dev/sdb | gzip -9 -c | ssh $user@$host &quot;gzip -dc | dd bs=8192 of=/path/vmdisk/fworm.img&quot;</code></pre>\n\t\t\t<p>sshで接続するホストは、virt-p2vでssh設定テストした場所にすると楽です。</p>\n\t\t\t<p>ここからしばらく待てば、fworm.imgファイルができているはずです。\n\t\t\tHDDの速度やらネットワークやらに依存しますが、250GBを転送するのに\n\t\t\tだいたい2時間かかりました。</p>\n\t\t\t<p>次に、生のディスクファイルからvmdkへコンバートします。\n\t\t\tこのときはqemu-imgを使いました。</p>\n\t\t\t<pre><code>$ qemu-img convert -f raw fworm.img fworm-flat.vmdk</code></pre>\n\t\t\t<p>よく記事になっているコマンドでは、-f raw fowrm.img -O vmdk fworm.vmdkのように\n\t\t\tオプションでコンバート後の種類を指定していますが、\n\t\t\tなぜかこのオプションが効かずに、&quot;-O&quot;というファイル名になったりしました。\n\t\t\tたぶんfworm.imgの前にオプションを全部置けば動いたのでしょうけど、\n\t\t\tべつにわざわざ使わなくても判定してくれるので外してます。</p>\n\t\t\t<p>vmdkファイルが完成したら、それをESXiへ転送します。scpを使うよりは、\n\t\t\tgzipして転送したほうが早い気がするので、ddのときに使ったコマンドを\n\t\t\tそのまま使いました。</p>\n\t\t\t<pre><code class=\"console\">$ gzip -9 -c fworm-flat.vmdk | ssh $user@$esxihost &quot;gzip -dc &gt;/vmfs/volumes/disk1/plan9fs/fworm-flat.vmdk&quot;</code></pre>\n\t\t\t<p>必要なら、flatじゃないほうのvmdkファイルを修正して完成です。</p>\n\t\t\t<p>Plan 9ファイルサーバカーネルの場合、WORMだけ持ってくればいいのですが、\n\t\t\tそうすると、Cacheにある情報との齟齬でSuperblockが読めない系のエラーがでます。\n\t\t\tそのときはrecover mainすれば直前のdumpから普通に使えるようになります。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>トラブルシューティング</h2>\n\t\t\t<section>\n\t\t\t\t<h3>健全性ステータスが全部、”不明”になった</h3>\n\t\t\t\t<p>原因はよく分かりませんが、ESXiコンソールのTroubleshooting Optionsから、\n\t\t\t\tRestart Management Agentsで一部機能を再起動させると治りました。</p>\n\t\t\t</section>\n\t\t\t<section>\n\t\t\t\t<h3>LSI MegaRAID 9240-4iのバッテリに警告が出る</h3>\n\t\t\t\t<p>健全性ステータスをみると、警告が出ていますが、\n\t\t\t\tもともと9240-4iはエントリモデルでBBUは付いていないので、\n\t\t\t\tそういうものらしいです。</p>\n\t\t\t</section>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<h1>やっていること</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"http://web.me.com/lufia/alefcompiler/alef/\">Alefコンパイラを読む</a></li>\n\t</ul>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}