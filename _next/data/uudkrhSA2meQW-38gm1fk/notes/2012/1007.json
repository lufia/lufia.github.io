{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>orange/note: ESXiでfsカーネルのブート</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/notes/index.html\">orange/note</a></li>\n\t<li><a href=\"/notes/pc.html\">PC関連</a></li>\n\t<li><a href=\"/notes/web.html\">web製作</a></li>\n\t<li><a href=\"/notes/sec.html\">セキュリティ</a></li>\n\t<li><a href=\"/notes/hobby.html\">本・ゲーム</a></li>\n\t<li><a href=\"/notes/junk.html\">ジャンク</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2012年10月7日作成</p>\n\t<section>\n\t\t<h1>ESXiでfsカーネルのブート</h1>\n\t\t<p>6/12頃、ESXi 5.0にfs64カーネルを置いて動かしたところ、\n\t\t起動時に、たぶんカーネルの実行がはじまったあたりで、\n\t\t割り込みかなにかを受けてパニックしました。\n\t\t回避はしたけど解決できていないので、いちおうまとめ。</p>\n\t\t<p>具体的なメッセージはこんなの。</p>\n\t\t<pre><code>cpu0: 2590MHz P6\napm ax=f000 cx=f000 dx=40 di=ffff ebx=5470 esi=-1\nbios (usb) loading disabled\nno ethernet interfaces recognised\nbus dev type vid  did intlognised\nbus dev type vid  did intl memory\nfound 9fsfs64\n.388008.........................+1208352.................+189444-705804\nentry: 0x80100020\nFLAGS=10086 TRAP=e ECODE=0 PC=80128b8c\n  AX f000ff53  BX 801913b4  CX 801959a4  DX 801913b4\n  SI 8012b96b  DI 001ac964  BP 00000049\n  CS 0010 DS 0008  ES 0000  FS 0008  GS 0008\n  CR0 80010011 CR2 f000ff53 CR3 00183000\npanic: exception/interrupt 14\nFLAGS=10086 TRAP=e ECODE=0 PC=8001e777\n  AX 8001e769  BX 00000c80  CX 808185fc  DX 00000006\n  SI 00000000  DI 8004f3e8  BP 0000000a\n  CS 0010 DS 0008  ES 0000  FS 0008  GS 0008\n  CR0 80010011 CR2 80818614 CR3 00183000\npanic: exception/interrupt 14\n....</code></pre>\n\t\t<section>\n\t\t\t<h2>interrupt 14とは</h2>\n\t\t\t<p>調べると、page faultでした。結構いやな感じ。</p>\n\t\t\t<p>上記のログ&quot;entry: 0x80100020&quot;に続くのは、\n\t\t\tおそらく&quot;Plan 9 63-bit fileserver&quot;で、\n\t\t\tこの文字列はmain()の中、一部の初期化が終わったところにあります。\n\t\t\tで、exception/interrupt 14というメッセージは、\n\t\t\tローダの割り込みハンドラに書かれています。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>最新のローダで動かす</h2>\n\t\t\t<p>最新(6/14頃)のCD imageからインストールしてみると普通に動きました。\n\t\t\tそのまま、カーネルだけfs64に差し替えてみたらエラー。\n\t\t\tなのでローダのメッセージが出ているけれど、原因はカーネルっぽい。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ESXiとの相性問題なのか調べる</h2>\n\t\t\t<p>少なくとも物理マシンで動いていた、2010年頃(もっと前かも)に作成した\n\t\t\tfs64のブートフロッピーからブートしたら動きました。\n\t\t\tそのままカーネルだけを新しくコンパイルしたものに差し替えたら起動しません。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ビルド環境を変えてみる</h2>\n\t\t\t<p>fsカーネルは/386/lib/libc.a等をリンクしているようなので\n\t\t\t適当に、/n/dump/2011/0701/386を/386にバインドして\n\t\t\tコンパイルしたものの、やっぱり変わらずエラー。</p>\n\t\t\t<p>コンパイラとリンカを2011/07/01のものに変えたらなんだか動いた。</p>\n\t\t\t<pre><code class=\"console\">% 9fs dump\n% bind /n/dump/2011/0701/386/8c /bin/8c\n% bind /n/dump/2011/0701/386/8l /bin/8l</code></pre>\n\t\t\t<p>コンパイラのバグが修正されて、修正の結果、\n\t\t\tそれまでバグがあったおかげでたまたまうまく動いていた部分が\n\t\t\t今回から落ちるようになったのなら、放置すると後で困りそうだなあ。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>おまけ</h2>\n\t\t\t<p>いちおう読んだfsカーネルのブート周りのフロー。</p>\n\t\t\t<pre><code>port/main.c:main\n\tport/sub.c:formatinit()\t# printの書式などを初期化\n\tport/main.c:machinit()\t# mってなんだ？\n\tpc/pc.c:vecinit()\n\t\t# たぶん、9loadに読み込まれたplan9.iniをパースする\n\t\t# confname[n], confval[n]に入る\n\t\t# =が複数ある場合は、最初の=までがconfname\n\tport/main.c:confinit()\n\t\t# conf構造体を初期化\n\t\tpc/pc.c:meminit()\n\t\t\tpc/pc.c:mconfinit()\n\t\t\t\t# mmap, mapaddrを初期化しているっぽい\n\t\t\tpc/mmu.c:mmuinit()\n\t\t\t\t# gdt, kptを初期化？\n\t\t\t\t# このあたりになるとよくわからない\n\t\t\t\tpc/mmu.c:taskswitch()\n\t\t\t\t\t# tssを初期化\n\t\t\ttrapinit()\n\t\t\t\t# 割り込み設定\n\t\t\t\t# intr0, 1みたいな関数は、pc/l.sにあるアセンブリコード\n\t\t\t\t# そこから潜って、pc/trap.c:trapに落ち着く\n\n\t\t\t\tSEGCG: call gate\n\t\t\t\tSEGIG: interrupt gate\n\t\t\t\tSEGTG: task gate\n\n\t\t\t\t# 0..255までにtask gateとして、intrbadを設定\n\t\t\t\tsethvec() for 17..23, 40..255\n\n\t\t\t\t# 0から16までは特別なintr0, intr1みたいなトラップ\n\t\t\t\t# うち、14(page fault), 16(math coprocessor)はinterrupt gate\n\t\t\t\tsethvec() for 0..16\n\n\t\t\t\t# デバイス割り込みはinterrupt gate; これも特別なトラップ\n\t\t\t\tsethvec() for 24..39\n\n\t\t\t\tなんかいろいろ\n\t\t\t\tfpinit()\n\t\tfs64/9fsfs64.c:localconfinit()\n\t\t\t# confをいろいろ設定\n\t\t\t# 時間とか\n\tpc/pc.c:lockinit()\n\t\t# 何もしない\n\tport/devcons.c:printinit()\n\t\t# printq, readqを初期化\n\t\tpc/pc.c:consinit()\n\t\t\t# consgetc, consputc, consputs, intrputsの設定\n\t\t\t# コンフィグがconsole=cgaでなければbaudとかも設定\n\t\t\tpc/kbd.c:kbdinit()\n\tport/proc.c:procinit()\n\t\t# procallocを初期化\n\t\twakeup()\n\tpc/8253.c:clockinit()\n\t\t# 他もだが、特にここは本気でわからない\n\t\tsetvec()\n\t\tcpuid()\n\t\tcycles()\n\t\taamloop()\n\n\tprint(&quot;Plan 9 64 bit file server...&quot;)\n\n\tprintsizes()\n\talarminit()\n\n\t# このあたりでserveq, raheadqを初期化\n\n\tmbinit()\n\tsntpinit()\n\tfs64/9fsfs64.c:otherinit()\n\n\t# 終わりに、files, wpaths, uid, gidspaceを初期化\n\n\tauthinit()\n\tiobufinit()\n\targinit()\n\tuserinit()\n\n\twakeup()\n\tlaunchinit()\n\tschedinit()</code></pre>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<h1>やっていること</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"http://web.me.com/lufia/alefcompiler/alef/\">Alefコンパイラを読む</a></li>\n\t</ul>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}