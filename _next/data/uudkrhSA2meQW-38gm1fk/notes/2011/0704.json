{"pageProps":{"html":"<!doctype html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<title>orange/note: IL/IPv6対応</title>\n<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n<meta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\">\n</head>\n<body>\n<nav>\n\t<h1>メニュー</h1>\n\t<ul>\n\t<li><a href=\"/notes/index.html\">orange/note</a></li>\n\t<li><a href=\"/notes/pc.html\">PC関連</a></li>\n\t<li><a href=\"/notes/web.html\">web製作</a></li>\n\t<li><a href=\"/notes/sec.html\">セキュリティ</a></li>\n\t<li><a href=\"/notes/hobby.html\">本・ゲーム</a></li>\n\t<li><a href=\"/notes/junk.html\">ジャンク</a></li>\n\t</ul>\n</nav>\n<main>\n\t<p class=\"revision\">2011年7月4日作成</p>\n\t<section>\n\t\t<h1>IL/IPv6対応</h1>\n\t\t<p>さすがにそろそろIPv6は無視できないということで、\n\t\tざっと<a href=\"../../plan9/src/il.c\">ILをIPv6に対応</a>させました。\n\t\tそのときのメモなどを少し書き残し。</p>\n\t\t<section>\n\t\t\t<h2>IPv4とIPv6の違い</h2>\n\t\t\t<p>当たり前ですが、ILそのものは特に変わりありません。\n\t\t\t雑に言うとIlhdrのIPヘッダ部分が違うだけなので、\n\t\t\t今回追加したコードはその振り分けとチェックサム計算部分です。</p>\n\t\t\t<p>Il6hdrの名前は、極力Il4hdrのものを残しました。\n\t\t\tIPv6の仕様ではnextheaderですがこれをprotoに、\n\t\t\t同様にhoplimitをttlとしました。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>ヘッダの振り分け</h2>\n\t\t\t<p>Block構造体があれば、そのrpからwpの間に、\n\t\t\tIPヘッダとデータが続けて格納されています。\n\t\t\tなので、これの最初4bitを調べると、IPバージョンが分かります。</p>\n\t\t\t<pre><code class=\"c\">Block *bp;\nIl4hdr *h4;\nIl6hdr *h6;\nuchar version;\n\nh4 = (Il4hdr*)bp-&gt;rp;\nversion = ((h4-&gt;vihl&amp;0xF0)==IP_VER6) ? V6 : V4;\nswitch(version){\ncase V4:\n\t...\n\tbreak;\ncase V6:\n\th6 = (Il6hdr*)bp-&gt;rp;\n\t...\n\tbreak;\ndefault:\n\tpanic(&quot;ilxxx: version %d&quot;, version);\n}</code></pre>\n\t\t\t<p>ilkickなど、Blockが無い場合は、\n\t\t\tConv構造体のipversionをみると判別できます。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>チェックサム計算</h2>\n\t\t\t<p>チェックサムはパケットが壊れていないかを判断するために使います。\n\t\t\tパケットの送信者がチェックサムフィールド(ilsum)を0として計算し、\n\t\t\tそれをilsumに格納して送信します。\n\t\t\tデータが届いたら、受信者はチェックサムを計算しますが、\n\t\t\tここではilsumを受け取ったまま計算に含めます。\n\t\t\tデータに破損がなければ、チェックサム値は0になります。\n\t\t\t詳しい話は置いておきますが、雑に書くと</p>\n\t\t\t<pre><code class=\"c\">~sum16(X + ~sum16(X)) = 0</code></pre>\n\t\t\t<p>これは結局、0だった16bit数が~sum16(X)に置き換わるだけなので</p>\n\t\t\t<pre><code class=\"c\">~(sum16(X) + ~sum16(X)) = ~0xFFFF = 0</code></pre>\n\t\t\t<p>次は実装について。</p>\n\t\t\t<p>IL/IPv4の場合、ILヘッダからチェックサムを計算します。\n\t\t\tこれはIPv4がチェックサムを持っているから省略したのだと思われますが、\n\t\t\tIPv6では無くなっているので、IPヘッダも含めなければいけません。\n\t\t\tTCPやUDPでは<a href=\"http://www.wdic.org/w/WDIC/%E7%96%91%E4%BC%BC%E3%83%98%E3%83%83%E3%83%80\">疑似ヘッダ</a>\n\t\t\tを使っていますので、ILもそれに併せました。</p>\n\t\t\t<p>計算の実際では、疑似ヘッダをそのまま作ったりはしていません。\n\t\t\tその代わり、適当にそれっぽい値を割り当てて、まとめて計算しています。\n\t\t\t具体的には以下の通り。</p>\n\t\t\t<table>\n\t\t\t<tr><th>仕様</th><th>Il6hdrメンバ</th></tr>\n\t\t\t<tr><td>Length</td><td>viclfl</td></tr>\n\t\t\t<tr><td>Zero(16bit)</td><td>len</td></tr>\n\t\t\t<tr><td>Zero(8bit)</td><td>proto</td></tr>\n\t\t\t<tr><td>Next Header</td><td>ttl</td></tr>\n\t\t\t<tr><td>Source Addr</td><td>src</td></tr>\n\t\t\t<tr><td>Dest Addr</td><td>dst</td></tr>\n\t\t\t</table>\n\t\t\t<p>暗号などと違い、チェックサムの計算アルゴリズムは比較的ゆるく、\n\t\t\t先頭から順に16bit数として加算し、その結果から1の補数を求める、\n\t\t\tというものなので順番が違っても問題にはならないのですね。</p>\n\t\t</section>\n\t\t<section>\n\t\t\t<h2>その他メモ</h2>\n\t\t\t<p>ttlとtosは、ipoput4またはipoput6が設定しているので\n\t\t\tパケット組み立て時には気にしなくてもいいみたい。\n\t\t\tIPv6ヘッダにtosはありませんが、\n\t\t\t同等のものがviclflの5ビット目から12ビット目まで。</p>\n\t\t\t<p>IL/IPv6ヘッダは、長さフィールドがIPv6側とIL側にあります。\n\t\t\tこれはどちらもIPヘッダを除いた長さ(ILヘッダ長+データ長)なので、\n\t\t\tillenはいらないかなあとは思いますけど、どうでしょうか。</p>\n\t\t</section>\n\t</section>\n</main>\n<aside>\n\t<h1>関連情報</h1>\n\t<ul>\n\t<li><a href=\"0618.html\">il.cを読む</a></li>\n\t</ul>\n</aside>\n<aside>\n\t<h1>やっていること</h1>\n\t<ul>\n\t<li><a href=\"/plan9/index.html\">Plan 9</a></li>\n\t<li><a href=\"http://web.me.com/lufia/alefcompiler/alef/\">Alefコンパイラを読む</a></li>\n\t</ul>\n</aside>\n<footer>\n\t<p>見れない、表示がおかしい場合は、動作環境を添えて<a href=\"mailto:webmaster@lufia.org\">webmaster@lufia.org</a>まで連絡ください。</p>\n</footer>\n</body>\n</html>\n"},"__N_SSG":true}