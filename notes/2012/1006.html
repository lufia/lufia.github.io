<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>orange/note: VMware ESXiにPlan 9を移行したときのトラブルまとめ</title><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="author" content="http://www.hatena.ne.jp/lufiabb/"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/1b15737708df434c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1b15737708df434c.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-c2e8b39087850489.js" defer=""></script><script src="/_next/static/chunks/main-7715c9ce3e92f40f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8e84d751e7e95936.js" defer=""></script><script src="/_next/static/chunks/245-02c6405e66663b10.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...slug%5D%5D-663c09fbf665935a.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_buildManifest.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_ssgManifest.js" defer=""></script></head><body><div id="__next">
<nav>
	<h1>メニュー</h1>
	<ul>
	<li><a href="/notes/index.html"><a>orange/note</a></a></li>
	<li><a href="/notes/pc.html"><a>PC関連</a></a></li>
	<li><a href="/notes/web.html"><a>web製作</a></a></li>
	<li><a href="/notes/sec.html"><a>セキュリティ</a></a></li>
	<li><a href="/notes/hobby.html"><a>本・ゲーム</a></a></li>
	<li><a href="/notes/junk.html"><a>ジャンク</a></a></li>
	</ul>
</nav>
<main>
	<p class="revision">2012年10月6日作成</p>
	<section>
		<h1>VMware ESXiにPlan 9を移行したときのトラブルまとめ</h1>
		<section>
			<h2>cpuサーバからfsをマウントできない</h2>
			<pre><code class="console">% 9fs il!fs.ip.ad.dr!9fs</code></pre>
			<p>こうすると、マウントできず切断されます。
			たぶんカーネルにILを組み込んだけどndb/csに手を入れるのを忘れていたせいだと思う。</p>
			<p class="note">この場合、fsコンソールのflagコマンドでilビットをを立てて、
			出力される接続元と接続先をみるとポートが9になっているのでよくわかる。</p>
			<p>この場合、マウントするには以下のようにポートを数値にすればいいです。</p>
			<pre><code class="console">% 9fs il!fs.ip.ad.dr!17008</code></pre>
		</section>
		<section>
			<h2>mkextでバックアップを展開すると、not foundが出力される</h2>
			<p>単純に、マウントするとき-cを付けていないだけでした。
			もちろん展開もできていないのでやりなおし。</p>
		</section>
		<section>
			<h2>ブート時に、version...time...で長時間固まる</h2>
			<p>正確には、version...でしばらく止まって、
			time...でも止まっていました。トータル20分くらい。
			結局これ、<a href="/plan9/src/il.c"><a>IPv6対応したil.c</a></a>のバグで、正しくilrejectできていなくて、
			タイムアウトまで待ち続けていただけっぽいです。</p>
		</section>
		<section>
			<h2>ipconfigでgbeを使うと、replica時に落ちる</h2>
			<p>gbeというのは、ドライバのことではなくて、ipconfigの引数で</p>
			<pre><code class="console">% ip/ipconfig -g xxx gbe /net/ether0 ...</code></pre>
			<p>とした場合のことです。このとき、replica/pullすると
			hungup io connectionとエラーを吐いてシステムごと落ちます。
			調べる気もないので原因不明。gbeではなくetherなら動きました。</p>
		</section>
		<section>
			<h2>fs64に含まれるIntel E1000ドライバが遅い</h2>
			<p>もともと含まれていたigbe.cはVMwareのVendorID等を持っていなかったので
			Plan 9カーネルをまねて足したのですが、全然パフォーマンスが出ませんでした。
			具体的には、同じホストにある仮想マシン間でpingを投げる(cpu to fs)と、
			平均30000us程度かかっていました。ふつうは遅くても200us程度なのに。</p>
			<p class="note">不思議なのは、Plan 9カーネルにもigbe.cがあって、
			同じESXiホストに乗っているのに、こっちは200us程度なんですよね。
			様子をみる限りでは、fs側のパケット受信反応が悪い気がする。
			VendorID足したときにミスったかなあ。。。</p>
			<p>結局、<a href="/plan9/src/ether79c970.c"><a>AMD VlanceドライバをPlan 9カーネルからfsへ移植</a></a>しました。
			こっちは普通に200us程度の速度出ているみたい。</p>
		</section>
	</section>
</main>
<aside>
	<h1>やっていること</h1>
	<ul>
	<li><a href="/plan9/index.html"><a>Plan 9</a></a></li>
	<li><a href="http://web.me.com/lufia/alefcompiler/alef/">Alefコンパイラを読む</a></li>
	</ul>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="/notes/2012/mailto:webmaster@lufia.org"><a>webmaster@lufia.org</a></a>まで連絡ください。</p>
</footer>
</div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"html":"\u003c!doctype html\u003e\n\u003chtml lang=\"ja\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003ctitle\u003eorange/note: VMware ESXiにPlan 9を移行したときのトラブルまとめ\u003c/title\u003e\n\u003cmeta name=\"viewport\" content=\"width=device-width,initial-scale=1\"\u003e\n\u003cmeta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cnav\u003e\n\t\u003ch1\u003eメニュー\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/index.html\"\u003eorange/note\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/pc.html\"\u003ePC関連\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/web.html\"\u003eweb製作\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/sec.html\"\u003eセキュリティ\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/hobby.html\"\u003e本・ゲーム\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/junk.html\"\u003eジャンク\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/nav\u003e\n\u003cmain\u003e\n\t\u003cp class=\"revision\"\u003e2012年10月6日作成\u003c/p\u003e\n\t\u003csection\u003e\n\t\t\u003ch1\u003eVMware ESXiにPlan 9を移行したときのトラブルまとめ\u003c/h1\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003ecpuサーバからfsをマウントできない\u003c/h2\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e% 9fs il!fs.ip.ad.dr!9fs\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003cp\u003eこうすると、マウントできず切断されます。\n\t\t\tたぶんカーネルにILを組み込んだけどndb/csに手を入れるのを忘れていたせいだと思う。\u003c/p\u003e\n\t\t\t\u003cp class=\"note\"\u003eこの場合、fsコンソールのflagコマンドでilビットをを立てて、\n\t\t\t出力される接続元と接続先をみるとポートが9になっているのでよくわかる。\u003c/p\u003e\n\t\t\t\u003cp\u003eこの場合、マウントするには以下のようにポートを数値にすればいいです。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e% 9fs il!fs.ip.ad.dr!17008\u003c/code\u003e\u003c/pre\u003e\n\t\t\u003c/section\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003emkextでバックアップを展開すると、not foundが出力される\u003c/h2\u003e\n\t\t\t\u003cp\u003e単純に、マウントするとき-cを付けていないだけでした。\n\t\t\tもちろん展開もできていないのでやりなおし。\u003c/p\u003e\n\t\t\u003c/section\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003eブート時に、version...time...で長時間固まる\u003c/h2\u003e\n\t\t\t\u003cp\u003e正確には、version...でしばらく止まって、\n\t\t\ttime...でも止まっていました。トータル20分くらい。\n\t\t\t結局これ、\u003ca href=\"../../plan9/src/il.c\"\u003eIPv6対応したil.c\u003c/a\u003eのバグで、正しくilrejectできていなくて、\n\t\t\tタイムアウトまで待ち続けていただけっぽいです。\u003c/p\u003e\n\t\t\u003c/section\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003eipconfigでgbeを使うと、replica時に落ちる\u003c/h2\u003e\n\t\t\t\u003cp\u003egbeというのは、ドライバのことではなくて、ipconfigの引数で\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e% ip/ipconfig -g xxx gbe /net/ether0 ...\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003cp\u003eとした場合のことです。このとき、replica/pullすると\n\t\t\thungup io connectionとエラーを吐いてシステムごと落ちます。\n\t\t\t調べる気もないので原因不明。gbeではなくetherなら動きました。\u003c/p\u003e\n\t\t\u003c/section\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003efs64に含まれるIntel E1000ドライバが遅い\u003c/h2\u003e\n\t\t\t\u003cp\u003eもともと含まれていたigbe.cはVMwareのVendorID等を持っていなかったので\n\t\t\tPlan 9カーネルをまねて足したのですが、全然パフォーマンスが出ませんでした。\n\t\t\t具体的には、同じホストにある仮想マシン間でpingを投げる(cpu to fs)と、\n\t\t\t平均30000us程度かかっていました。ふつうは遅くても200us程度なのに。\u003c/p\u003e\n\t\t\t\u003cp class=\"note\"\u003e不思議なのは、Plan 9カーネルにもigbe.cがあって、\n\t\t\t同じESXiホストに乗っているのに、こっちは200us程度なんですよね。\n\t\t\t様子をみる限りでは、fs側のパケット受信反応が悪い気がする。\n\t\t\tVendorID足したときにミスったかなあ。。。\u003c/p\u003e\n\t\t\t\u003cp\u003e結局、\u003ca href=\"../../plan9/src/ether79c970.c\"\u003eAMD VlanceドライバをPlan 9カーネルからfsへ移植\u003c/a\u003eしました。\n\t\t\tこっちは普通に200us程度の速度出ているみたい。\u003c/p\u003e\n\t\t\u003c/section\u003e\n\t\u003c/section\u003e\n\u003c/main\u003e\n\u003caside\u003e\n\t\u003ch1\u003eやっていること\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/index.html\"\u003ePlan 9\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"http://web.me.com/lufia/alefcompiler/alef/\"\u003eAlefコンパイラを読む\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/aside\u003e\n\u003cfooter\u003e\n\t\u003cp\u003e見れない、表示がおかしい場合は、動作環境を添えて\u003ca href=\"mailto:webmaster@lufia.org\"\u003ewebmaster@lufia.org\u003c/a\u003eまで連絡ください。\u003c/p\u003e\n\u003c/footer\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/[[...slug]]","query":{"slug":["notes","2012","1006"]},"buildId":"uudkrhSA2meQW-38gm1fk","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>