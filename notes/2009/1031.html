<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>orange/note: AmaTunesツール</title><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="author" content="http://www.hatena.ne.jp/lufiabb/"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/1b15737708df434c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1b15737708df434c.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-c2e8b39087850489.js" defer=""></script><script src="/_next/static/chunks/main-7715c9ce3e92f40f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8e84d751e7e95936.js" defer=""></script><script src="/_next/static/chunks/245-02c6405e66663b10.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...slug%5D%5D-663c09fbf665935a.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_buildManifest.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_ssgManifest.js" defer=""></script></head><body><div id="__next">
<nav>
	<h1>メニュー</h1>
	<ul>
	<li><a href="/notes/index.html"><a>orange/note</a></a></li>
	<li><a href="/notes/pc.html"><a>PC関連</a></a></li>
	<li><a href="/notes/web.html"><a>web製作</a></a></li>
	<li><a href="/notes/sec.html"><a>セキュリティ</a></a></li>
	<li><a href="/notes/hobby.html"><a>本・ゲーム</a></a></li>
	<li><a href="/notes/junk.html"><a>ジャンク</a></a></li>
	</ul>
</nav>
<main>
	<p class="revision">2009年10月31日作成</p>
	<section>
		<h1>AmaTunesツール</h1>
		<p>1行に1つISBNを記述したファイルから、<a href="http://blogger.splhack.org/2007/10/amatunes.html">AmaTunes</a>に
		取り込むためのプログラムです。</p>
		<p>これはずいぶん前に<a href="http://journal.mycom.co.jp/news/2008/09/19/021/index.html">Books for Mac OS X</a>の
		データを移行させようとして作ったのですが、
		AmaTunes自体、数回しか使いませんでしたので、
		なんらかのバグが残っているのではないかと思います。</p>
		<pre><code>COCOA_APP_RESOURCES_DIR = File.dirname(File.expand_path(__FILE__))
resource_path = COCOA_APP_RESOURCES_DIR

$LOAD_PATH.reject! { |d| d.index(File.dirname(COCOA_APP_RESOURCES_DIR))!=0 }
$LOAD_PATH &lt;&lt; File.join(COCOA_APP_RESOURCES_DIR,&quot;ThirdParty&quot;)
$LOAD_PATH &lt;&lt; File.join(File.dirname(COCOA_APP_RESOURCES_DIR),&quot;lib&quot;)
$LOAD_PATH &lt;&lt; File.join(COCOA_APP_RESOURCES_DIR,&quot;RubyGems&quot;,&quot;gems&quot;,&quot;rb-appscript-0.4.0&quot;,&quot;lib&quot;)
$LOAD_PATH &lt;&lt; File.join(COCOA_APP_RESOURCES_DIR,&quot;RubyGems&quot;,&quot;gems&quot;,&quot;hpricot-0.6&quot;,&quot;lib&quot;)
$LOAD_PATH &lt;&lt; File.join(COCOA_APP_RESOURCES_DIR,&quot;RubyGems&quot;,&quot;gems&quot;,&quot;hpricot-0.6&quot;,&quot;ext&quot;,&quot;hpricot_scan&quot;)

$LOADED_FEATURES &lt;&lt; &quot;rubycocoa.bundle&quot;

ENV[&#x27;GEM_HOME&#x27;] = ENV[&#x27;GEM_PATH&#x27;] = File.join(COCOA_APP_RESOURCES_DIR,&quot;RubyGems&quot;)

#require &#x27;rubygems&#x27;
#require &#x27;osx/cocoa&#x27;
require &#x27;appscript&#x27;
require &#x27;open-uri&#x27;
require &#x27;fileutils&#x27;
$KCODE=&#x27;u&#x27;

require resource_path + &#x27;/ecs.rb&#x27;
$faac_path = resource_path + &quot;/../MacOS/lib&quot;

def conv_year(str)
	str =~ /^(\d\d\d\d).*/
	$1
end

def conv_artwork(str)
	filename = &quot;/tmp/amatunes.artwork&quot;
	@tmpfiles.push filename
	f = File.open(filename, &quot;wb&quot;)
	f.write open(str).read
	f.close
	filename
end

class MyBarcodeScannerDelegate
	def initialize
		@barcodes = Hash.new
		@lastcode = nil
	end
	def gotBarcode(barcode)
		barcode = barcode.to_s
		barcode = &#x27;0&#x27; + barcode if barcode.size == 12
		sum = 0
		mod = 1
		barcode.reverse.each_byte do |c|
			n = c - &#x27;0&#x27;[0]
			sum += n * mod 
			if mod == 1
				mod = 3
			else
				mod = 1
			end
		end
		sum %= 10
		return unless sum == 0
		return if @lastcode == barcode
		@lastcode = barcode
		if @barcodes[barcode].nil?
			Amazon::Ecs.options = {
				:aWS_access_key_id =&gt; &#x27;1N37DT5CJCZQKPZR7BG2&#x27;,
				:country =&gt; &#x27;jp&#x27;,
			}
			res = Amazon::Ecs.item_search(barcode, {:response_group =&gt; &#x27;Medium&#x27;})
			item = res.first_item
			return if item.nil?

			@tmpfiles = Array.new
			option = &quot;&quot;
			[
				[&quot;artist&quot;, &quot;author&quot;],
				[&quot;album&quot;, &quot;title&quot;],
				[&quot;title&quot;, &quot;title&quot;],
				[&quot;writer&quot;, &quot;manufacturer&quot;],
				[&quot;cover-art&quot;, &quot;largeimage/url&quot;, :conv_artwork],
				[&quot;year&quot;, &quot;publicationdate&quot;, :conv_year],
				[&quot;genre&quot;, &quot;productgroup&quot;],
			].each do |o|
				str = item.get(o[1]) 
				next if str.nil?
				option += &#x27; --&#x27; + o[0] + &#x27; &quot;&#x27; +
					(o[2].nil? ? str : send(o[2], str)) + &#x27;&quot;&#x27;
			end
			begin
				m4b = &quot;/tmp/#{barcode}.m4b&quot;
				@tmpfiles.push m4b
				system &quot;#{$faac_path}/faac128 #{option} -o #{m4b} #{$faac_path}/base.wav&quot;

				app = Appscript.app(&#x27;iTunes&#x27;)
				app.activate
				app.open MacTypes::Alias.path(m4b)
				app.stop

				#@tmpfiles.each {|file| FileUtils.rm file}
				@barcodes[barcode] = item

				$snd.play
			rescue
			end
		end
	end
end

while(s = gets)
	d = MyBarcodeScannerDelegate.new()
	d.gotBarcode(s.to_i)
end</code></pre>
		<section>
			<h2>遭遇したトラブル</h2>
			<section>
				<h3>require osx/cocoaが通らない</h3>
				<p>使わない方向で逃げました。</p>
			</section>
			<section>
				<h3>ThirdParty/open-uri.rb:require stringioが通らない</h3>
				<p>相対パスだと、reject!のマッチングで問題があったので、
				絶対パスに変換するよう修正して解決。</p>
			</section>
			<section>
				<h3>faacが落ちる</h3>
				<p>AmaTunesに付属のfaacは、/opt/local/以下から
				ライブラリをロードしようとして落ちていました。
				そこで、faacをコンパイルして、そちらを使いました。</p>
				<pre><code class="console">$ ./configure --disable-shared
$ make
$ mv frontend/faac $dir</code></pre>
			</section>
		</section>
	</section>
</main>
<aside>
	<h1>やっていること</h1>
	<ul>
	<li><a href="/plan9/index.html"><a>Plan 9</a></a></li>
	<li><a href="http://web.me.com/lufia/alefcompiler/alef/">Alefコンパイラを読む</a></li>
	</ul>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="/notes/2009/mailto:webmaster@lufia.org"><a>webmaster@lufia.org</a></a>まで連絡ください。</p>
</footer>
</div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"html":"\u003c!doctype html\u003e\n\u003chtml lang=\"ja\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003ctitle\u003eorange/note: AmaTunesツール\u003c/title\u003e\n\u003cmeta name=\"viewport\" content=\"width=device-width,initial-scale=1\"\u003e\n\u003cmeta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cnav\u003e\n\t\u003ch1\u003eメニュー\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/index.html\"\u003eorange/note\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/pc.html\"\u003ePC関連\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/web.html\"\u003eweb製作\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/sec.html\"\u003eセキュリティ\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/hobby.html\"\u003e本・ゲーム\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/junk.html\"\u003eジャンク\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/nav\u003e\n\u003cmain\u003e\n\t\u003cp class=\"revision\"\u003e2009年10月31日作成\u003c/p\u003e\n\t\u003csection\u003e\n\t\t\u003ch1\u003eAmaTunesツール\u003c/h1\u003e\n\t\t\u003cp\u003e1行に1つISBNを記述したファイルから、\u003ca href=\"http://blogger.splhack.org/2007/10/amatunes.html\"\u003eAmaTunes\u003c/a\u003eに\n\t\t取り込むためのプログラムです。\u003c/p\u003e\n\t\t\u003cp\u003eこれはずいぶん前に\u003ca href=\"http://journal.mycom.co.jp/news/2008/09/19/021/index.html\"\u003eBooks for Mac OS X\u003c/a\u003eの\n\t\tデータを移行させようとして作ったのですが、\n\t\tAmaTunes自体、数回しか使いませんでしたので、\n\t\tなんらかのバグが残っているのではないかと思います。\u003c/p\u003e\n\t\t\u003cpre\u003e\u003ccode\u003eCOCOA_APP_RESOURCES_DIR = File.dirname(File.expand_path(__FILE__))\nresource_path = COCOA_APP_RESOURCES_DIR\n\n$LOAD_PATH.reject! { |d| d.index(File.dirname(COCOA_APP_RESOURCES_DIR))!=0 }\n$LOAD_PATH \u0026lt;\u0026lt; File.join(COCOA_APP_RESOURCES_DIR,\u0026quot;ThirdParty\u0026quot;)\n$LOAD_PATH \u0026lt;\u0026lt; File.join(File.dirname(COCOA_APP_RESOURCES_DIR),\u0026quot;lib\u0026quot;)\n$LOAD_PATH \u0026lt;\u0026lt; File.join(COCOA_APP_RESOURCES_DIR,\u0026quot;RubyGems\u0026quot;,\u0026quot;gems\u0026quot;,\u0026quot;rb-appscript-0.4.0\u0026quot;,\u0026quot;lib\u0026quot;)\n$LOAD_PATH \u0026lt;\u0026lt; File.join(COCOA_APP_RESOURCES_DIR,\u0026quot;RubyGems\u0026quot;,\u0026quot;gems\u0026quot;,\u0026quot;hpricot-0.6\u0026quot;,\u0026quot;lib\u0026quot;)\n$LOAD_PATH \u0026lt;\u0026lt; File.join(COCOA_APP_RESOURCES_DIR,\u0026quot;RubyGems\u0026quot;,\u0026quot;gems\u0026quot;,\u0026quot;hpricot-0.6\u0026quot;,\u0026quot;ext\u0026quot;,\u0026quot;hpricot_scan\u0026quot;)\n\n$LOADED_FEATURES \u0026lt;\u0026lt; \u0026quot;rubycocoa.bundle\u0026quot;\n\nENV['GEM_HOME'] = ENV['GEM_PATH'] = File.join(COCOA_APP_RESOURCES_DIR,\u0026quot;RubyGems\u0026quot;)\n\n#require 'rubygems'\n#require 'osx/cocoa'\nrequire 'appscript'\nrequire 'open-uri'\nrequire 'fileutils'\n$KCODE='u'\n\nrequire resource_path + '/ecs.rb'\n$faac_path = resource_path + \u0026quot;/../MacOS/lib\u0026quot;\n\ndef conv_year(str)\n\tstr =~ /^(\\d\\d\\d\\d).*/\n\t$1\nend\n\ndef conv_artwork(str)\n\tfilename = \u0026quot;/tmp/amatunes.artwork\u0026quot;\n\t@tmpfiles.push filename\n\tf = File.open(filename, \u0026quot;wb\u0026quot;)\n\tf.write open(str).read\n\tf.close\n\tfilename\nend\n\nclass MyBarcodeScannerDelegate\n\tdef initialize\n\t\t@barcodes = Hash.new\n\t\t@lastcode = nil\n\tend\n\tdef gotBarcode(barcode)\n\t\tbarcode = barcode.to_s\n\t\tbarcode = '0' + barcode if barcode.size == 12\n\t\tsum = 0\n\t\tmod = 1\n\t\tbarcode.reverse.each_byte do |c|\n\t\t\tn = c - '0'[0]\n\t\t\tsum += n * mod \n\t\t\tif mod == 1\n\t\t\t\tmod = 3\n\t\t\telse\n\t\t\t\tmod = 1\n\t\t\tend\n\t\tend\n\t\tsum %= 10\n\t\treturn unless sum == 0\n\t\treturn if @lastcode == barcode\n\t\t@lastcode = barcode\n\t\tif @barcodes[barcode].nil?\n\t\t\tAmazon::Ecs.options = {\n\t\t\t\t:aWS_access_key_id =\u0026gt; '1N37DT5CJCZQKPZR7BG2',\n\t\t\t\t:country =\u0026gt; 'jp',\n\t\t\t}\n\t\t\tres = Amazon::Ecs.item_search(barcode, {:response_group =\u0026gt; 'Medium'})\n\t\t\titem = res.first_item\n\t\t\treturn if item.nil?\n\n\t\t\t@tmpfiles = Array.new\n\t\t\toption = \u0026quot;\u0026quot;\n\t\t\t[\n\t\t\t\t[\u0026quot;artist\u0026quot;, \u0026quot;author\u0026quot;],\n\t\t\t\t[\u0026quot;album\u0026quot;, \u0026quot;title\u0026quot;],\n\t\t\t\t[\u0026quot;title\u0026quot;, \u0026quot;title\u0026quot;],\n\t\t\t\t[\u0026quot;writer\u0026quot;, \u0026quot;manufacturer\u0026quot;],\n\t\t\t\t[\u0026quot;cover-art\u0026quot;, \u0026quot;largeimage/url\u0026quot;, :conv_artwork],\n\t\t\t\t[\u0026quot;year\u0026quot;, \u0026quot;publicationdate\u0026quot;, :conv_year],\n\t\t\t\t[\u0026quot;genre\u0026quot;, \u0026quot;productgroup\u0026quot;],\n\t\t\t].each do |o|\n\t\t\t\tstr = item.get(o[1]) \n\t\t\t\tnext if str.nil?\n\t\t\t\toption += ' --' + o[0] + ' \u0026quot;' +\n\t\t\t\t\t(o[2].nil? ? str : send(o[2], str)) + '\u0026quot;'\n\t\t\tend\n\t\t\tbegin\n\t\t\t\tm4b = \u0026quot;/tmp/#{barcode}.m4b\u0026quot;\n\t\t\t\t@tmpfiles.push m4b\n\t\t\t\tsystem \u0026quot;#{$faac_path}/faac128 #{option} -o #{m4b} #{$faac_path}/base.wav\u0026quot;\n\n\t\t\t\tapp = Appscript.app('iTunes')\n\t\t\t\tapp.activate\n\t\t\t\tapp.open MacTypes::Alias.path(m4b)\n\t\t\t\tapp.stop\n\n\t\t\t\t#@tmpfiles.each {|file| FileUtils.rm file}\n\t\t\t\t@barcodes[barcode] = item\n\n\t\t\t\t$snd.play\n\t\t\trescue\n\t\t\tend\n\t\tend\n\tend\nend\n\nwhile(s = gets)\n\td = MyBarcodeScannerDelegate.new()\n\td.gotBarcode(s.to_i)\nend\u003c/code\u003e\u003c/pre\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003e遭遇したトラブル\u003c/h2\u003e\n\t\t\t\u003csection\u003e\n\t\t\t\t\u003ch3\u003erequire osx/cocoaが通らない\u003c/h3\u003e\n\t\t\t\t\u003cp\u003e使わない方向で逃げました。\u003c/p\u003e\n\t\t\t\u003c/section\u003e\n\t\t\t\u003csection\u003e\n\t\t\t\t\u003ch3\u003eThirdParty/open-uri.rb:require stringioが通らない\u003c/h3\u003e\n\t\t\t\t\u003cp\u003e相対パスだと、reject!のマッチングで問題があったので、\n\t\t\t\t絶対パスに変換するよう修正して解決。\u003c/p\u003e\n\t\t\t\u003c/section\u003e\n\t\t\t\u003csection\u003e\n\t\t\t\t\u003ch3\u003efaacが落ちる\u003c/h3\u003e\n\t\t\t\t\u003cp\u003eAmaTunesに付属のfaacは、/opt/local/以下から\n\t\t\t\tライブラリをロードしようとして落ちていました。\n\t\t\t\tそこで、faacをコンパイルして、そちらを使いました。\u003c/p\u003e\n\t\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e$ ./configure --disable-shared\n$ make\n$ mv frontend/faac $dir\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003c/section\u003e\n\t\t\u003c/section\u003e\n\t\u003c/section\u003e\n\u003c/main\u003e\n\u003caside\u003e\n\t\u003ch1\u003eやっていること\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/index.html\"\u003ePlan 9\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"http://web.me.com/lufia/alefcompiler/alef/\"\u003eAlefコンパイラを読む\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/aside\u003e\n\u003cfooter\u003e\n\t\u003cp\u003e見れない、表示がおかしい場合は、動作環境を添えて\u003ca href=\"mailto:webmaster@lufia.org\"\u003ewebmaster@lufia.org\u003c/a\u003eまで連絡ください。\u003c/p\u003e\n\u003c/footer\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/[[...slug]]","query":{"slug":["notes","2009","1031"]},"buildId":"uudkrhSA2meQW-38gm1fk","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>