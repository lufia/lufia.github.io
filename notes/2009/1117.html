<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>orange/note: ルフィアノート再構築と/env</title><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="author" content="http://www.hatena.ne.jp/lufiabb/"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/1b15737708df434c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1b15737708df434c.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-c2e8b39087850489.js" defer=""></script><script src="/_next/static/chunks/main-7715c9ce3e92f40f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8e84d751e7e95936.js" defer=""></script><script src="/_next/static/chunks/245-02c6405e66663b10.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...slug%5D%5D-663c09fbf665935a.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_buildManifest.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_ssgManifest.js" defer=""></script></head><body><div id="__next">
<nav>
	<h1>メニュー</h1>
	<ul>
	<li><a href="/notes/index.html"><a>orange/note</a></a></li>
	<li><a href="/notes/pc.html"><a>PC関連</a></a></li>
	<li><a href="/notes/web.html"><a>web製作</a></a></li>
	<li><a href="/notes/sec.html"><a>セキュリティ</a></a></li>
	<li><a href="/notes/hobby.html"><a>本・ゲーム</a></a></li>
	<li><a href="/notes/junk.html"><a>ジャンク</a></a></li>
	</ul>
</nav>
<main>
	<p class="revision">2009年11月17日作成</p>
	<section>
		<h1>ルフィアノート再構築と/env</h1>
		<p>久しぶりに、<a href="/estpolis/index.html"><a>ルフィアノート</a></a>を更新しました。
		今までの作りでは、明らかな問題が2つと気になる点が1つ、
		あとやってみたいことが2つあったので、
		エストポリス新作発表によるモチベーション向上にあわせてリニューアル。</p>
		<section>
			<h2>問題点</h2>
			<section>
				<h3>JavaScript+XSLT</h3>
				<p>今まではJavaScript+XSLTで作っていたのですが、
				それだとOperaやSafariでは動きませんでした。
				どうやらSafariは、JavaScriptからXSLTパーサを呼び出すことが
				できないようなのですね。Operaはなんだったかな、忘れました。</p>
				<p>そんなわけで、これに依存しきっていたので、
				機能的な意味で使えないページになってしまっていました。
				また、<a href="/notes/2009/0706.html"><a>AJAXSLTも使ってみました</a></a>が、
				あれは使いこなせそうにありません。</p>
			</section>
			<section>
				<h3>文字コード未指定</h3>
				<p>XML宣言で文字コード指定していたので、
				metaタグはいらないだろうと思って書いていませんでしたが、
				たまに、IE6に限らずIE7でさえ真っ白になってしまうことがありました。
				文字コードを正しく選べば表示されますが、
				化けるのではなく真っ白なので、ふつう気づきません。</p>
			</section>
		</section>
		<section>
			<h2>気になる点</h2>
			<section>
				<h3>関連ファイル管理が複雑</h3>
				<p>これは内部的な問題ですが、元データファイル、
				データからXMLへの変換プログラム各種、ヘッダとフッタの共通部分、
				ふつうのHTMLファイル、ごちゃごちゃしたmkfile、
				それに加えてCSS、JavaScript、XSLT等、
				手間を減らすために作った環境が、かえってめんどくさくて
				更新する意欲を減らしていたように思います。
				新しいページを追加するには楽でいいのですが、
				全体的に手を入れようとすると気持ちが萎える状態。
				そこで、複雑なシステムは使われないの格言に従って、
				もっとシンプルな方法にしようと思いました。</p>
				<p>これは、シンプルすぎると管理が大変になるので、
				どこを自動化するか難しいところです。
				ほんとうはデータベース使うといいのでしょうけど、
				そうすると、マップに附属するメモのような、
				データ以外の文章をどのように扱うか悩みます。</p>
			</section>
		</section>
		<section>
			<h2>やってみたいこと</h2>
			<section>
				<h3>HTML5</h3>
				<p>記述がシンプルになるので、HTML5は気に入っています。
				XHTML2を待っていた方々からすれば不評かもしれませんが、
				<a href="http://mojix.org/2008/09/05/html_is_not_content">HTMLは表示のための言語</a>
				だと割り切れば、そんなに悪いものでもないのではないかなあ。</p>
			</section>
			<section>
				<h3>個々のアイテムごとにURL割り当て</h3>
				<p>今まではJavaScript+XSLTで処理していたので気にしませんでしたが、
				それが使えなくなってしまったので、個々のアイテムごとに
				URLを持たせたいなあ、と。</p>
				<pre><code>http://lufia.org/estpolis/item.html</code></pre>
				<p>このようにまとめるのではなく、以下のように。</p>
				<pre><code>http://lufia.org/estpolis/item/index.html
http://lufia.org/estpolis/item/potion.html</code></pre>
			</section>
		</section>
		<section>
			<h2>作ってみた結果</h2>
			<p>共通部分の取り込みだけ自動化して、
			あとはベタに書くようにしてみました。
			データに修正が入ったとき、ちょっと大変かなあと思いますが、
			ほとんど作っていたので、修正はあまりないだろうからいいかな。</p>
			<p>唯一困ったことといえば、Plan 9の環境変数は文字数制限があるようで、
			大量のファイルをmkで扱おうとするとエラーになってしまいました。</p>
			<p class="note">ちょうど<a href="http://groups.google.com/group/comp.os.plan9/browse_thread/thread/cdf5eb70b20c9354/693130a1eabf43e9">9fansでも話題にあがりました</a>ね。</p>
			<pre><code class="makefile">PAGE=`{ls */*.w}
TARG=${PAGE:%.w=%.html}

all:V: $TARG

...</code></pre>
			<p>このルールでmkすると。</p>
			<pre><code class="console">% mk
/env/TARG: read or write too large
/env/TARG: read or write too large
/env/TARG: read or write too large
...</code></pre>
			<p>しかたがないので分割することに。
			PAGEには全部のファイル名が含まれますが、
			TARGは.wで終わるものを.htmlに変換したファイル名のみになっています。</p>
			<pre><code class="makefile">PAGE=`{lspart $LSFLAGS $DB}
TARG=${PAGE:%.w=%.html}

world:V:
	mk $MKFLAGS all &#x27;DB=tale&#x27;
	for(p in `{seq 0 2})
		mk $MKFLAGS all &#x27;DB=stuff&#x27; &#x27;LSFLAGS=-D3 -P&#x27;$p

all:V: $TARG

...</code></pre>
			<p>mkfileで使っているlspartは以下のように。</p>
			<pre><code class="sh">#!/bin/rc
# support tool for mk

rfork e

lsflag=&#x27;d,l,m,n,p,q,r,s,t,u,F,Q,T&#x27;
flagfmt=$lsflag&#x27;,D div,P part&#x27;
args=&#x27;[file ...]&#x27;
if(! ifs=() eval `{aux/getflags $*}){
	aux/usage
	exit usage
}

ifs=, {x=`{echo $lsflag}}
for(f in $x){
	key=flag$f
	a=$$key
	if(! ~ $#a 0)
		opt=($opt $f)
}
if(! ~ $#opt 0)
	opt=-$&quot;opt
if(~ $#flagD 0)
	flagD=1
if(~ $#flagP 0)
	flagP=0

n=`{ls $opt $* | wc -l}
d=`{	echo &#x27;
	n = &#x27;$n/$flagD&#x27;
	m = int(n)
	if((n-m) &gt; 0.0) print m+1 else print n
	&#x27; | hoc
}
n=`{echo $flagP &#x27;*&#x27; $d + 1 | hoc}
t=`{echo $n + $d - 1 | hoc}
ls $opt $* | sed -n $n,$t^p</code></pre>
		</section>
	</section>
</main>
<aside>
	<h1>やっていること</h1>
	<ul>
	<li><a href="/plan9/index.html"><a>Plan 9</a></a></li>
	<li><a href="http://web.me.com/lufia/alefcompiler/alef/">Alefコンパイラを読む</a></li>
	</ul>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="/notes/2009/mailto:webmaster@lufia.org"><a>webmaster@lufia.org</a></a>まで連絡ください。</p>
</footer>
</div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"html":"\u003c!doctype html\u003e\n\u003chtml lang=\"ja\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003ctitle\u003eorange/note: ルフィアノート再構築と/env\u003c/title\u003e\n\u003cmeta name=\"viewport\" content=\"width=device-width,initial-scale=1\"\u003e\n\u003cmeta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cnav\u003e\n\t\u003ch1\u003eメニュー\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/index.html\"\u003eorange/note\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/pc.html\"\u003ePC関連\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/web.html\"\u003eweb製作\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/sec.html\"\u003eセキュリティ\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/hobby.html\"\u003e本・ゲーム\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/junk.html\"\u003eジャンク\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/nav\u003e\n\u003cmain\u003e\n\t\u003cp class=\"revision\"\u003e2009年11月17日作成\u003c/p\u003e\n\t\u003csection\u003e\n\t\t\u003ch1\u003eルフィアノート再構築と/env\u003c/h1\u003e\n\t\t\u003cp\u003e久しぶりに、\u003ca href=\"/estpolis/index.html\"\u003eルフィアノート\u003c/a\u003eを更新しました。\n\t\t今までの作りでは、明らかな問題が2つと気になる点が1つ、\n\t\tあとやってみたいことが2つあったので、\n\t\tエストポリス新作発表によるモチベーション向上にあわせてリニューアル。\u003c/p\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003e問題点\u003c/h2\u003e\n\t\t\t\u003csection\u003e\n\t\t\t\t\u003ch3\u003eJavaScript+XSLT\u003c/h3\u003e\n\t\t\t\t\u003cp\u003e今まではJavaScript+XSLTで作っていたのですが、\n\t\t\t\tそれだとOperaやSafariでは動きませんでした。\n\t\t\t\tどうやらSafariは、JavaScriptからXSLTパーサを呼び出すことが\n\t\t\t\tできないようなのですね。Operaはなんだったかな、忘れました。\u003c/p\u003e\n\t\t\t\t\u003cp\u003eそんなわけで、これに依存しきっていたので、\n\t\t\t\t機能的な意味で使えないページになってしまっていました。\n\t\t\t\tまた、\u003ca href=\"0706.html\"\u003eAJAXSLTも使ってみました\u003c/a\u003eが、\n\t\t\t\tあれは使いこなせそうにありません。\u003c/p\u003e\n\t\t\t\u003c/section\u003e\n\t\t\t\u003csection\u003e\n\t\t\t\t\u003ch3\u003e文字コード未指定\u003c/h3\u003e\n\t\t\t\t\u003cp\u003eXML宣言で文字コード指定していたので、\n\t\t\t\tmetaタグはいらないだろうと思って書いていませんでしたが、\n\t\t\t\tたまに、IE6に限らずIE7でさえ真っ白になってしまうことがありました。\n\t\t\t\t文字コードを正しく選べば表示されますが、\n\t\t\t\t化けるのではなく真っ白なので、ふつう気づきません。\u003c/p\u003e\n\t\t\t\u003c/section\u003e\n\t\t\u003c/section\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003e気になる点\u003c/h2\u003e\n\t\t\t\u003csection\u003e\n\t\t\t\t\u003ch3\u003e関連ファイル管理が複雑\u003c/h3\u003e\n\t\t\t\t\u003cp\u003eこれは内部的な問題ですが、元データファイル、\n\t\t\t\tデータからXMLへの変換プログラム各種、ヘッダとフッタの共通部分、\n\t\t\t\tふつうのHTMLファイル、ごちゃごちゃしたmkfile、\n\t\t\t\tそれに加えてCSS、JavaScript、XSLT等、\n\t\t\t\t手間を減らすために作った環境が、かえってめんどくさくて\n\t\t\t\t更新する意欲を減らしていたように思います。\n\t\t\t\t新しいページを追加するには楽でいいのですが、\n\t\t\t\t全体的に手を入れようとすると気持ちが萎える状態。\n\t\t\t\tそこで、複雑なシステムは使われないの格言に従って、\n\t\t\t\tもっとシンプルな方法にしようと思いました。\u003c/p\u003e\n\t\t\t\t\u003cp\u003eこれは、シンプルすぎると管理が大変になるので、\n\t\t\t\tどこを自動化するか難しいところです。\n\t\t\t\tほんとうはデータベース使うといいのでしょうけど、\n\t\t\t\tそうすると、マップに附属するメモのような、\n\t\t\t\tデータ以外の文章をどのように扱うか悩みます。\u003c/p\u003e\n\t\t\t\u003c/section\u003e\n\t\t\u003c/section\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003eやってみたいこと\u003c/h2\u003e\n\t\t\t\u003csection\u003e\n\t\t\t\t\u003ch3\u003eHTML5\u003c/h3\u003e\n\t\t\t\t\u003cp\u003e記述がシンプルになるので、HTML5は気に入っています。\n\t\t\t\tXHTML2を待っていた方々からすれば不評かもしれませんが、\n\t\t\t\t\u003ca href=\"http://mojix.org/2008/09/05/html_is_not_content\"\u003eHTMLは表示のための言語\u003c/a\u003e\n\t\t\t\tだと割り切れば、そんなに悪いものでもないのではないかなあ。\u003c/p\u003e\n\t\t\t\u003c/section\u003e\n\t\t\t\u003csection\u003e\n\t\t\t\t\u003ch3\u003e個々のアイテムごとにURL割り当て\u003c/h3\u003e\n\t\t\t\t\u003cp\u003e今まではJavaScript+XSLTで処理していたので気にしませんでしたが、\n\t\t\t\tそれが使えなくなってしまったので、個々のアイテムごとに\n\t\t\t\tURLを持たせたいなあ、と。\u003c/p\u003e\n\t\t\t\t\u003cpre\u003e\u003ccode\u003ehttp://lufia.org/estpolis/item.html\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\t\u003cp\u003eこのようにまとめるのではなく、以下のように。\u003c/p\u003e\n\t\t\t\t\u003cpre\u003e\u003ccode\u003ehttp://lufia.org/estpolis/item/index.html\nhttp://lufia.org/estpolis/item/potion.html\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003c/section\u003e\n\t\t\u003c/section\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003e作ってみた結果\u003c/h2\u003e\n\t\t\t\u003cp\u003e共通部分の取り込みだけ自動化して、\n\t\t\tあとはベタに書くようにしてみました。\n\t\t\tデータに修正が入ったとき、ちょっと大変かなあと思いますが、\n\t\t\tほとんど作っていたので、修正はあまりないだろうからいいかな。\u003c/p\u003e\n\t\t\t\u003cp\u003e唯一困ったことといえば、Plan 9の環境変数は文字数制限があるようで、\n\t\t\t大量のファイルをmkで扱おうとするとエラーになってしまいました。\u003c/p\u003e\n\t\t\t\u003cp class=\"note\"\u003eちょうど\u003ca href=\"http://groups.google.com/group/comp.os.plan9/browse_thread/thread/cdf5eb70b20c9354/693130a1eabf43e9\"\u003e9fansでも話題にあがりました\u003c/a\u003eね。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"makefile\"\u003ePAGE=`{ls */*.w}\nTARG=${PAGE:%.w=%.html}\n\nall:V: $TARG\n\n...\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003cp\u003eこのルールでmkすると。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e% mk\n/env/TARG: read or write too large\n/env/TARG: read or write too large\n/env/TARG: read or write too large\n...\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003cp\u003eしかたがないので分割することに。\n\t\t\tPAGEには全部のファイル名が含まれますが、\n\t\t\tTARGは.wで終わるものを.htmlに変換したファイル名のみになっています。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"makefile\"\u003ePAGE=`{lspart $LSFLAGS $DB}\nTARG=${PAGE:%.w=%.html}\n\nworld:V:\n\tmk $MKFLAGS all 'DB=tale'\n\tfor(p in `{seq 0 2})\n\t\tmk $MKFLAGS all 'DB=stuff' 'LSFLAGS=-D3 -P'$p\n\nall:V: $TARG\n\n...\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003cp\u003emkfileで使っているlspartは以下のように。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"sh\"\u003e#!/bin/rc\n# support tool for mk\n\nrfork e\n\nlsflag='d,l,m,n,p,q,r,s,t,u,F,Q,T'\nflagfmt=$lsflag',D div,P part'\nargs='[file ...]'\nif(! ifs=() eval `{aux/getflags $*}){\n\taux/usage\n\texit usage\n}\n\nifs=, {x=`{echo $lsflag}}\nfor(f in $x){\n\tkey=flag$f\n\ta=$$key\n\tif(! ~ $#a 0)\n\t\topt=($opt $f)\n}\nif(! ~ $#opt 0)\n\topt=-$\u0026quot;opt\nif(~ $#flagD 0)\n\tflagD=1\nif(~ $#flagP 0)\n\tflagP=0\n\nn=`{ls $opt $* | wc -l}\nd=`{\techo '\n\tn = '$n/$flagD'\n\tm = int(n)\n\tif((n-m) \u0026gt; 0.0) print m+1 else print n\n\t' | hoc\n}\nn=`{echo $flagP '*' $d + 1 | hoc}\nt=`{echo $n + $d - 1 | hoc}\nls $opt $* | sed -n $n,$t^p\u003c/code\u003e\u003c/pre\u003e\n\t\t\u003c/section\u003e\n\t\u003c/section\u003e\n\u003c/main\u003e\n\u003caside\u003e\n\t\u003ch1\u003eやっていること\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/index.html\"\u003ePlan 9\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"http://web.me.com/lufia/alefcompiler/alef/\"\u003eAlefコンパイラを読む\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/aside\u003e\n\u003cfooter\u003e\n\t\u003cp\u003e見れない、表示がおかしい場合は、動作環境を添えて\u003ca href=\"mailto:webmaster@lufia.org\"\u003ewebmaster@lufia.org\u003c/a\u003eまで連絡ください。\u003c/p\u003e\n\u003c/footer\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/[[...slug]]","query":{"slug":["notes","2009","1117"]},"buildId":"uudkrhSA2meQW-38gm1fk","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>