<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>orange/note: Inferno httpdとマルチバイト</title><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="author" content="http://www.hatena.ne.jp/lufiabb/"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/1b15737708df434c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1b15737708df434c.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-c2e8b39087850489.js" defer=""></script><script src="/_next/static/chunks/main-7715c9ce3e92f40f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8e84d751e7e95936.js" defer=""></script><script src="/_next/static/chunks/245-02c6405e66663b10.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...slug%5D%5D-663c09fbf665935a.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_buildManifest.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_ssgManifest.js" defer=""></script></head><body><div id="__next">
<nav>
	<h1>メニュー</h1>
	<ul>
	<li><a href="/notes/index.html"><a>orange/note</a></a></li>
	<li><a href="/notes/pc.html"><a>PC関連</a></a></li>
	<li><a href="/notes/web.html"><a>web製作</a></a></li>
	<li><a href="/notes/sec.html"><a>セキュリティ</a></a></li>
	<li><a href="/notes/hobby.html"><a>本・ゲーム</a></a></li>
	<li><a href="/notes/junk.html"><a>ジャンク</a></a></li>
	</ul>
</nav>
<main>
	<p class="revision">2011年5月14日更新</p>
	<section>
		<h1>Inferno httpdとマルチバイト</h1>
		<p class="note">2011年5月14日現在、公式に対応されましたので、
		この記事は不要です。</p>
		<p>Inferno Wikiのための前準備。
		マルチバイトファイル名を参照すると化けていたので、
		httpdを2点ほど修正しました。</p>
		<p>まずは、parse.b:urlunesc。
		終わりのほうにちょっと追加しただけですね。</p>
		<pre><code class="c">urlunesc(s : string): string
{
	c, n : int;
	u := 0;
	buf := array[2] of byte;
	for(i := 0;i&lt;len s ; i++){
		c = int s[i];
		if(c == &#x27;%&#x27;){
			n = int s[i+1];
			if(n &gt;= &#x27;0&#x27; &amp;&amp; n &lt;= &#x27;9&#x27;)
				n = n - &#x27;0&#x27;;
			else if(n &gt;= &#x27;A&#x27; &amp;&amp; n &lt;= &#x27;F&#x27;)
				n = n - &#x27;A&#x27; + 10;
			else if(n &gt;= &#x27;a&#x27; &amp;&amp; n &lt;= &#x27;f&#x27;)
				n = n - &#x27;a&#x27; + 10;
			else
				break;
			c = n;
			n = int s[i+2];
			if(n &gt;= &#x27;0&#x27; &amp;&amp; n &lt;= &#x27;9&#x27;)
				n = n - &#x27;0&#x27;;
			else if(n &gt;= &#x27;A&#x27; &amp;&amp; n &lt;= &#x27;F&#x27;)
				n = n - &#x27;A&#x27; + 10;
			else if(n &gt;= &#x27;a&#x27; &amp;&amp; n &lt;= &#x27;f&#x27;)
				n = n - &#x27;a&#x27; + 10;
			else
				break;
			i += 2;
			c = c * 16 + n;
		}
		else if( c == &#x27;+&#x27; )
			c = &#x27; &#x27;;
		if(u &gt;= len buf){
			b := array[len buf*2] of byte;
			b[0:] = buf[0:];
			buf = b;
		}
		buf[u++] = byte c;
	}
	return string array of byte buf[0:u];
}</code></pre>
		<p>続けてparse.b:urlconv。</p>
		<pre><code class="c">urlesc(c : int): string
{
	s, t : string;
	s[0] = c;
	buf := array of byte s;
	for(i:=0;i&lt;len buf ;i++)
		t += sys-&gt;sprint(&quot;%%%2.2x&quot;, int buf[i]);
	return t;
}

urlconv(p : string): string
{
	c : int;
	t : string;
	for(i:=0;i&lt;len p ;i++){
		c = p[i];
		if(c == 0)
			break;
		if(c &lt;= &#x27; &#x27; || c == &#x27;%&#x27; || c &gt;= Runeself){
			t += urlesc(c);
		} else {
			t[len t] = c;
		}
	}
	return t; 
}</code></pre>
		<p>あとはふつうに。</p>
		<pre><code class="console">% mk &amp;&amp; mk install</code></pre>
		<p class="note">svc/httpdに-Dオプションを与えると、/services/httpd以下に
		詳細なログを書き出します。問題解決にとても役立ちます。</p>
	</section>
</main>
<aside>
	<h1>やっていること</h1>
	<ul>
	<li><a href="/plan9/index.html"><a>Plan 9</a></a></li>
	<li><a href="http://web.me.com/lufia/alefcompiler/alef/">Alefコンパイラを読む</a></li>
	</ul>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="/notes/2010/mailto:webmaster@lufia.org"><a>webmaster@lufia.org</a></a>まで連絡ください。</p>
</footer>
</div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"html":"\u003c!doctype html\u003e\n\u003chtml lang=\"ja\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003ctitle\u003eorange/note: Inferno httpdとマルチバイト\u003c/title\u003e\n\u003cmeta name=\"viewport\" content=\"width=device-width,initial-scale=1\"\u003e\n\u003cmeta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cnav\u003e\n\t\u003ch1\u003eメニュー\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/index.html\"\u003eorange/note\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/pc.html\"\u003ePC関連\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/web.html\"\u003eweb製作\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/sec.html\"\u003eセキュリティ\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/hobby.html\"\u003e本・ゲーム\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/junk.html\"\u003eジャンク\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/nav\u003e\n\u003cmain\u003e\n\t\u003cp class=\"revision\"\u003e2011年5月14日更新\u003c/p\u003e\n\t\u003csection\u003e\n\t\t\u003ch1\u003eInferno httpdとマルチバイト\u003c/h1\u003e\n\t\t\u003cp class=\"note\"\u003e2011年5月14日現在、公式に対応されましたので、\n\t\tこの記事は不要です。\u003c/p\u003e\n\t\t\u003cp\u003eInferno Wikiのための前準備。\n\t\tマルチバイトファイル名を参照すると化けていたので、\n\t\thttpdを2点ほど修正しました。\u003c/p\u003e\n\t\t\u003cp\u003eまずは、parse.b:urlunesc。\n\t\t終わりのほうにちょっと追加しただけですね。\u003c/p\u003e\n\t\t\u003cpre\u003e\u003ccode class=\"c\"\u003eurlunesc(s : string): string\n{\n\tc, n : int;\n\tu := 0;\n\tbuf := array[2] of byte;\n\tfor(i := 0;i\u0026lt;len s ; i++){\n\t\tc = int s[i];\n\t\tif(c == '%'){\n\t\t\tn = int s[i+1];\n\t\t\tif(n \u0026gt;= '0' \u0026amp;\u0026amp; n \u0026lt;= '9')\n\t\t\t\tn = n - '0';\n\t\t\telse if(n \u0026gt;= 'A' \u0026amp;\u0026amp; n \u0026lt;= 'F')\n\t\t\t\tn = n - 'A' + 10;\n\t\t\telse if(n \u0026gt;= 'a' \u0026amp;\u0026amp; n \u0026lt;= 'f')\n\t\t\t\tn = n - 'a' + 10;\n\t\t\telse\n\t\t\t\tbreak;\n\t\t\tc = n;\n\t\t\tn = int s[i+2];\n\t\t\tif(n \u0026gt;= '0' \u0026amp;\u0026amp; n \u0026lt;= '9')\n\t\t\t\tn = n - '0';\n\t\t\telse if(n \u0026gt;= 'A' \u0026amp;\u0026amp; n \u0026lt;= 'F')\n\t\t\t\tn = n - 'A' + 10;\n\t\t\telse if(n \u0026gt;= 'a' \u0026amp;\u0026amp; n \u0026lt;= 'f')\n\t\t\t\tn = n - 'a' + 10;\n\t\t\telse\n\t\t\t\tbreak;\n\t\t\ti += 2;\n\t\t\tc = c * 16 + n;\n\t\t}\n\t\telse if( c == '+' )\n\t\t\tc = ' ';\n\t\tif(u \u0026gt;= len buf){\n\t\t\tb := array[len buf*2] of byte;\n\t\t\tb[0:] = buf[0:];\n\t\t\tbuf = b;\n\t\t}\n\t\tbuf[u++] = byte c;\n\t}\n\treturn string array of byte buf[0:u];\n}\u003c/code\u003e\u003c/pre\u003e\n\t\t\u003cp\u003e続けてparse.b:urlconv。\u003c/p\u003e\n\t\t\u003cpre\u003e\u003ccode class=\"c\"\u003eurlesc(c : int): string\n{\n\ts, t : string;\n\ts[0] = c;\n\tbuf := array of byte s;\n\tfor(i:=0;i\u0026lt;len buf ;i++)\n\t\tt += sys-\u0026gt;sprint(\u0026quot;%%%2.2x\u0026quot;, int buf[i]);\n\treturn t;\n}\n\nurlconv(p : string): string\n{\n\tc : int;\n\tt : string;\n\tfor(i:=0;i\u0026lt;len p ;i++){\n\t\tc = p[i];\n\t\tif(c == 0)\n\t\t\tbreak;\n\t\tif(c \u0026lt;= ' ' || c == '%' || c \u0026gt;= Runeself){\n\t\t\tt += urlesc(c);\n\t\t} else {\n\t\t\tt[len t] = c;\n\t\t}\n\t}\n\treturn t; \n}\u003c/code\u003e\u003c/pre\u003e\n\t\t\u003cp\u003eあとはふつうに。\u003c/p\u003e\n\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e% mk \u0026amp;\u0026amp; mk install\u003c/code\u003e\u003c/pre\u003e\n\t\t\u003cp class=\"note\"\u003esvc/httpdに-Dオプションを与えると、/services/httpd以下に\n\t\t詳細なログを書き出します。問題解決にとても役立ちます。\u003c/p\u003e\n\t\u003c/section\u003e\n\u003c/main\u003e\n\u003caside\u003e\n\t\u003ch1\u003eやっていること\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/index.html\"\u003ePlan 9\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"http://web.me.com/lufia/alefcompiler/alef/\"\u003eAlefコンパイラを読む\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/aside\u003e\n\u003cfooter\u003e\n\t\u003cp\u003e見れない、表示がおかしい場合は、動作環境を添えて\u003ca href=\"mailto:webmaster@lufia.org\"\u003ewebmaster@lufia.org\u003c/a\u003eまで連絡ください。\u003c/p\u003e\n\u003c/footer\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/[[...slug]]","query":{"slug":["notes","2010","0420"]},"buildId":"uudkrhSA2meQW-38gm1fk","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>