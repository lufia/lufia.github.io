<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>orange/note: バンドデータ処理プログラム</title><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="author" content="http://www.hatena.ne.jp/lufiabb/"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/1b15737708df434c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1b15737708df434c.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-c2e8b39087850489.js" defer=""></script><script src="/_next/static/chunks/main-7715c9ce3e92f40f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8e84d751e7e95936.js" defer=""></script><script src="/_next/static/chunks/245-02c6405e66663b10.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...slug%5D%5D-663c09fbf665935a.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_buildManifest.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_ssgManifest.js" defer=""></script></head><body><div id="__next">
<nav>
	<h1>メニュー</h1>
	<ul>
	<li><a href="/notes/index.html"><a>orange/note</a></a></li>
	<li><a href="/notes/pc.html"><a>PC関連</a></a></li>
	<li><a href="/notes/web.html"><a>web製作</a></a></li>
	<li><a href="/notes/sec.html"><a>セキュリティ</a></a></li>
	<li><a href="/notes/hobby.html"><a>本・ゲーム</a></a></li>
	<li><a href="/notes/junk.html"><a>ジャンク</a></a></li>
	</ul>
</nav>
<main>
	<p class="revision">2009年9月30日更新</p>
	<section>
		<h1>バンドデータ処理プログラム</h1>
		<p><a href="http://blog.nizah.net/nb/2007/12/13/band-code.html">Nizah Blogのお題</a>を
		Limboで解いてみました。</p>
		<p>タプルと配列スライスが使えるから少し便利ですが、
		それ以外は、ほとんどCになってしまいました。。</p>
		<p>それから、ソートが言語に含まれなくて、関数ポインタを渡す方法が
		分からなかったので、ソートの比較はいっぱい無理してます。
		単純にYear: con 0;とかでもよかったけどね。</p>
		<pre><code class="c">implement Band;

include &quot;sys.m&quot;;
	sys: Sys;
	print: import sys;
include &quot;draw.m&quot;;
include &quot;string.m&quot;;
	str: String;

Band: module
{
	init: fn(ctxt: ref Draw-&gt;Context, argv: list of string);
};

Order: adt {
	pick {
	Year or Name =&gt;
	}
};

init(nil: ref Draw-&gt;Context, nil: list of string)
{
	sys = load Sys Sys-&gt;PATH;
	str = load String String-&gt;PATH;
	name := array[] of { &quot;The Beatles&quot;, &quot;KRAFTWERK&quot;, &quot;Queen&quot;, &quot;B&#x27;z&quot;, &quot;ThE Foo Bar&quot; };
	year := array[] of { 60, 1970, 70, 88, 2007 };
	country := array[] of { &quot;UK&quot;, &quot;DE&quot;, &quot;UK&quot;, &quot;JP&quot;, &quot;US&quot; };

	# ex 1
	band := array[len name] of (string, int, string);
	for(i := 0; i &lt; len name; i++)
		band[i] = (name[i], year[i], country[i]);

	# ex 2
	band2 := array[len band] of (string, int, string);
	band2[0:] = band;
	sort(band2, len band2, ref Order.Year);
	for(i = 0; i &lt; len band2; i++){
		(b1, b2, b3) := band2[i];
		print(&quot;%s,%d,%s\n&quot;, b1, b2, b3);
	}

	# ex 3
	sorted_band := array[len band] of (string, int, string);
	sorted_band[0:] = band;
	sort(sorted_band, len sorted_band, ref Order.Name);

	# ex 4
	print(&quot;\n&quot;);
	for(i = 0; i &lt; len sorted_band; i++){
		(b1, b2, b3) := correct(sorted_band[i]);
		the := &quot;&quot;;
		if(str-&gt;tolower(b1[0:3]) == &quot;the&quot;){
			the = &quot;(&quot; + b1[0:3] + &quot;)&quot;;
			b1 = b1[4:];
		}
		print(&quot;%-6s%-15s%d %s\n&quot;, the, b1, b2, b3);
	}
}

sort(a: array of (string, int, string), r: int, order: ref Order)
{
	sort1(a, array[len a] of (string, int, string), r, order);
}

sort1(a, b: array of (string, int, string), r: int, order: ref Order)
{
	if(r &gt; 1){
		m := (r-1)/2 + 1;
		sort1(a[0:m], b[0:m], m, order);
		sort1(a[m:r], b[m:r], r-m, order);
		b[0:] = a[0:r];
		for((i, j, k) := (0, m, 0); i &lt; m &amp;&amp; j &lt; r; k++){
			cmp: int;
			pick c := order {
			Year =&gt;
				cmp = yearcmp(b[i], b[j]);
			Name =&gt;
				cmp = namecmp(b[i], b[j]);
			* =&gt;
				raise &quot;fail:order&quot;;
			}
			if(cmp &gt; 0)
				a[k] = b[j++];
			else
				a[k] = b[i++];
		}
		if(i &lt; m)
			a[k:] = b[i:m];
		else if(j &lt; r)
			a[k:] = b[j:r];
	}
}

yearcmp(b1: (string, int, string), b2: (string, int, string)): int
{
	(nil, y1, c1) := correct(b1);
	(nil, y2, c2) := correct(b2);
	if(y1 &gt; y2)
		return 1;
	else if(y1 &lt; y2)
		return -1;

	if(c1 &gt; c2)
		return 1;
	else if(c1 == c2)
		return 0;
	else
		return -1;
}

namecmp(b1: (string, int, string), b2: (string, int, string)): int
{
	name1 := namei(b1);
	name2 := namei(b2);
	if(name1 &gt; name2)
		return 1;
	else if(name1 == name2)
		return 0;
	else
		return -1;
}

correct(band: (string, int, string)): (string, int, string)
{
	(name, year, country) := band;
	if(year &lt; 100)
		year += 1900;
	return (name, year, country);
}

namei(band: (string, int, string)): string
{
	(name, nil, nil) := band;
	name = str-&gt;tolower(name);
	if(name[0:3] == &quot;the&quot;)
		name = name[4:];
	return name;
}</code></pre>
		<p>2文字以下のバンド名(&quot;X&quot;など)が初期データにあると落ちる。
		theの判定のところでname[0:3]が配列境界を越えるから。</p>
		<section>
			<h2>2009年9月30日追記</h2>
			<p>関数ポインタは、ref fn()のように書くと渡せる。</p>
			<pre><code class="c">implement Fn;

include &quot;sys.m&quot;;
	sys: Sys;
include &quot;draw.m&quot;;

Fn: module
{
	init: fn(ctxt: ref Draw-&gt;Context, argv: list of string);
};

Int: adt
{
	n: int;
};

init(nil: ref Draw-&gt;Context, nil: list of string)
{
	sys = load Sys Sys-&gt;PATH;

	A1 := array[] of { &quot;a1&quot;, &quot;b2&quot;, &quot;c3&quot; };
	A2 := array[] of { ref Int(1), ref Int(2), ref Int(3) };

	apply(A1, printstring);
	apply(A2, printint);
}

apply[T](a: array of T, f: ref fn(p: T))
{
	for(i := 0; i &lt; len a; i++)
		f(a[i]);
}

printint(n: ref Int)
{
	sys-&gt;print(&quot;%d\n&quot;, n.n);
}

printstring(s: string)
{
	sys-&gt;print(&quot;%s\n&quot;, s);
}</code></pre>
			<p>qsortの比較関数プロトタイプなど、Cでvoid*を使う状況では、
			パラメトリック多相型というものが同じような目的に使える。
			上記の例でいえば、apply関数で使っているT型。
			これは、ref型しか扱えない(型の解決ができない)という制限があるので、
			intを直接扱うといったことはできない。</p>
		</section>
	</section>
</main>
<aside>
	<h1>参考サイト</h1>
	<ul>
	<li><a href="http://alohakun.blog7.fc2.com/blog-entry-730.html">Limboのパラメトリック多相</a></li>
	</ul>
</aside>
<aside>
	<h1>やっていること</h1>
	<ul>
	<li><a href="/plan9/index.html"><a>Plan 9</a></a></li>
	<li><a href="http://web.me.com/lufia/alefcompiler/alef/">Alefコンパイラを読む</a></li>
	</ul>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="/notes/2007/mailto:webmaster@lufia.org"><a>webmaster@lufia.org</a></a>まで連絡ください。</p>
</footer>
</div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"html":"\u003c!doctype html\u003e\n\u003chtml lang=\"ja\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003ctitle\u003eorange/note: バンドデータ処理プログラム\u003c/title\u003e\n\u003cmeta name=\"viewport\" content=\"width=device-width,initial-scale=1\"\u003e\n\u003cmeta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cnav\u003e\n\t\u003ch1\u003eメニュー\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/index.html\"\u003eorange/note\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/pc.html\"\u003ePC関連\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/web.html\"\u003eweb製作\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/sec.html\"\u003eセキュリティ\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/hobby.html\"\u003e本・ゲーム\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/notes/junk.html\"\u003eジャンク\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/nav\u003e\n\u003cmain\u003e\n\t\u003cp class=\"revision\"\u003e2009年9月30日更新\u003c/p\u003e\n\t\u003csection\u003e\n\t\t\u003ch1\u003eバンドデータ処理プログラム\u003c/h1\u003e\n\t\t\u003cp\u003e\u003ca href=\"http://blog.nizah.net/nb/2007/12/13/band-code.html\"\u003eNizah Blogのお題\u003c/a\u003eを\n\t\tLimboで解いてみました。\u003c/p\u003e\n\t\t\u003cp\u003eタプルと配列スライスが使えるから少し便利ですが、\n\t\tそれ以外は、ほとんどCになってしまいました。。\u003c/p\u003e\n\t\t\u003cp\u003eそれから、ソートが言語に含まれなくて、関数ポインタを渡す方法が\n\t\t分からなかったので、ソートの比較はいっぱい無理してます。\n\t\t単純にYear: con 0;とかでもよかったけどね。\u003c/p\u003e\n\t\t\u003cpre\u003e\u003ccode class=\"c\"\u003eimplement Band;\n\ninclude \u0026quot;sys.m\u0026quot;;\n\tsys: Sys;\n\tprint: import sys;\ninclude \u0026quot;draw.m\u0026quot;;\ninclude \u0026quot;string.m\u0026quot;;\n\tstr: String;\n\nBand: module\n{\n\tinit: fn(ctxt: ref Draw-\u0026gt;Context, argv: list of string);\n};\n\nOrder: adt {\n\tpick {\n\tYear or Name =\u0026gt;\n\t}\n};\n\ninit(nil: ref Draw-\u0026gt;Context, nil: list of string)\n{\n\tsys = load Sys Sys-\u0026gt;PATH;\n\tstr = load String String-\u0026gt;PATH;\n\tname := array[] of { \u0026quot;The Beatles\u0026quot;, \u0026quot;KRAFTWERK\u0026quot;, \u0026quot;Queen\u0026quot;, \u0026quot;B'z\u0026quot;, \u0026quot;ThE Foo Bar\u0026quot; };\n\tyear := array[] of { 60, 1970, 70, 88, 2007 };\n\tcountry := array[] of { \u0026quot;UK\u0026quot;, \u0026quot;DE\u0026quot;, \u0026quot;UK\u0026quot;, \u0026quot;JP\u0026quot;, \u0026quot;US\u0026quot; };\n\n\t# ex 1\n\tband := array[len name] of (string, int, string);\n\tfor(i := 0; i \u0026lt; len name; i++)\n\t\tband[i] = (name[i], year[i], country[i]);\n\n\t# ex 2\n\tband2 := array[len band] of (string, int, string);\n\tband2[0:] = band;\n\tsort(band2, len band2, ref Order.Year);\n\tfor(i = 0; i \u0026lt; len band2; i++){\n\t\t(b1, b2, b3) := band2[i];\n\t\tprint(\u0026quot;%s,%d,%s\\n\u0026quot;, b1, b2, b3);\n\t}\n\n\t# ex 3\n\tsorted_band := array[len band] of (string, int, string);\n\tsorted_band[0:] = band;\n\tsort(sorted_band, len sorted_band, ref Order.Name);\n\n\t# ex 4\n\tprint(\u0026quot;\\n\u0026quot;);\n\tfor(i = 0; i \u0026lt; len sorted_band; i++){\n\t\t(b1, b2, b3) := correct(sorted_band[i]);\n\t\tthe := \u0026quot;\u0026quot;;\n\t\tif(str-\u0026gt;tolower(b1[0:3]) == \u0026quot;the\u0026quot;){\n\t\t\tthe = \u0026quot;(\u0026quot; + b1[0:3] + \u0026quot;)\u0026quot;;\n\t\t\tb1 = b1[4:];\n\t\t}\n\t\tprint(\u0026quot;%-6s%-15s%d %s\\n\u0026quot;, the, b1, b2, b3);\n\t}\n}\n\nsort(a: array of (string, int, string), r: int, order: ref Order)\n{\n\tsort1(a, array[len a] of (string, int, string), r, order);\n}\n\nsort1(a, b: array of (string, int, string), r: int, order: ref Order)\n{\n\tif(r \u0026gt; 1){\n\t\tm := (r-1)/2 + 1;\n\t\tsort1(a[0:m], b[0:m], m, order);\n\t\tsort1(a[m:r], b[m:r], r-m, order);\n\t\tb[0:] = a[0:r];\n\t\tfor((i, j, k) := (0, m, 0); i \u0026lt; m \u0026amp;\u0026amp; j \u0026lt; r; k++){\n\t\t\tcmp: int;\n\t\t\tpick c := order {\n\t\t\tYear =\u0026gt;\n\t\t\t\tcmp = yearcmp(b[i], b[j]);\n\t\t\tName =\u0026gt;\n\t\t\t\tcmp = namecmp(b[i], b[j]);\n\t\t\t* =\u0026gt;\n\t\t\t\traise \u0026quot;fail:order\u0026quot;;\n\t\t\t}\n\t\t\tif(cmp \u0026gt; 0)\n\t\t\t\ta[k] = b[j++];\n\t\t\telse\n\t\t\t\ta[k] = b[i++];\n\t\t}\n\t\tif(i \u0026lt; m)\n\t\t\ta[k:] = b[i:m];\n\t\telse if(j \u0026lt; r)\n\t\t\ta[k:] = b[j:r];\n\t}\n}\n\nyearcmp(b1: (string, int, string), b2: (string, int, string)): int\n{\n\t(nil, y1, c1) := correct(b1);\n\t(nil, y2, c2) := correct(b2);\n\tif(y1 \u0026gt; y2)\n\t\treturn 1;\n\telse if(y1 \u0026lt; y2)\n\t\treturn -1;\n\n\tif(c1 \u0026gt; c2)\n\t\treturn 1;\n\telse if(c1 == c2)\n\t\treturn 0;\n\telse\n\t\treturn -1;\n}\n\nnamecmp(b1: (string, int, string), b2: (string, int, string)): int\n{\n\tname1 := namei(b1);\n\tname2 := namei(b2);\n\tif(name1 \u0026gt; name2)\n\t\treturn 1;\n\telse if(name1 == name2)\n\t\treturn 0;\n\telse\n\t\treturn -1;\n}\n\ncorrect(band: (string, int, string)): (string, int, string)\n{\n\t(name, year, country) := band;\n\tif(year \u0026lt; 100)\n\t\tyear += 1900;\n\treturn (name, year, country);\n}\n\nnamei(band: (string, int, string)): string\n{\n\t(name, nil, nil) := band;\n\tname = str-\u0026gt;tolower(name);\n\tif(name[0:3] == \u0026quot;the\u0026quot;)\n\t\tname = name[4:];\n\treturn name;\n}\u003c/code\u003e\u003c/pre\u003e\n\t\t\u003cp\u003e2文字以下のバンド名(\u0026quot;X\u0026quot;など)が初期データにあると落ちる。\n\t\ttheの判定のところでname[0:3]が配列境界を越えるから。\u003c/p\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003e2009年9月30日追記\u003c/h2\u003e\n\t\t\t\u003cp\u003e関数ポインタは、ref fn()のように書くと渡せる。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"c\"\u003eimplement Fn;\n\ninclude \u0026quot;sys.m\u0026quot;;\n\tsys: Sys;\ninclude \u0026quot;draw.m\u0026quot;;\n\nFn: module\n{\n\tinit: fn(ctxt: ref Draw-\u0026gt;Context, argv: list of string);\n};\n\nInt: adt\n{\n\tn: int;\n};\n\ninit(nil: ref Draw-\u0026gt;Context, nil: list of string)\n{\n\tsys = load Sys Sys-\u0026gt;PATH;\n\n\tA1 := array[] of { \u0026quot;a1\u0026quot;, \u0026quot;b2\u0026quot;, \u0026quot;c3\u0026quot; };\n\tA2 := array[] of { ref Int(1), ref Int(2), ref Int(3) };\n\n\tapply(A1, printstring);\n\tapply(A2, printint);\n}\n\napply[T](a: array of T, f: ref fn(p: T))\n{\n\tfor(i := 0; i \u0026lt; len a; i++)\n\t\tf(a[i]);\n}\n\nprintint(n: ref Int)\n{\n\tsys-\u0026gt;print(\u0026quot;%d\\n\u0026quot;, n.n);\n}\n\nprintstring(s: string)\n{\n\tsys-\u0026gt;print(\u0026quot;%s\\n\u0026quot;, s);\n}\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003cp\u003eqsortの比較関数プロトタイプなど、Cでvoid*を使う状況では、\n\t\t\tパラメトリック多相型というものが同じような目的に使える。\n\t\t\t上記の例でいえば、apply関数で使っているT型。\n\t\t\tこれは、ref型しか扱えない(型の解決ができない)という制限があるので、\n\t\t\tintを直接扱うといったことはできない。\u003c/p\u003e\n\t\t\u003c/section\u003e\n\t\u003c/section\u003e\n\u003c/main\u003e\n\u003caside\u003e\n\t\u003ch1\u003e参考サイト\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"http://alohakun.blog7.fc2.com/blog-entry-730.html\"\u003eLimboのパラメトリック多相\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/aside\u003e\n\u003caside\u003e\n\t\u003ch1\u003eやっていること\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/index.html\"\u003ePlan 9\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"http://web.me.com/lufia/alefcompiler/alef/\"\u003eAlefコンパイラを読む\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/aside\u003e\n\u003cfooter\u003e\n\t\u003cp\u003e見れない、表示がおかしい場合は、動作環境を添えて\u003ca href=\"mailto:webmaster@lufia.org\"\u003ewebmaster@lufia.org\u003c/a\u003eまで連絡ください。\u003c/p\u003e\n\u003c/footer\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/[[...slug]]","query":{"slug":["notes","2007","1216"]},"buildId":"uudkrhSA2meQW-38gm1fk","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>