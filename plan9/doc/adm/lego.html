<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>Plan 9: legoを使った証明書更新</title><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="author" content="http://www.hatena.ne.jp/lufiabb/"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/1b15737708df434c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1b15737708df434c.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-c2e8b39087850489.js" defer=""></script><script src="/_next/static/chunks/main-7715c9ce3e92f40f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8e84d751e7e95936.js" defer=""></script><script src="/_next/static/chunks/245-02c6405e66663b10.js" defer=""></script><script src="/_next/static/chunks/pages/%5B%5B...slug%5D%5D-663c09fbf665935a.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_buildManifest.js" defer=""></script><script src="/_next/static/uudkrhSA2meQW-38gm1fk/_ssgManifest.js" defer=""></script></head><body><div id="__next">
<nav>
	<h1>メニュー</h1>
	<ul>
	<li><a href="/plan9/index.html"><a>Plan 9</a></a></li>
	<li><a href="/plan9/doc/inst/index.html"><a>インストール</a></a></li>
	<li><a href="/plan9/doc/guide/index.html"><a>システムの使い方</a></a></li>
	<li><a href="/plan9/doc/devel/index.html"><a>プログラミング</a></a></li>
	<li><a href="/plan9/doc/adm/index.html"><a>システム管理</a></a></li>
	<li><a href="/plan9/man/index.html"><a>自作ツール集</a></a></li>
	</ul>
</nav>
<main>
	<p class="revision">2019年6月24日更新</p>
	<section>
		<h1>legoを使った証明書更新</h1>
		<p><a href="https://go-acme.github.io/lego/">lego</a>はGoで書かれたLet&#x27;s encryptクライアントです。
		バイナリさえ用意すればPlan 9で動作します。</p>
		<section>
			<h2>legoコマンドをインストール</h2>
			<p>前提として<strong>/sys/lib/tls/ca.pem</strong>が必要です。
			準備できていない場合は、9legacyなどからインストールしましょう。</p>
			<p>次に、legoコマンドをインストールします。
			Plan 9にGo開発環境を構築済みの場合は、次のコマンドで行えます。</p>
			<pre><code class="console">$ go get github.com/xenolf/lego/cmd/lego</code></pre>
			<p>または、GOOSをplan9にセットするとPlan 9で動作するコマンドがビルドできます。</p>
			<pre><code class="console">$ git clone https://github.com/xenolf/lego
$ cd lego/cmd/lego
$ GOOS=plan9 GOARCH=386 go build</code></pre>
		</section>
		<section>
			<h2>新規発行の場合</h2>
			<p>初めてLet&#x27;s encryptで証明書を発行する場合は、lego runコマンドを使います。</p>
			<pre><code class="console">% lego -a -m info@example.com -d example.com -k rsa2048 run</code></pre>
			<p>Plan 9で使う証明書を発行するために必須のオプションは上記の通りです。
			legoには他にもオプションがあり、--path &lt;dir&gt;とすると証明書や鍵ファイルを
			&lt;dir&gt;以下で管理します。また、ip/httpd/httpdが既に動作している場合、
			--webroot /usr/webのようにするとhttpdを経由してドメインの確認を行います。</p>
			<pre><code class="console">% lego -a -m info@example.com -d example.com -k rsa2048 --webroot /usr/web run
% rm /usr/web/.well-known/acme-challenge
% rm /usr/web/.well-known</code></pre>
		</section>
		<section>
			<h2>更新の場合</h2>
			<p>新規発行の時に使ったコマンドから、runをrenewに変更するだけです。
			--pathオプションを使って管理ディレクトリを変更していた場合は、
			同じディレクトリを与えてあげる必要があります。</p>
		</section>
		<section>
			<h2>httpdに反映</h2>
			<p>Let&#x27;s encryptで発行した証明書とペアの鍵ファイルを、
			factotumで扱えるように変換します。</p>
			<pre><code class="console">% cd .lego/certificates
% auth/pemdecode &#x27;RSA PRIVATE KEY&#x27; example.com.key |
&gt; auth/asn12rsa -t &#x27;service=tls role=client owner=*&#x27; &gt;key</code></pre>
			<p>終わったら、bootesのfactotumに設定しましょう。</p>
			<pre><code class="console">% auth/secstore -g factotum
% cp key factotum (古い秘密鍵を新しい鍵で置き換え)
% auth/secstore -p factotum
% rm factotum</code></pre>
			<p>最後に、対応するサーバ証明書を更新します。</p>
			<pre><code class="console">% sed &#x27;/^$/,$d&#x27; example.com.crt &gt;/sys/lib/tls/cert.pem
% sed &#x27;1,/^$/d&#x27; example.com.crt &gt;/sys/lib/tls/chain.pem
% ip/httpd/httpd -c /sys/lib/tls/cert.pem -C /sys/lib/tls/chain.pem</code></pre>
		</section>
	</section>
</main>
<aside>
	<h1>参考ページ</h1>
	<ul>
	<li><a href="/plan9/doc/adm/certs.html"><a>正当な証明書を扱う</a></a></li>
	</ul>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="/plan9/doc/adm/mailto:webmaster@lufia.org"><a>webmaster@lufia.org</a></a>まで連絡ください。</p>
</footer>
</div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"html":"\u003c!doctype html\u003e\n\u003chtml lang=\"ja\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003ctitle\u003ePlan 9: legoを使った証明書更新\u003c/title\u003e\n\u003cmeta name=\"viewport\" content=\"width=device-width,initial-scale=1\"\u003e\n\u003cmeta name=\"author\" content=\"http://www.hatena.ne.jp/lufiabb/\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cnav\u003e\n\t\u003ch1\u003eメニュー\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/index.html\"\u003ePlan 9\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/doc/inst/index.html\"\u003eインストール\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/doc/guide/index.html\"\u003eシステムの使い方\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/doc/devel/index.html\"\u003eプログラミング\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/doc/adm/index.html\"\u003eシステム管理\u003c/a\u003e\u003c/li\u003e\n\t\u003cli\u003e\u003ca href=\"/plan9/man/index.html\"\u003e自作ツール集\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/nav\u003e\n\u003cmain\u003e\n\t\u003cp class=\"revision\"\u003e2019年6月24日更新\u003c/p\u003e\n\t\u003csection\u003e\n\t\t\u003ch1\u003elegoを使った証明書更新\u003c/h1\u003e\n\t\t\u003cp\u003e\u003ca href=\"https://go-acme.github.io/lego/\"\u003elego\u003c/a\u003eはGoで書かれたLet's encryptクライアントです。\n\t\tバイナリさえ用意すればPlan 9で動作します。\u003c/p\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003elegoコマンドをインストール\u003c/h2\u003e\n\t\t\t\u003cp\u003e前提として\u003cstrong\u003e/sys/lib/tls/ca.pem\u003c/strong\u003eが必要です。\n\t\t\t準備できていない場合は、9legacyなどからインストールしましょう。\u003c/p\u003e\n\t\t\t\u003cp\u003e次に、legoコマンドをインストールします。\n\t\t\tPlan 9にGo開発環境を構築済みの場合は、次のコマンドで行えます。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e$ go get github.com/xenolf/lego/cmd/lego\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003cp\u003eまたは、GOOSをplan9にセットするとPlan 9で動作するコマンドがビルドできます。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e$ git clone https://github.com/xenolf/lego\n$ cd lego/cmd/lego\n$ GOOS=plan9 GOARCH=386 go build\u003c/code\u003e\u003c/pre\u003e\n\t\t\u003c/section\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003e新規発行の場合\u003c/h2\u003e\n\t\t\t\u003cp\u003e初めてLet's encryptで証明書を発行する場合は、lego runコマンドを使います。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e% lego -a -m info@example.com -d example.com -k rsa2048 run\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003cp\u003ePlan 9で使う証明書を発行するために必須のオプションは上記の通りです。\n\t\t\tlegoには他にもオプションがあり、--path \u0026lt;dir\u0026gt;とすると証明書や鍵ファイルを\n\t\t\t\u0026lt;dir\u0026gt;以下で管理します。また、ip/httpd/httpdが既に動作している場合、\n\t\t\t--webroot /usr/webのようにするとhttpdを経由してドメインの確認を行います。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e% lego -a -m info@example.com -d example.com -k rsa2048 --webroot /usr/web run\n% rm /usr/web/.well-known/acme-challenge\n% rm /usr/web/.well-known\u003c/code\u003e\u003c/pre\u003e\n\t\t\u003c/section\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003e更新の場合\u003c/h2\u003e\n\t\t\t\u003cp\u003e新規発行の時に使ったコマンドから、runをrenewに変更するだけです。\n\t\t\t--pathオプションを使って管理ディレクトリを変更していた場合は、\n\t\t\t同じディレクトリを与えてあげる必要があります。\u003c/p\u003e\n\t\t\u003c/section\u003e\n\t\t\u003csection\u003e\n\t\t\t\u003ch2\u003ehttpdに反映\u003c/h2\u003e\n\t\t\t\u003cp\u003eLet's encryptで発行した証明書とペアの鍵ファイルを、\n\t\t\tfactotumで扱えるように変換します。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e% cd .lego/certificates\n% auth/pemdecode 'RSA PRIVATE KEY' example.com.key |\n\u0026gt; auth/asn12rsa -t 'service=tls role=client owner=*' \u0026gt;key\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003cp\u003e終わったら、bootesのfactotumに設定しましょう。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e% auth/secstore -g factotum\n% cp key factotum (古い秘密鍵を新しい鍵で置き換え)\n% auth/secstore -p factotum\n% rm factotum\u003c/code\u003e\u003c/pre\u003e\n\t\t\t\u003cp\u003e最後に、対応するサーバ証明書を更新します。\u003c/p\u003e\n\t\t\t\u003cpre\u003e\u003ccode class=\"console\"\u003e% sed '/^$/,$d' example.com.crt \u0026gt;/sys/lib/tls/cert.pem\n% sed '1,/^$/d' example.com.crt \u0026gt;/sys/lib/tls/chain.pem\n% ip/httpd/httpd -c /sys/lib/tls/cert.pem -C /sys/lib/tls/chain.pem\u003c/code\u003e\u003c/pre\u003e\n\t\t\u003c/section\u003e\n\t\u003c/section\u003e\n\u003c/main\u003e\n\u003caside\u003e\n\t\u003ch1\u003e参考ページ\u003c/h1\u003e\n\t\u003cul\u003e\n\t\u003cli\u003e\u003ca href=\"certs.html\"\u003e正当な証明書を扱う\u003c/a\u003e\u003c/li\u003e\n\t\u003c/ul\u003e\n\u003c/aside\u003e\n\u003cfooter\u003e\n\t\u003cp\u003e見れない、表示がおかしい場合は、動作環境を添えて\u003ca href=\"mailto:webmaster@lufia.org\"\u003ewebmaster@lufia.org\u003c/a\u003eまで連絡ください。\u003c/p\u003e\n\u003c/footer\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/[[...slug]]","query":{"slug":["plan9","doc","adm","lego"]},"buildId":"uudkrhSA2meQW-38gm1fk","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>