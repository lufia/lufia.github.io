---
Date: 2017-03-27
Title: Plan 9 from User Spaceにパッチを送る
Tags: "Plan9"
---

**この記事はQiitaで公開されていました**

# はじめに

2017-09-07追加
2017年9月ごろから、[GitHubのPull Requestで受け付ける](https://github.com/9fans/plan9port/blob/master/CONTRIBUTING.md)ようになりました。そのため、以下の情報は不要です。

---

Plan 9 from User SpaceはGitHubでリポジトリが用意されていますが、通常のPull RequestではなくGerritでコードレビューを行います。まずは

* [CONTRIBUTING.md](https://github.com/9fans/plan9port/blob/master/CONTRIBUTING.md)
* [codereview(1)](https://swtch.com/plan9port/man/man1/codereview.html)

を読みましょう。ざっくり言うと、Gitを直接使うのではなくPlan 9 from User Spaceに含まれている`codereview`コマンドを使ってパッチを送るように書かれています。(結局はGitのラッパーなのですが)

普段、Gitを使った開発に慣れている場合は、最初から違和感がありますけれど、いったん公式で推奨している方法でパッチ作成を行います。

## ソースコードの修正

まず、*master*ブランチでコードを修正します。ここではまだトピックブランチの作成もコミットも行いません。修正が終わったら問題が解決したかをテストして次の手順を行いましょう。

```
$ git status
On branch master
Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git checkout -- <file>..." to discard changes in working directory)

	modified:   lib/moveplan9.files
```

## パッチの作成

この時点で`git status`は、ステージされていない変更がいくつか存在する状態になっているはずです。このまま`codereview create <name>`を実行してブランチの作成と変更のコミットを行いましょう。このコマンドは、`git branch <name> && git commit -a`のような動作をします。

```
$ codereview create moveplan9.files
```

ここで、コミットメッセージの最後に`Change-Id:`という行が追加されているでしょうか。このIDはGitの`commit-msg`フックで追加されるものです。`codereview`コマンドを使った場合は何もしなくても追加されていると思いますが、IDがない場合はGerritにアップロードする時に弾かれてしまいます。

### 変更の追加

`codereview create`コマンドの後で変更を追加したくなった場合は、ファイルを修正して`codereview commit`コマンドを実行しましょう。これは`git commit -a --amend`とほとんど同等です。

```
$ codereview commit
```

## Gerritアカウントの取得

Gerritにアップロードするため`codereview upload`コマンドを実行して、Googleアカウントでログインしましょう。ただしこの時点では、*.gitcookies*を取得するためのURLとアップロードエラーが表示されると思います。URLを開いて、ページに書かれているコマンドを実行します。

```
touch ~/.gitcookies
chmod 0600 ~/.gitcookies

git config --global http.cookiefile ~/.gitcookies

tr , \\t <<\__END__ >>~/.gitcookies
plan9port.googlesource.com,FALSE,/,TRUE,xxxx
plan9port-review.googlesource.com,FALSE,/,TRUE,xxxx
__END__
```

そのまま*~/.gitcookies*に保存しても構いませんし、リポジトリ単位で(`--global`オプションを外して)セットしても問題ありません。

## パッチのアップロード

ここまで完了したらアップロードするだけです。`codereview upload`コマンドでアップロードしましょう。

```
$ codereview upload
```

これで、[Plan 9 from Outer SpaceのGerrit](https://plan9port-review.googlesource.com/)に自分の書いた変更が反映されると思います。

