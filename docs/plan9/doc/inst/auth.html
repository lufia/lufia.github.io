<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script>
document.createElement('article')
document.createElement('aside')
document.createElement('footer')
document.createElement('header')
document.createElement('nav')
document.createElement('section')
</script>
<style>
article, aside, footer, header, nav, section { display: block }
</style>
<title>Plan 9: 認証サーバのインストール</title>
<script src="/lib/jquery.js"></script>
<script src="/lib/decor.js"></script>
<script src="/plan9/lib/complex.js"></script>
<link rel="stylesheet" type="text/css" href="/plan9/lib/u.css">
<meta name="author" content="http://www.hatena.ne.jp/lufiabb/">
</head>
<body>
<header>
		<h1><a href="/plan9/">Plan 9</a></h1>
</header>
<nav>
	<section>
		<h1>メニュー</h1>
		<ul>
		<li><a href="/plan9/doc/inst/">インストール</a></li>
		<li><a href="/plan9/doc/guide/">システムの使い方</a></li>
		<li><a href="/plan9/doc/devel/">プログラミング</a></li>
		<li><a href="/plan9/doc/adm/">システム管理</a></li>
		<li><a href="/plan9/man/">自作ツール集</a></li>
		</ul>
	</section>
</nav>
<article>
	<section>
		<h1>認証サーバのインストール</h1>
		<p class="revision">2006年11月12日更新</p>
		<section>
			<h2>認証サーバカーネルのインストール</h2>
			<div class="note">
				<section>
					<h3>ilの組み込み</h3>
					<p>dumpfsへ接続する場合には、ilの組み込みが必須です。
					詳細は<a href="il.html">カーネルにilを組み込む</a>をみてください。
					fossilやventiを使う場合には不要です。</p>
				</section>
			</div>
			<p>/sys/src/9/pc/pcauthが認証サーバカーネルの設定ファイルになります。
			必要ならpcauthに手を入れて、カーネルをコンパイルします。
			コマンドは以下。</p>
			<pre>% cd /sys/src/9/pc
% mk 'CONF=pcauth'</pre>
			<div class="note">
				<section>
					<h3>一般ユーザでのコンパイル</h3>
					<p>通常、sysグループに属していないユーザでは、
					/sys/src/9に書き込みができないのでコンパイルできません。
					そういう場合、<a href="http://plan9.bell-labs.com/magic/man2html/1/bind">bind(1)</a>をうまく使うことによって、
					書き込み先を変更するテクニックがあります。</p>
					<pre>#!/bin/rc

if(! test -e $home/cpu){
	mkdir -p $home/cpu/ ^ (pc port boot)
	cp /sys/src/9/pc/pcauth $home/cpu/pc/pcauth
}
bind -bc $home/cpu/pc /sys/src/9/pc
bind -bc $home/cpu/port /sys/src/9/port
bind -bc $home/cpu/boot /sys/src/9/boot
bind $home/cpu/pcauth /sys/src/9/pc/pcauth

echo 'cd /sys/src/9/pc &amp;&amp; mk ''CONF=pcauth'''</pre>
					<p>このスクリプトは<a href="http://www.geocities.co.jp/SiliconValley/6131/plan9/easyserver.html">ADSLでお気軽自宅サーバ</a>
					を参考にしました。</p>
				</section>
			</div>
			<p>コンパイルが終われば、/n/9fat/に9pcauthをコピーします。
			最後に/n/9fat/plan9.iniに以下を追加すると、
			起動時にどちらのカーネルを使うか尋ねられるようになります。
			すでにあるbootfileを書き換えた場合は聞かれません。</p>
			<pre>bootfile=sdC0!9fat!9pcauth</pre>
			<p>まだ再起動しません。</p>
		</section>
		<section>
			<h2>ネットワーク構成の編集</h2>
			<p>/lib/ndb/localに、認証サーバまわりの項を追加します。
			詳しくは<a href="../adm/ndb.html">ネットワークの設定</a>に書きます。</p>
		</section>
		<section>
			<h2>サービスの隔離</h2>
			<p>通常、サービスは/rc/bin/^(service service.auth)をもとに起動しますが、
			せっかく/cfg/$sysnameというサーバ固有の場所があるのですから
			そちらに移してしまったほうが管理しやすいと思うので移動させます。</p>
			<pre># mkdir /cfg/$sysname/ ^ (service service.auth)
# cp -gux /rc/bin/service/* /cfg/$sysname/service
# cp -gux /rc/bin/service.auth/* /cfg/$sysname/service.auth</pre>
			<div class="note">
				<p>fsカーネルをルートファイルシステムとしている場合は、
				allowしないと所有者情報などが書き込みできません。
				その場合、次のようにします。</p>
				<p>fsカーネルコンソールから、各ディレクトリを作成。
				fs:というのはファイルサーバのプロンプトになります。</p>
				<pre>fs: create /cfg/wisp/service sys sys 775 d
fs: create /cfg/wisp/service.auth sys sys 775 d
fs: allow		# 所有者もコピーするため</pre>
				<p>認証サーバでファイルといっしょに所有者情報もコピーする。</p>
				<pre>cpu% cp -gux /rc/bin/service/* /cfg/wisp/service
cpu% cp -gux /rc/bin/service.auth/* /cfg/wisp/service.auth</pre>
				<p>ファイルサーバコンソールから、後始末。</p>
				<pre>fs: disallow</pre>
			</div>
		</section>
		<section>
			<h2>cpurcの編集</h2>
			<p>次に、cpurcを編集します。
			以前は/rc/bin/cpurcを直接編集する方法でしたが、
			いつの間にか/cfg/$sysname/cpurcを用意する形になりました。
			2007年4月には変わってましたね。</p>
			<pre>eval `{ndb/ipquery sys $sysname ip ipgw ipmask}
ip/ipconfig -g $ipgw ether /net/ether0 add $ip $ipmask
ndb/dns -r
aux/timesync -rL

auth/keyfs -wp -m /mnt/keys /adm/keys &gt;/dev/null &gt;[2=1]
auth/cron &gt;&gt;/sys/log/cron &gt;[2=1] &amp;
auth/secstored

aux/listen -q -t /cfg/wisp/service.auth -d /cfg/$sysname/service tcp

# ilを組み込んだ場合は以下も有効に
#aux/listen -q -t /cfg/wisp/service.auth -d /cfg/$sysname/service il

sleep 3</pre>
			<p>愛知大学の真似をしてndbからデータを引いていますが、
			IPを直接書いてしまってもかまいません。
			sleepは、サービスが立ち上がりきるのを待ってます。</p>
			<p>最後に、念のためnvramを壊しておいて、再起動。</p>
			<pre>% echo blah &gt;/dev/sdC0/nvram</pre>
		</section>
		<section>
			<h2>nvramの設定</h2>
			<p>初回起動時に、認証のための情報をいくつか尋ねられます。
			この情報を変更したい場合は、再度nvramを壊して再起動するか、
			認証サーバのコンソールからauth/wrkeyを実行すればいいです。</p>
			<pre>authid: bootes
authdom: mana.lufia.org
secstore: xxxxx
password: zzzzz</pre>
			<p>secstoreには、bootesのsecstoreパスワードを入力します。
			imap4sを立てるときに鍵置き場として使いましたが、
			通常は空でいいと思います。</p>
		</section>
		<section>
			<h2>ユーザbootesの作成</h2>
			<pre># auth/changeuser -p bootes  # パスワードはnvramと同じ</pre>
		</section>
		<section>
			<h2>認証でadmとsysをはじく</h2>
			<p>sysとadmをユーザとして認証しないように、
			/lib/ndb/authに以下を追加します。</p>
			<pre>hostid=bootes
    uid=!sys uid=!adm uid=*</pre>
		</section>
		<section>
			<h2>デバッグ</h2>
			<p>認証サーバのコンソールからauth/debugを使うと、
			登録されているユーザごとに認証のテストが行えます。
			認証でこけている場合は、cpurc等でのコマンド呼び出し順が
			違うのかもしれません。
			名前空間の関係から、順番がかなり重要になっています。
			何度か引っかかりました。</p>
		</section>
	</section>
</article>
<aside>
	<section>
		<h1>関連情報</h1>
		<ul>
		<li><a href="il.html">カーネルにilを組み込む</a></li>
		<li><a href="dist.html">分散システムのインストール</a></li>
		</ul>
	</section>
	<section>
		<h1>参考ページ</h1>
		<ul>
		<li><a href="http://www.plan9.bell-labs.com/wiki/plan9/Configuring_a_Standalone_CPU_Server/index.html">Configuring a Standalone CPU Server</a></li>
		<li><a href="http://www.geocities.co.jp/SiliconValley/6131/plan9/easyserver.html">ADSLでお気軽自宅サーバ</a></li>
		</ul>
	</section>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="mailto:webmaster@lufia.org">webmaster@lufia.org</a>まで連絡ください。</p>
</footer>
</body>
</html>
