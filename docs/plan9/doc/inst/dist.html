<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script>
document.createElement('article')
document.createElement('aside')
document.createElement('footer')
document.createElement('header')
document.createElement('nav')
document.createElement('section')
</script>
<style>
article, aside, footer, header, nav, section { display: block }
</style>
<title>Plan 9: 分散システムのインストール</title>
<script src="/lib/jquery.js"></script>
<script src="/lib/decor.js"></script>
<script src="/plan9/lib/complex.js"></script>
<link rel="stylesheet" type="text/css" href="/plan9/lib/u.css">
<meta name="author" content="http://www.hatena.ne.jp/lufiabb/">
</head>
<body>
<header>
		<h1><a href="/plan9/">Plan 9</a></h1>
</header>
<nav>
	<section>
		<h1>メニュー</h1>
		<ul>
		<li><a href="/plan9/doc/inst/">インストール</a></li>
		<li><a href="/plan9/doc/guide/">システムの使い方</a></li>
		<li><a href="/plan9/doc/devel/">プログラミング</a></li>
		<li><a href="/plan9/doc/adm/">システム管理</a></li>
		<li><a href="/plan9/man/">自作ツール集</a></li>
		</ul>
	</section>
</nav>
<article>
	<section>
		<h1>分散システムのインストール</h1>
		<p class="revision">2006年10月30日更新</p>
		<p>Plan 9は、各端末や認証サーバでさえも、
		ファイルサーバをルートファイルシステムとして扱えます。
		ちょっと手間ですし、いくつか認証サーバ構築の時と
		同じ設定をしなければいけませんが、
		一度やってしまえばディスクレス運用も可能になるのでオススメです。</p>
		<p>以下、認証サーバとファイルサーバを切り替えながら構築していきます。
		プロンプトでどちらの作業か分かるように書いていく予定です。</p>
		<pre># 認証サーバ、ホストオーナー
#

# 認証サーバ、一般ユーザ
%

# ファイルサーバ、configモード
config:

# ファイルサーバ、通常モード
fs:</pre>
		<section>
			<h2>配布ファイルの展開</h2>
			<p>現状、<a href="http://plan9.bell-labs.com/wiki/plan9/Installing_a_Plan_9_File_Server/index.html">Installing a Plan 9 File Server</a>にあるwrap/instコマンドがありません。
			9fansで調べると<a href="http://9fans.net/archive/2003/03/322">problems installing the plan9 distribution on fileserver</a>というのがあったので、それに沿って対応。</p>
			<pre>% 9fs sources
% bind /n/sources/plan9 /n/dist
% srv fairy
% mount -c /srv/fairy /n/inst
% cp /n/dist/dist/replica/inst /dist/replica (#instが無かったので作成)
% chmod +x /dist/replica/inst</pre>
			<pre>fs: create /dist sys sys 775 d
fs: create /dist/replica sys sys 775 d
fs: create /dist/replica/ndist sys sys 775
fs: create /dist/replica/client sys sys 775 d
fs: create /dist/replica/client/plan9.db sys sys 664
fs: create /dist/replica/client/plan9.log sys sys 664 a</pre>
			<pre>% replica/pull -v /dist/replica/inst</pre>
		</section>
		<section>
			<h2>cpu/auth: nvramの設定</h2>
			<p>最初の立ち上げ時に聞かれます。
			自分で呼び出す場合はauth/wrkey。</p>
			<pre>authid: bootes
authdom: mana.lufia.org
secstore: xxxxx    # bootesは使わないけど、とりあえず設定
password: zzzzz</pre>
		</section>
		<section>
			<h2>ファイルサーバ: cronの準備</h2>
			<pre>fs: create /sys/log/cron sys sys 666 a</pre>
		</section>
		<section>
			<h2>ファイルサーバ: secstoreの準備</h2>
			<pre>fs: create /adm/secstore adm adm 775 d</pre>
		</section>
		<section>
			<h2>ファイルサーバ: cpu/authで使うファイルの編集</h2>
			<p>cpu/authからファイルサーバをマウントして作業。
			このあたりは<a href="auth.html">認証サーバのインストール</a>そのまま。</p>
			<pre>% 9fs $fileserver</pre>
			<ul>
			<li>/rc/bin/termrc   (# 端末がなければどうでもいい)</li>
			<li>/rc/bin/cpurc</li>
			<li>/adm/timezone/local</li>
			<li>/lib/ndb/local</li>
			<li>/lib/ndb/auth</li>
			<li>/rc/bin/^(service service.auth)  # cpurcから変更されるので作業はない</li>
			</ul>
			<p>補足として、secstoreを有効にするために、
			cpurcのauth/cronの次行に、auth/secstoredを追加しています。</p>
		</section>
		<section>
			<h2>ファイルサーバ: /bin/cpurcでmvの行を有効にしたなら</h2>
			<pre>fs: newuser sys +bootes</pre>
		</section>
		<section>
			<h2>cpu/auth: plan9.iniの設定</h2>
			<pre># 9fat:
# cd /n/9fat
# ramfs
# ed plan9.ini
# unmount /n/9fat</pre>
			<p>plan9.iniの必要なところだけ抜粋。</p>
			<pre>bootfile=sdC0!9fat!9pcauth
bootargs=il -g x.x.x.x ether /net/ether0 y.y.y.y m.m.m.m
fs=z.z.z.z
auth=y.y.y.y</pre>
			<p class="note">だいたい分かるかと思われますが、いちおう。</p>
			<dl>
			<dt>x.x.x.x</dt>
			<dd>デフォルトゲートウェイ</dd>
			<dt>y.y.y.y</dt>
			<dd>いま構築している認証サーバ のIPアドレス</dd>
			<dt>m.m.m.m</dt>
			<dd>y.y.y.yのマスク</dd>
			<dt>z.z.z.z</dt>
			<dd>ファイルサーバのIPアドレス</dd>
			</dl>
		</section>
		<section>
			<h2>cpu/auth: 再起動</h2>
			<pre># fshalt
# ^t ^t r</pre>
			<p>/rc/bin/service/^(il566 tcp567)が無くてエラーになるけど、
			目的はサービスの無効化なので無視</p>
		</section>
		<section>
			<h2>ファイルサーバ: ユーザの作成</h2>
			<pre>fs: newuser lufia
fs: newuser adm +bootes</pre>
			<p class="note">bootesをadmに所属させない限り、
			auth/changeuserの結果を保存できません。</p>
		</section>
		<section>
			<h2>cpu/auth: ユーザの作成</h2>
			<pre># auth/changeuser -p bootes  (# パスワードはnvramと同じにする)
# auth/changeuser -p lufia</pre>
		</section>
		<section>
			<h2>cpu/auth: 認証でadmとsysをはじく</h2>
			<pre># cat &gt;&gt;/lib/ndb/auth
hostid=bootes
    uid=!sys uid=!adm uid=**
^D</pre>
		</section>
		<section>
			<h2>cpu/auth: secstoreの設定</h2>
			<pre># auth/secuser -v lufia
# echo 'key proto=p9sk1 dom=mana.lufia.org user=lufia !password=xxxx' &gt;/mnt/factotum/ctl  (# 最初のdrawterm接続のため)</pre>
		</section>
		<section>
			<h2>drawtermで接続テスト</h2>
			<p>secstoreに何も保存されてない場合、
			secstoreパスワードを入力するとエラーになるので、空にしてログインする。</p>
			<pre>drawterm -a wisp -c wisp
user[none]: lufia
password: xxxx
secstore password:</pre>
		</section>
		<section>
			<h2>lufiaの環境設定</h2>
			<pre>% /sys/lib/newuser</pre>
			<p>これで、メールやらなにやらのファイルが作られます。</p>
		</section>
		<section>
			<h2>lufiaのsecstoreに、drawterm他用のアカウントを保存</h2>
			<p>ファイル名をfactotum以外にすると、次回ログイン時に
			secsotreがremote file factotum does not existsとエラーを吐くので注意。</p>
			<pre>% ramfs
% cd /tmp
% echo 'key proto=p9sk1 dom=mana.lufia.org user=lufia !password=xxxx' &gt;factotum
% auth/secstore -p factotum
% rm factotum</pre>
			<p>ちなみに、すでにアカウントが保存されている場合はこちら</p>
			<pre>% ramfs
% cd /tmp
% auth/secstore -g factotum
% echo 'key proto...' &gt;&gt;factotum
% auth/secstore -p factotum
% rm factotum</pre>
		</section>
		<section>
			<h2>cpu/auth: 再起動して動作確認</h2>
			<pre># fshalt</pre>
		</section>
		<section>
			<h2>ファイルサーバ: 後始末</h2>
			<p>drawtermでlufiaがログインできるのを確認してから後始末。
			というのも、(たぶんkeyfsの)停止時に/adm/keysに書くため、
			<strong>bootes</strong>に<strong>adm</strong>権が必要だから。</p>
			<pre>fs: newuser sys -bootes
fs: newuser adm -bootes</pre>
		</section>
	</section>
</article>
<aside>
	<section>
		<h1>関連情報</h1>
		<ul>
		<li><a href="fs.html">ファイルサーバのインストール</a></li>
		</ul>
	</section>
	<section>
		<h1>参考ページ</h1>
		<ul>
		<li><a href="http://www.plan9.bell-labs.com/wiki/plan9/Installing_a_Plan_9_File_Server/index.html">Installing a Plan 9 File Server</a></li>
		<li><a href="http://plan9.aichi-u.ac.jp/install/distrib.html">分散システムの構築</a></li>
		</ul>
	</section>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="mailto:webmaster@lufia.org">webmaster@lufia.org</a>まで連絡ください。</p>
</footer>
</body>
</html>
