<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script>
document.createElement('article')
document.createElement('aside')
document.createElement('footer')
document.createElement('header')
document.createElement('nav')
document.createElement('section')
</script>
<style>
article, aside, footer, header, nav, section { display: block }
</style>
<title>Plan 9: さくらVPSでPlan 9ネットワークを構成してみた</title>
<script src="/lib/jquery.js"></script>
<script src="/lib/decor.js"></script>
<script src="/plan9/lib/complex.js"></script>
<link rel="stylesheet" type="text/css" href="/plan9/lib/u.css">
<meta name="author" content="http://www.hatena.ne.jp/lufiabb/">
</head>
<body>
<header>
		<h1><a href="/plan9/">Plan 9</a></h1>
</header>
<nav>
	<section>
		<h1>メニュー</h1>
		<ul>
		<li><a href="/plan9/doc/inst/">インストール</a></li>
		<li><a href="/plan9/doc/guide/">システムの使い方</a></li>
		<li><a href="/plan9/doc/devel/">プログラミング</a></li>
		<li><a href="/plan9/doc/adm/">システム管理</a></li>
		<li><a href="/plan9/man/">自作ツール集</a></li>
		</ul>
	</section>
</nav>
<article>
	<section>
		<h1>さくらVPSでPlan 9ネットワークを構成してみた</h1>
		<p class="revision">2014年5月4日作成</p>
		<p>さくらVPSを使って、フルシステムのPlan 9を作ってみます。
		最終的に、ファイルサーバ、認証サーバ、CPUサーバの3つ建てて、
		インターネットからdrawtermでアクセスできるところまでの予定です。</p>
		<section>
			<h2>方針</h2>
			<p>ざっくりと構成方針です。</p>
			<table>
			<tr><th>ホスト</th><th>カーネル</th><th>ether0</th><th>ether1</th><th>fs</th></tr>
			<tr><td>fs</td><td>pccpuf</td><td>133.242.aaa.aaa</td><td>192.168.1.3</td><td>venti+fossil</td></tr>
			<tr><td>auth</td><td>pcauth</td><td>133.242.bbb.bbb</td><td>192.168.1.7</td><td>fossil</td></tr>
			<tr><td>cpu</td><td>pccpu</td><td>133.242.ccc.ccc</td><td>192.168.1.23</td><td>fossil</td></tr>
			</table>
			<p>authとcpuは、最終的にfsをルートにマウントするので、
			fossilのみで構成しています。</p>
			<p>133.242.ではじまるアドレスは、
			さくらVPSに割り当てられているアドレスを使います。
			ネットワークの構成(ipgw, ipmaskなど)は
			VPSコントロールパネルのOSインストール時に見られます。
			それ以外の方法で知る方法は知りませんので、
			情報を控えておいたほうがいいでしょう。</p>
		</section>
		<section>
			<h2>準備</h2>
			<p>まずは3台のVPSが必要なので、NICを認識するところまで作業します。
			VPSに単体Plan 9をインストールする部分は、<a href="vps.html">さくらVPSにPlan 9をインストール</a>を読んでください。</p>
			<p>サーバ3台の構築が終わったら、VPSコントロールパネルから、
			ローカルネットワークの追加が必要です。
			これは本契約でなければ使えません。
			本契約になってしばらくすればサーバ一覧に出てきます。
			サーバを停止した状態で、各サーバのNIC1にローカルネットワークを接続します。
			これでローカルネットワーク経由での通信が可能となります。</p>
			<p>このネットワークは扱いがちょっと面倒です。
			OS再インストールをすると、おそらくISOからブートするより前に、
			ローカルネットワーク構成がリセットされてしまいますので
			忘れずに再接続しなければなりません。</p>
			<p>また、インターネット側はNIC0にだけ割り当て可能です。
			Plan 9は/netに内部ネットワークをバインドしたほうが楽なのですが、
			/lib/namespaceの中でether0(NIC0)を/netにバインドしているので
			これをether1へ切り替える必要があります。
			切り替えたことにより、fsをルートにマウントするサーバは
			かならずNICを2枚以上使って、NIC0をインターネット側に、
			NIC1をローカルネットワークしなければならなくなります。</p>
		</section>
		<section>
			<h2>ファイルサーバ</h2>
			<p>NICを認識したpcfカーネルが動作した直後だと仮定しています。</p>
			<section>
				<h3>タイムゾーン構成</h3>
				<pre>fs% con -l /srv/fscons
prompt: uname adm +glenda
prompt: ctl+\
&gt;&gt;&gt; q
fs% cd /adm/timezone
fs% cp Japan local</pre>
			</section>
			<section>
				<h3>ファイルサーバ用カーネルインストール</h3>
				<pre>fs% cd /sys/src/9/pc
fs% mk 'CONF=pccpuf'
fs% 9fat:
fs% mv 9pccpuf /n/9fat
fs% mk 'CONF=pccpuf' nuke</pre>
				<p>終わったら、/n/9fat/plan9.iniを編集。
				bootfileエントリは、ブート時にカーネルを選べるように、
				変更ではなく追加したほうがいいでしょう。</p>
				<pre>bootfile=sdC0!9fat!9pccpuf
sysname=fs
auth=192.168.1.7
console=0 b115200 l8 pn s1</pre>
			</section>
			<section>
				<h3>ネットワーク構成</h3>
				<p>ローカルネットワーク(NIC1)を/netに割り当てるように変更します。</p>
				<pre>fs% grep /net /lib/namespace
bind -a #l1 /net  (オリジナルは#lだった)
bind -a #I /net</pre>
				<p>NIC0は/net.altへ割り当てますが、サーバによっては
				どちらも/netに割り当てたい場合があるので、
				サーバ固有構成のほうで設定します。</p>
				<pre>fs% cat /cfg/fs/namespace
bind -a #l0 /net.alt
bind -a #I1 /net.alt</pre>
				<p>cpurcで各NICへIPアドレスを設定。
				途中の$ipgwは、インストール時に示されたゲートウェイアドレス。</p>
				<pre>% cat /cfg/fs/cpurc
ip/ipconfig ether /net/ether1 add 192.168.1.3 255.255.255.0
ip/ipconfig -x.alt -g $ipgw ether /net.alt/ether0 add 133.242.aaa.aaa 255.255.254.0
ndb/dns -r
ndb/cs -x.alt -f /lib/ndb/external
ndb/dns -rx.alt -f /lib/ndb/external
aux/timesync -n /net.alt/udp!ntp1.sakura.ad.jp
aux/listen -q -d /cfg/$sysname/service tcp
sleep 3</pre>
				<p>/cfg/fs/serviceは、/rc/bin/serviceをコピーして
				必要なサービスだけ残しています。9pサービスだけあればいいのですが、
				何もListenしていないと/rc/bin/cpurcでいろいろサービスが起動してしまうので、
				今回は割と無難なtcp9(discard)だけ立てていますが、
				ほかに、/rc/bin/cpurcを変更してしまってもいいと思います。</p>
				<p>/lib/ndb/local, /lib/ndb/externalは適切な値で構成しておきます。
				localのほうはipnetを使ってグループにまとめられますが、
				グローバルIPアドレスはばらばらなので、個別に設定しましょう。
				だいたいこんな感じ。</p>
				<pre>sys=fs dom=fs.domain.dom
	ether=xxxxxxxx
	ip=133.242.aaa.aaa
	ipgw=xxx.xxx.xxx.xxx
	ipmask=255.255.254.0
	dns=133.242.0.3
	dns=133.242.0.4</pre>
			</section>
			<section>
				<h3>サーバ構成</h3>
				<p>bootesユーザを追加します。</p>
				<pre>fs% con -l /srv/fscons
prompt: uname bootes bootes
prompt: ctl+\
&gt;&gt;&gt; q</pre>
				<p>ファイルサーバを他のサーバからマウントできるように、
				tcp564をListenするようにfossilを変更。
				/rc/bin/service/!tcp564もあるけれど、こっちは使わない。</p>
				<pre>fs% fossil/conf /dev/sdC0/fossil &gt;/tmp/flproto
fs% echo 'listen tcp!*!564' &gt;&gt;/tmp/flproto
fs% fossil/conf -w /dev/sdC0/fossil /flproto
fs% rm /tmp/flproto</pre>
				<p>必要なユーザやファイルをあらかじめ作っておいて再起動。</p>
				<pre>prompt: uname adm +bootes
prompt: uname adm -glenda
prompt: uname sys -glenda
prompt: uname adm -sys (これは好み)
prompt: fsys main
prompt: create /active/sys/log/cron sys sys a666
prompt: create /active/adm/secstore adm adm d775</pre>
				<pre>fs% fshalt
(停止したらコントロールパネルから再起動)</pre>
				<p>理由は分かりませんが、Plan 9でctl+t, ctl+t, rとリブートすると
				VPSの状態が「不明」になって、強制停止も起動もできなくなります。
				こうなると、不明から脱するには再インストールを行って
				むりやり「起動」状態に戻す必要があります。
				(「起動」になればいいので、再インストールを最後まで行う必要はありません)</p>
			</section>
			<section>
				<h3>再起動後</h3>
				<p>9pccpufカーネルで起動したら、
				最初にbootesの情報をきかれるので入力します。
				残りのサーバにも同じものを設定する必要があります。</p>
				<p>終わったら、/sys/logにエラーが出ていないか、
				必要なサービスだけになっているかを確認して終わり。</p>
				<pre>fs# netstat | grep Listen
fs# netstat /net.alt | grep Listen</pre>
			</section>
		</section>
	</section>
</article>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="mailto:webmaster@lufia.org">webmaster@lufia.org</a>まで連絡ください。</p>
</footer>
</body>
</html>
