<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script>
document.createElement('article')
document.createElement('aside')
document.createElement('footer')
document.createElement('header')
document.createElement('nav')
document.createElement('section')
</script>
<style>
article, aside, footer, header, nav, section { display: block }
</style>
<title>Plan 9: VirtIOを使う</title>
<script src="/lib/jquery.js"></script>
<script src="/lib/decor.js"></script>
<script src="/plan9/lib/complex.js"></script>
<link rel="stylesheet" type="text/css" href="/plan9/lib/u.css">
<meta name="author" content="http://www.hatena.ne.jp/lufiabb/">
</head>
<body>
<header>
		<h1><a href="/plan9/">Plan 9</a></h1>
</header>
<nav>
	<section>
		<h1>メニュー</h1>
		<ul>
		<li><a href="/plan9/doc/inst/">インストール</a></li>
		<li><a href="/plan9/doc/guide/">システムの使い方</a></li>
		<li><a href="/plan9/doc/devel/">プログラミング</a></li>
		<li><a href="/plan9/doc/adm/">システム管理</a></li>
		<li><a href="/plan9/man/">自作ツール集</a></li>
		</ul>
	</section>
</nav>
<article>
	<section>
		<h1>VirtIOを使う</h1>
		<section>
			<h2>VirtIOのインストール</h2>
			<section>
				<h3>パッチを当てる</h3>
				<p>VirtIOはPlan 9の標準ディストリビューションには含まれないので、
				9legacyのパッチを当てます。</p>
				<pre>% cd /
% hget http://www.9legacy.org/9legacy/patch/pc-sdvirtio.diff | ape/patch -p1
% hget http://www.9legacy.org/9legacy/patch/pc-ethervirtio.diff | ape/patch -p1</pre>
				<p>自前のツールですが、9legacy/installを使うと便利です。</p>
				<pre>% 9legacy/init
% 9legacy/installall &lt;{9legacy/stable}
% 9legacy/apply</pre>
				<p>次に、カーネルコンフィグへVirtIOドライバを追加します。
				ここで不要なドライバを削除しておいてもいいかもしれません。</p>
				<pre>% cd /sys/src/9/pc
% ed pccpuf</pre>
				<p>カーネルコンフィグは、たとえば以下のように。</p>
				<pre>link
    ethervirtio    pci

misc
    sdvirtio        pci sdscsi</pre>
				<p>また、9loadにも足しておかないとデバイスが見つからなくて
				ブートできなくなるので、9loadのコンフィグにもsdvirtioを足します。</p>
				<pre>% cd /sys/src/9/pcboot
% ed load</pre>
				<p>loadはカーネルをロードするだけなので、sdvirtioがあれば十分だと思います。
				もし9bootも必要なら、そっちにはethervirtioを追加しましょう。</p>
			</section>
			<section>
				<h3>インストール</h3>
				<p>カーネルのビルドを行います。</p>
				<pre>% cd /sys/src/9/pc
% mk 'CONF=pccpuf'</pre>
				<p>次にローダのビルド。</p>
				<pre>% cd /sys/src/9/pcboot
% ed load
% mk 9load</pre>
				<p>9fat領域へカーネルとローダをコピーしたらインストール完了です。</p>
				<pre># 9fat:
# cp 9load /n/9fat/9load (きちんとdisk/format使ったほうが良いかも)
# cp 9pccpuf /n/9fat/9pccpuf</pre>
			</section>
		</section>
		<section>
			<h2>デバイス名を変更</h2>
			<p>VirtIOを有効にすると、デバイス名がsdC0からsdF0に変わります。
			そのため、fossil等、デバイス名の変更が必要です。
			必ず、新しいカーネルでブートする前に実施しなくてはいけません。</p>
			<p>まずplan9.iniを変更。</p>
			<pre>bootfile=sdF0!9fat!9pccpuf
bootargs=local!#S/sdF0/fossil
bootdisk=local!#S/sdF0/fossil</pre>
			<p>fossilのconfにも設定が入っているので修正します。</p>
			<pre># fossil/conf /dev/sdC0/fossil &gt;fossil.conf
# ed fossil.conf
fsys main config /dev/sdF0/fossil
# fossil/conf -w /dev/sdC0/fossil fossil.conf</pre>
			<p>ventiを使っている場合は、ventiの設定も修正が必要です。</p>
			<pre>% venti/conf /dev/sdC0/arenas &gt;venti.conf
% ed venti.conf
isect /dev/sdF0/isect
arenas /dev/sdF0/arenas
% venti/conf -w /dev/sdC0/arenas &lt;venti.conf</pre>
			<p>このあと仮想マシンのVirtIOを有効にするのでシャットダウンさせます。</p>
		</section>
		<section>
			<h2>仮想マシンのVirtIO</h2>
			<p>シャットダウンし終わったら、カスタムOSインストールを実行するか、
			ISOイメージインストールでVirtIOを有効にしてインストールを実行します。
			このとき、あくまで目的はVirtIOを有効にするだけなので、
			イメージから起動したらすぐに再起動させてしまってください。
			(VirtIO有効無効の切り替えはOSインストール時しかできないので)</p>
			<p>これで正しく設定できていればVirtIOドライバを使ったカーネルが動作します。</p>
		</section>
		<section>
			<h2>終わりに</h2>
			<p>さくらVPSは、OS再インストールをすると
			仮想マシンのスイッチ設定がリセットされるので、
			ファイルサーバから/を得ている場合はスイッチの設定も忘れずに。</p>
		</section>
		<section>
			<h2>困ったときの対応</h2>
			<p>少しはまったことをまとめました。</p>
			<section>
				<h3>ブートしなくなった場合</h3>
				<p>Plan 9のISOイメージからブートさせると、
				インストールするかCDからブートするかを選べるので、
				CDからブートして必要なリカバリを行いましょう。</p>
			</section>
			<section>
				<h3>ISOイメージのアップロードができない場合</h3>
				<p>ISOをアップロードしようとしたら、
				以下のようなエラーで失敗するときがあります。</p>
				<pre>sftp&gt; put plan9.iso
Uploading plan9.iso to /iso/plan9.iso
remote open(&quot;/iso/plan9.iso&quot;): Failure</pre>
				<p><a href="http://randomsoft.com/node/438">さくらの VPS で ISO イメージがアップできない</a>によると、ISOアカウントを削除したうえで、
				仮想マシンを起動・停止するといいそうです。</p>
				<p>それでもだめな場合は、起動・停止のかわりに
				カスタムOSインストール・停止させると解消します。</p>
			</section>
		</section>
	</section>
</article>
<aside>
	<section>
		<h1>関連情報</h1>
		<ul>
		<li><a href="9k.html">64bit環境(9kカーネル)を構築する</a></li>
		</ul>
	</section>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="mailto:webmaster@lufia.org">webmaster@lufia.org</a>まで連絡ください。</p>
</footer>
</body>
</html>
