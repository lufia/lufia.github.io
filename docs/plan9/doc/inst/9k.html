<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script>
document.createElement('article')
document.createElement('aside')
document.createElement('footer')
document.createElement('header')
document.createElement('nav')
document.createElement('section')
</script>
<style>
article, aside, footer, header, nav, section { display: block }
</style>
<title>Plan 9: 64bit環境(9kカーネル)を構築する</title>
<script src="/lib/jquery.js"></script>
<script src="/lib/decor.js"></script>
<script src="/plan9/lib/complex.js"></script>
<link rel="stylesheet" type="text/css" href="/plan9/lib/u.css">
<meta name="author" content="http://www.hatena.ne.jp/lufiabb/">
</head>
<body>
<header>
		<h1><a href="/plan9/">Plan 9</a></h1>
</header>
<nav>
	<section>
		<h1>メニュー</h1>
		<ul>
		<li><a href="/plan9/doc/inst/">インストール</a></li>
		<li><a href="/plan9/doc/guide/">システムの使い方</a></li>
		<li><a href="/plan9/doc/devel/">プログラミング</a></li>
		<li><a href="/plan9/doc/adm/">システム管理</a></li>
		<li><a href="/plan9/man/">自作ツール集</a></li>
		</ul>
	</section>
</nav>
<article>
	<section>
		<h1>64bit環境(9kカーネル)を構築する</h1>
		<p class="revision">2016年5月6日作成</p>
		<p>Plan 9からforkしたプロジェクトがいくつかありますが、
		ここではベル研のPlan 9と9legacyを使います。</p>
		<section>
			<h2>ソースコードの更新</h2>
			<p>最初に、<a href="../adm/update.html">replica/pullを使って</a>、本家最新のソースに更新しておいてください。</p>
			<p>2015年1月以降、本家が更新されていないので、<a href="http://9legacy.org/patch.html">9legacyのパッチ集</a>から取得します。
			現時点で、<a href="https://github.com/lufia/9legacy-tool/blob/master/misc/patchlist">64bit環境の動作が確認できたパッチ一覧</a>です。
			上から順番に適用すれば依存関係も解決します。
			このリポジトリには、9legacyのパッチ管理を少し便利にする、
			簡単なrcスクリプトも含んでいますので、よければどうぞ。</p>
			<div class="note">
				<p>9legacy-toolを使う場合、</p>
				<pre>% 9legacy/installall misc/patchlist
% 9legacy/apply</pre>
				<p>とすれば/sys以下のファイルに9legacyパッチ後のファイルをbindします。</p>
			</div>
			<p>また、以下の手順では/amd64以下にファイルを作成しますので、
			作業するユーザはsysグループに属する必要があります。
			fossilの場合は、</p>
			<pre>% con -l /srv/fscons
prompt: uname sys +bootes</pre>
		</section>
		<section>
			<h2>6cコンパイラの更新</h2>
			<p>Runeが、2013年頃に16bitから22bitへアップデートされていますが、
			配布物に含まれる6cコンパイラのバージョンは古いままです。
			古いままだとコンパイル時に</p>
			<blockquote>runebase.c:xx illegal rune string</blockquote>
			<p>とか言われるので先にコンパイラの更新が必要です。
			この時は、objtypeは現在使っている値(例えば386)のままで構いません。</p>
			<pre>% cd /sys/src/cmd/6c
% mk install

# 後処理
% mk nuke
% cd ../cc
% mk nuke</pre>
			<p>9legacyのパッチでアセンブラがサポートする命令も増えているので、
			アセンブラとリンカも更新します。</p>
			<pre># アセンブラ
% cd /sys/src/cmd/6a
% mk install
% mk nuke

# リンカ
% cd /sys/src/cmd/6l
% mk install
% mk nuke</pre>
		</section>
		<section>
			<h2>各種ライブラリの作成</h2>
			<p>amd64環境のコマンド等からリンクされるライブラリを作成します。
			ライブラリは、mk nukeすると
			作成された/$objtype/lib/*.aファイルも消えてしまうため、
			コンパイル時の中間ファイルを掃除するのはmk cleanを使いましょう。</p>
			<p class="note">objtype環境変数を切り替えると、コンパイラが生成するオブジェクトの
			ターゲットとなるアーキテクチャを切り替えられます。</p>
			<pre>% cd /sys/src
% objtype=amd64
% mk libs  # installとcleanを実行します</pre>
		</section>
		<section>
			<h2>APE環境の作成</h2>
			<p>gs等、いくつかのコマンドをコンパイルする時に
			ape/pcc等を使うので用意しておきましょう。</p>
			<pre># apeライブラリ
% mkdir /amd64/lib/ape
% cd /sys/src/ape
% mk lib.install
% mk lib.clean

# apeコマンド等
% mkdir /amd64/lib/ape
% mk cmd.install
% mk cmd.nuke
% mk 9src.install
% mk 9src.nuke</pre>
		</section>
		<section>
			<h2>acme用コマンド</h2>
			<p>ほとんどのコマンドは/sys/src以下にソースがありますけど、
			acme用のコマンドは/acme/*/srcに配置されています。</p>
			<pre>% mkdir /acme/bin/amd64
% cd /acme
% mk install
% mk nuke</pre>
		</section>
		<section>
			<h2>コマンド類</h2>
			<p>ライブラリの準備ができたので、コマンドをビルドします。
			カーネルの内部に一部のコマンドを埋め込むため、
			先にコマンドのインストールが必要です。</p>
			<pre>% mkdir -p /amd64/bin/ ^ (aux auth dial disk fossil fs ip/httpd ndb replica upas usb venti)
% cd /sys/src/cmd

# upasグループに作業ユーザを追加するか、
# 以下2ファイルに/tmpをbindする等で書き込み可能にしておく
# /mail/lib/gone.msg
# /mail/lib/gone.fishing

% mk install
% mk nuke</pre>
			<div class="note">
				<p>9legacy-toolを使った場合、initだけはbind先に作成されてしまうので、
				mk後に手動で移動させておきましょう。</p>
				<pre>% unmount /amd64
% cp $home/9legacy/plan9/amd64/init /amd64/init</pre>
			</div>
		</section>
		<section>
			<h2>ゲーム(不要なら飛ばす)</h2>
			<pre>% mkdir /amd64/bin/games
% cd /sys/src/games
% mk install
% mk nuke</pre>
		</section>
		<section>
			<h2>カーネル</h2>
			<p>ブートローダの更新が必要なら/sys/src/9k/bootにソースがありますけれど、
			/sys/src/9以下の内容と同じなので何もしなくても構いません。</p>
			<p>CPUサーバカーネルの場合はk10cpuコンフィグを使います。
			ただ、k10cpuはsdドライバが含まれていないので、/dev/sdXX/nvramを読めません。
			通常それは困るため、sdドライバを入れましょう。</p>
			<pre>dev +dev
	root
	...
	sd		# 追加

sd +dev	# 追加
	sdata	pci sdscsi
	sdiahci	pci sdscsi
...
rootdir
	bootk10f.out boot
	/amd64/bin/auth/factotum factotum
	/amd64/bin/ip/ipconfig ipconfig
#	../root/nvram nvram	# 削除</pre>
			<p>最後にコンパイルして終わり。</p>
			<pre>% cd /sys/src/9k/k10
% chmod +x ../mk/mkrootall
% mk 'CONF=k10cpu'
% 9fat:
% cp 9k10cpu /n/9fat
% mk 'CONF=k10cpu' nuke</pre>
		</section>
	</section>
</article>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="mailto:webmaster@lufia.org">webmaster@lufia.org</a>まで連絡ください。</p>
</footer>
</body>
</html>
