<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script>
document.createElement('article')
document.createElement('aside')
document.createElement('footer')
document.createElement('header')
document.createElement('nav')
document.createElement('section')
</script>
<style>
article, aside, footer, header, nav, section { display: block }
</style>
<title>Plan 9: カーネルにilを組み込む</title>
<script src="/lib/jquery.js"></script>
<script src="/lib/decor.js"></script>
<script src="/plan9/lib/complex.js"></script>
<link rel="stylesheet" type="text/css" href="/plan9/lib/u.css">
<meta name="author" content="http://www.hatena.ne.jp/lufiabb/">
</head>
<body>
<header>
		<h1><a href="/plan9/">Plan 9</a></h1>
</header>
<nav>
	<section>
		<h1>メニュー</h1>
		<ul>
		<li><a href="/plan9/doc/inst/">インストール</a></li>
		<li><a href="/plan9/doc/guide/">システムの使い方</a></li>
		<li><a href="/plan9/doc/devel/">プログラミング</a></li>
		<li><a href="/plan9/doc/adm/">システム管理</a></li>
		<li><a href="/plan9/man/">自作ツール集</a></li>
		</ul>
	</section>
</nav>
<article>
	<section>
		<h1>カーネルにilを組み込む</h1>
		<p class="revision">2011年7月1日更新</p>
		<p>カーネルからilが外されてしまったので、dumpfsを利用する場合には、
		自分でilを組み込まなければ動きません。
		具体的には、まず、il.cを/sys/src/9/ip/il.cにコピーします。</p>
		<div class="note">
			<p><a href="../../src/il.c">IPv6対応のIL</a>を書いてみました。
			ざっと使い方を書くと、</p>
			<pre>aux/listen1 il!*!9001 /bin/exportfs -r $home</pre>
			<p>別のウィンドウで</p>
			<pre>9fs il!::1!9001 /n/remote</pre>
		</div>
		<pre>% 9fs sources
% cp /n/sources/extra/il.c /sys/src/9/ip/il.c</pre>
		<p>次に、/sys/src/9/ip/ip.hのLogtcp付近を以下のように変更します。</p>
		<pre>Logtcp=		1&lt;&lt;2,
Logfs=		1&lt;&lt;3,
Logil=		1&lt;&lt;4,	// 追加
Logicmp=	1&lt;&lt;5,
Logudp=		1&lt;&lt;6,
Logcompress=	1&lt;&lt;7,
Logilmsg=	1&lt;&lt;8,	// 追加
Loggre=		1&lt;&lt;9,</pre>
		<div class="note">
			<p>これに加えて、ip/netlog.cにも追加。無くても動きますが。</p>
			<pre>static Netlogflag flags[] =
{
	{ &quot;ppp&quot;,	Logppp, },
	{ &quot;ip&quot;,		Logip, },
	{ &quot;fs&quot;,		Logfs, },
	{ &quot;il&quot;,			Logil, },		// 追加
	{ &quot;tcp&quot;,	Logtcp, },
	{ &quot;icmp&quot;,	Logicmp, },
	{ &quot;udp&quot;,	Logudp, },
	{ &quot;compress&quot;,	Logcompress, },
	{ &quot;ilmsg&quot;,		Logil|Logilmsg, },	// 追加
	{ &quot;gre&quot;,	Loggre, },
	{ &quot;tcpwin&quot;,	Logtcp|Logtcpwin, },
	{ &quot;tcprxmt&quot;,	Logtcp|Logtcprxmt, },
	{ &quot;udpmsg&quot;,	Logudp|Logudpmsg, },
	{ &quot;ipmsg&quot;,	Logip|Logipmsg, },
	{ &quot;esp&quot;,	Logesp, },
	{ nil,		0, },
};</pre>
		</div>
		<p>2010年の途中まではここまでで動きましたが、
		2011年5月に確認してみると、いくつかコンパイルエラーが出ました。
		そこで、若干むりやりですが、boot以下のboot.hとbootip.cに追加します。</p>
		<section>
			<h3>boot/boot.h</h3>
			<pre>extern void	configil(Method*);
extern int	connectil(void);</pre>
		</section>
		<section>
			<h3>boot/bootip.c</h3>
			<pre>void
configil(Method*)
{
	configip(bargc, bargv, 1);
	setauthaddr(&quot;il&quot;, 566);
}

int
connectil(void)
{
	int fd;
	char buf[64];

	snprint(buf, sizeof buf, &quot;il!%I!17008&quot;, fsip);
	fd = dial(buf, 0, 0, 0);
	if(fd &lt; 0)
		werrstr(&quot;dial %s: %r&quot;, buf);
	return fd;
}</pre>
		</section>
		<p>最後に、confファイルに、ilのエントリが必要になります。
		いま使っているpcauthの場合はこんな感じ。</p>
		<pre>dev
	root
	cons
	arch
	pnp		pci
	env
	pipe
	proc
	mnt
	srv
	dup
	rtc
	ssl
	tls
	cap
	kprof
	fs

	ether		netif
	ip		arp chandial ip ipv6 ipaux iproute netlog nullmedium pktmedium ptclbsum386 inferno

	draw		screen vga vgax
	mouse		mouse
	vga

	sd
	floppy		dma

	uart

link
	apm		apmjump
	ether8139	pci
	ether8169	pci ethermii
	ethermedium
	netdevmedium
	loopbackmedium

misc
	realmode
	archmp		mp apic
	mtrr
	sdata		pci sdscsi

	uarti8250
	uartpci

	vgamach64xx	+cur
	vgas3 		+cur vgasavage

ip
	il
	tcp
	udp
	ipifc
	icmp
	icmp6
	gre
	ipmux
	esp

port
	int cpuserver = 1;

boot cpu boot #S/sdC0/
	tcp
	il
	local

bootdir
	bootpcauth.out boot
	/386/bin/ip/ipconfig
	/386/bin/auth/factotum
	/386/bin/fossil/fossil
	/386/bin/venti/venti
#	/386/bin/disk/kfs</pre>
		<p>以前とくらべて、</p>
		<pre>misc
	arch		mp apic
	mtrr</pre>
		<p>これらがなければリンク時にエラーがでますね。</p>
	</section>
</article>
<aside>
	<section>
		<h1>関連情報</h1>
		<ul>
		<li><a href="fs.html">ファイルサーバのインストール</a></li>
		<li><a href="../guide/il.html">ILプロトコル</a></li>
		<li><a href="../../../notes/2011/0618.html">il.cを読む</a></li>
		</ul>
	</section>
	<section>
		<h1>参考ページ</h1>
		<ul>
		<li><a href="http://9fans.net/archive/2007/10/34">9fans: Kernel and IL</a></li>
		<li><a href="http://9fans.net/archive/2007/10/35">Re: 9fans: Kernel and IL</a></li>
		<li><a href="http://www.slideshare.net/oraccha/il-4020522">IL: 失われたプロトコル</a></li>
		</ul>
	</section>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="mailto:webmaster@lufia.org">webmaster@lufia.org</a>まで連絡ください。</p>
</footer>
</body>
</html>
