<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script>
document.createElement('article')
document.createElement('aside')
document.createElement('footer')
document.createElement('header')
document.createElement('nav')
document.createElement('section')
</script>
<style>
article, aside, footer, header, nav, section { display: block }
</style>
<title>Plan 9: メール環境の暗号化</title>
<script src="/lib/jquery.js"></script>
<script src="/lib/decor.js"></script>
<script src="/plan9/lib/complex.js"></script>
<link rel="stylesheet" type="text/css" href="/plan9/lib/u.css">
<meta name="author" content="http://www.hatena.ne.jp/lufiabb/">
</head>
<body>
<header>
		<h1><a href="/plan9/">Plan 9</a></h1>
</header>
<nav>
	<section>
		<h1>メニュー</h1>
		<ul>
		<li><a href="/plan9/doc/inst/">インストール</a></li>
		<li><a href="/plan9/doc/guide/">システムの使い方</a></li>
		<li><a href="/plan9/doc/devel/">プログラミング</a></li>
		<li><a href="/plan9/doc/adm/">システム管理</a></li>
		<li><a href="/plan9/man/">自作ツール集</a></li>
		</ul>
	</section>
</nav>
<article>
	<section>
		<h1>メール環境の暗号化</h1>
		<p class="revision">2009年10月20日更新</p>
		<section>
			<h2>サーバ証明書の作成</h2>
			<p>秘密鍵をsecstoreに、公開鍵を/sys/lib/tls/cert.pemに作成します。
			auth/rsa2x509の引数は自分の環境にあわせて書き換えます。</p>
			<pre># ramfs
# cd /tmp
# auth/rsagen -t 'service=tls owner=*' &gt;key
# auth/rsa2x509 'C=JP ST=Kanagawa L=Sagamihara O=lufia.org OU=9 CN=lufia' key | auth/pemencode CERTIFICATE &gt;cert</pre>
			<p>証明書を自動的にfactotumへ取り込めるように、bootesのsecstoreを作成。
			secstoreへの登録方法は<a href="../guide/secstore.html">secstoreの使い方</a>を。
			bootesのsecstoreへ1つ以上キーが登録されているなら、
			それと今回作成したキーを結合しないといけませんが、省略しています。</p>
			<pre># auth/secuser -v bootes
(password)
(confirm)
# cat key &gt;&gt;factotum
# auth/secstore -p factotum
# rm key factotum</pre>
			<p>bootesは自分でロードしない限りsecstoreを読みにいかないので、
			明示的にsecstoreを読み込むようcpurcを編集。
			具体的には、auth/secstoredの下にauth/secstoreを追加。</p>
			<pre># cat /cfg/$sysname/cpurc
...
auth/secstored
auth/secstore -n -G factotum | read -m &gt;/mnt/factotum/ctl
...</pre>
			<p>また、<a href="authinst.html">初回起動時</a>にsecstoreのパスワードを
			設定していない場合は、auth/wrkeyを使って再設定してください。</p>
		</section>
		<section>
			<h2>証明書の配置</h2>
			<p>IMAP4, SMTPで使うため、適当な場所に証明書を移動します。
			cert.pemの権限は444のほうが安全ですが、管理的にめんどくさいので664。</p>
			<p>ユーザ、グループをsysにするために、あらかじめファイルサーバから
			cert.pemを作っておきます。</p>
			<pre>fs: create /sys/lib/tls/cert.pem sys sys 664
fs: newuser sys +bootes</pre>
			<pre># cat cert &gt;/sys/lib/tls/cert.pem
# rm cert
# unmount /tmp</pre>
			<pre>fs: newuser sys -bootes</pre>
		</section>
		<section>
			<h2>IMAP4 over SSL/TLS</h2>
			<p>上記で作成した証明書を使って、IMAP4の通信を暗号化します。
			IMAPSのポートはtcpの993です。
			以下ではserviceを/cfgへ移行した状態で書いています。
			詳細は<a href="authinst.html">認証サーバの構築</a>のサービスの隔離を参照。</p>
			<pre>fs: create /cfg/$sysname/service/tcp993 sys sys 775
fs: newuser sys +bootes</pre>
			<p class="note">fsカーネルでは$sysnameをそのまま使うことはできないので、
			実際のホスト名に置き換えてください。</p>
			<pre># cd /cfg/$sysname/service
# cat &gt;&gt;tcp993
#!/bin/rc

exec tlssrv -c/sys/lib/tls/cert.pem -limap4d -r`{cat $3/remote} /bin/ip/imap4d -r`{cat $3/remote}&gt;[2]/sys/log/imap4d
^D</pre>
			<p>それから、無くても動いてるようにみえるけど、これも。
			なんだろうこれ。ルータが動いているなら、ポートの開放も忘れずに。
			プロンプトが%の行は、一般ユーザで実行しても問題ありません。</p>
			<pre>% upas/fs -f /imaps/wisp		# imapsを設定するサーバへ接続
upas/fs: opening /imaps/wisp: wisp/imaps:server certificate xxxxxxxxxxxxxxxxxxxxxxxxxxxxx not</pre>
			<p>xxxxxxxxxが取得できたら、それをそのまま次に使います。</p>
			<pre># echo 'x509 sha1=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx' &gt;/sys/lib/tls/mail</pre>
			<pre>fs: newuser sys -bootes</pre>
			<p>動作確認が終われば、いらなくなったIMAP4サービスを削除します。
			そのまま残していても困らないだろうとは思いますが、
			有名なメールクライアントはIMAP4Sに対応しているので、
			わざわざ残しておくことはないだろうという気がします。</p>
			<pre>fs: remove /cfg/wisp/service/tcp143</pre>
		</section>
		<section>
			<h2>SMTP over SSL/TLS</h2>
			<p>SMTPの場合、暗号化の方法は2種類あります。</p>
			<dl>
			<dt>ssmtp</dt>
			<dd>TCPポート465</dd>
			<dd>通信開始から暗号化されている</dd>
			<dt>smtp+STARTTLS</dt>
			<dd>TCPポート25</dd>
			<dd>STARTTLSコマンドによって暗号通信が開始される</dd>
			</dl>
			<p>設定は、ssmtpはtlssrvによりupas/smtpdプロセスを開始します。
			STARTTLS版は、upas/smtpdコマンドに-cオプションを使って証明書を与えます。
			後者は暗号化通信が可能というだけで、
			クライアントからSTARTTLSコマンドが発行されない限り暗号化されません。</p>
			<p>今回はtcp587に-cオプションから証明書を与えました。</p>
			<pre># cat /cfg/wisp/service/tcp587
#!/bin/rc
#smtp serv net incalldir user

user=`{cat /dev/user}
exec upas/smtpd -ac/sys/lib/tls/cert.pem -g -n $3</pre>
			<p>これにより、暗号化通信が開始されると
			/sys/log/smtpdにログが記録されるようになります。</p>
			<pre>started TLS with [...]</pre>
			<p>ついでなので、tcp25にも-c certを追加して終了。
			あまり意味は無いかもしれません。
			しかしfactotum+secstoreってすごいなあ。
			秘密鍵がファイルシステムから隠れてしまった。</p>
		</section>
		<section>
			<h2>トラブルシューティング</h2>
			<section>
				<h3>tls reports failed</h3>
				<p>bootesの鍵が読み込めていない場合、/sys/log/imap4dに
				ログが記録されます。</p>
				<pre>tls reports failed: tls: local factotum_rsa_open: no key matches proto=rsa service=tls role=client</pre>
				<p>auth/secstore -G factotumをcpurcに加えてください。</p>
			</section>
		</section>
	</section>
</article>
<aside>
	<section>
		<h1>関連情報</h1>
		<ul>
		<li><a href="smtpd.html">メールサーバの設定</a></li>
		<li><a href="iphone.html">iPhoneまとめ</a></li>
		</ul>
	</section>
	<section>
		<h1>参考ページ</h1>
		<ul>
		<li><a href="http://www.plan9.bell-labs.com/wiki/plan9/Mail_configuration/index.html">Mail configuration</a></li>
		<li><a href="http://plan9.aichi-u.ac.jp/pegasus/man-2.1/cert.html">証明書</a></li>
		</ul>
	</section>
	<section>
		<h1>参考書</h1>
		<dl>
		<dt><a href="http://www.hyuki.com/cr/">新版暗号技術入門--秘密の国のアリス</a></dt>
		<dd>暗号全般についての入門書です。<a href="http://www.hyuki.com/cr/cr1st.html">旧版</a>を読みました。</dd>
		</dl>
	</section>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="mailto:webmaster@lufia.org">webmaster@lufia.org</a>まで連絡ください。</p>
</footer>
</body>
</html>
