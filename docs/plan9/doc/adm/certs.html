<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script>
document.createElement('article')
document.createElement('aside')
document.createElement('footer')
document.createElement('header')
document.createElement('nav')
document.createElement('section')
</script>
<style>
article, aside, footer, header, nav, section { display: block }
</style>
<title>Plan 9: 正当な証明書を扱う</title>
<script src="/lib/jquery.js"></script>
<script src="/lib/decor.js"></script>
<script src="/plan9/lib/complex.js"></script>
<link rel="stylesheet" type="text/css" href="/plan9/lib/u.css">
<meta name="author" content="http://www.hatena.ne.jp/lufiabb/">
</head>
<body>
<header>
		<h1><a href="/plan9/">Plan 9</a></h1>
</header>
<nav>
	<section>
		<h1>メニュー</h1>
		<ul>
		<li><a href="/plan9/doc/inst/">インストール</a></li>
		<li><a href="/plan9/doc/guide/">システムの使い方</a></li>
		<li><a href="/plan9/doc/devel/">プログラミング</a></li>
		<li><a href="/plan9/doc/adm/">システム管理</a></li>
		<li><a href="/plan9/man/">自作ツール集</a></li>
		</ul>
	</section>
</nav>
<article>
	<section>
		<h1>正当な証明書を扱う</h1>
		<p class="revision">2014年5月2日更新</p>
		<section>
			<h2>前置き</h2>
			<p>正当と書いていいのか悩ましいですが、
			いわゆる自己署名でない証明書のことです。
			認証局に署名リクエストを出すとき、CSRが必要になりますが、
			Plan 9には、CSRを作るためのコマンドが無さそうです。
			auth/rsa2x509コマンドでは自己署名になってしまうので使えません。
			Plan 9の秘密鍵をUnixで理解できる形に変換して、
			Unix(openssl)でCSRを作る方法も調べましたが、
			全く情報がありませんでした。</p>
			<p>最終的に、Unixで作った鍵をPlan 9で読み込む方法を採用しました。</p>
		</section>
		<section>
			<h2>鍵の作成</h2>
			<p>Unixで作業をします。
			パスフレーズ付きの鍵では、どうやらPlan 9は読めない様子。
			なので、安易だけれどパスフレーズを解除した状態で渡します。</p>
			<pre>unix$ openssl genrsa -aes128 2048 &gt;private.key
unix$ openssl genrsa -aes256 4096 &gt;private.key
Enter pass phrase:
Verifying - Enter pass phrase:
unix$ openssl rsa -in private.key -out u.key</pre>
			<p>安全な方法で鍵をPlan 9側へコピーします。
			ここではdrawtermを使いましたが実際なんでもいいです。</p>
			<pre>unix$ drawterm -a a.lufia.org -c c.lufia.org -u bootes
# ramfs -p
# cp /mnt/term/Users/lufia/u.key /tmp/u.key</pre>
			<p>drawtermを使ってbootesユーザでauth/secstoreすると、
			drawterm側ではなくcpuサーバのコンソール側(!)で
			パスワードを待ち受けるようになって困るので、
			以下はコンソールから作業します。</p>
			<pre># cd /tmp
# auth/pemdecode ‘RSA PRIVATE KEY’ u.key |
&gt; auth/asn12rsa -t ‘service=tls role=client owner=*’ &gt;key
# auth/secstore -g factotum
# cat key &gt;&gt;factotum
# auth/secstore -p factotum
# rm factotum key u.key</pre>
			<p>マニュアルによると、asn12rsaした後の出力にある、!p=と!q=の値が
			素数ペアになっているようですね。</p>
			<p>これで、Unixのパスフレーズ無し鍵はいらなくなったので消しましょう。</p>
			<pre>unix$ rm u.key</pre>
			<p>パスフレーズ有り版の鍵は証明書作成(更新も？)で使うので、
			大切に保管しておきましょう。</p>
		</section>
		<section>
			<h2>CSR作成と申請</h2>
			<p>Plan 9上に秘密鍵と公開鍵が残せたので、あとはUnixでCSRを作成します。</p>
			<pre>unix$ openssl req -new -key private.key &gt;a.csr
Enter pass phrase for key:</pre>
			<p>この後、いくつか質問されますが、大切なところは、
			Common Nameを証明書申請するドメイン名にすること。
			他の項目は認証局のサイトにある説明をよく読んで入力しましょう。
			たとえばRapidSSLは、拡張情報・チェレンジパスワードを入力してはいけません。</p>
			<p>CSRを作り終わったら認証局へ申請します。
			RapidSSLの場合は、フォームにa.csrの内容をコピペして、
			サーバの種類を選ぶ場所で「その他」を選んでおくといいでしょう。</p>
			<p>その後「SSLサーバ証明書発行完了のお知らせ」というメールが届いたら、
			メール本文の中ほどにある「SSLサーバ証明書(X.509形式)」の
			BEGIN CERTIFICATEからEND CERTIFICATEまで(含む)をPlan 9へ送ります。
			秘密鍵と異なり、公開情報なので送る方法はなんでもかまいません。
			ファイル末尾に改行がない場合、Plan 9は読んでくれないので
			改行までをコピーするように注意してください。</p>
			<p>最後に、所定の場所へ配置して終わり。</p>
			<pre>prompt: fsys main create /active/sys/lib/tls/cert.pem sys sys 664
# cp cert /sys/lib/tls/cert.pem</pre>
		</section>
	</section>
</article>
<aside>
	<section>
		<h1>参考ページ</h1>
		<ul>
		<li><a href="http://bearmini.hatenablog.com/entry/2014/02/05/143510">RSA 秘密鍵/公開鍵ファイルのフォーマット</a></li>
		<li><a href="lego.html">legoを使った証明書更新</a></li>
		</ul>
	</section>
</aside>
<footer>
	<p>見れない、表示がおかしい場合は、動作環境を添えて<a href="mailto:webmaster@lufia.org">webmaster@lufia.org</a>まで連絡ください。</p>
</footer>
</body>
</html>
